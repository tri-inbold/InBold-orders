<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Inbold Menu</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;600;700&display=swap');
        
        :root {
            --primary: #667eea;
            --primary-dark: #5a67d8;
            --primary-light: #7c8aed;
            --secondary: #4299e1;
            --accent: #ed64a6;
            --success: #48bb78;
            --warning: #ed8936;
            --error: #f56565;
            --dark-bg: #0f172a;
            --card-bg: #1e293b;
            --card-hover: #334155;
            --border: #334155;
            --text: #f1f5f9;
            --text-muted: #94a3b8;
            --gradient-1: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            --shadow-sm: 0 1px 3px rgba(0, 0, 0, 0.1);
            --shadow-md: 0 2px 8px rgba(0, 0, 0, 0.15);
            --shadow-lg: 0 4px 16px rgba(0, 0, 0, 0.2);
            --radius-sm: 8px;
            --radius-md: 12px;
            --radius-lg: 16px;
        }
        
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }
        
        body {
            font-family: 'Roboto', 'Arial', -apple-system, BlinkMacSystemFont, sans-serif;
            background: var(--dark-bg);
            color: var(--text);
            line-height: 1.5;
            font-size: 14px;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }
        
        #app {
            max-width: 900px;
            margin: 0 auto;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            padding-bottom: 100px;
        }
        
        @media (min-width: 769px) {
            #app {
                padding: 1.5rem;
                padding-top: 90px;
            }
            body { font-size: 13px; }
        }
        
        main {
            flex-grow: 1;
            padding: 1.5rem 1rem 0;
        }
        
        @media (min-width: 769px) {
            main { padding: 1.5rem 1.5rem 0; }
        }
        
        .card {
            background: var(--card-bg);
            border-radius: var(--radius-md);
            padding: 1.25rem;
            margin-bottom: 1rem;
            border: 1px solid var(--border);
            box-shadow: var(--shadow-sm);
        }
        
        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }
        
        .card-title {
            font-size: 18px;
            font-weight: 600;
            color: var(--text);
        }
        
        @media (min-width: 769px) {
            .card-title { font-size: 20px; }
        }
        
        .hero-card {
            background: var(--gradient-1);
            position: relative;
            overflow: hidden;
            min-height: 160px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            text-align: center;
        }
        
        @media (min-width: 769px) {
            .hero-card { min-height: 180px; }
        }
        
        .hero-card::before {
            content: '';
            position: absolute;
            top: -50%; right: -50%;
            width: 200%; height: 200%;
            background: radial-gradient(circle, rgba(255,255,255,0.08) 0%, transparent 70%);
            animation: pulse 4s ease-in-out infinite;
        }
        
        @keyframes pulse {
            0%, 100% { transform: scale(1); opacity: 0.5; }
            50% { transform: scale(1.05); opacity: 0.7; }
        }
        
        .hero-content { position: relative; z-index: 1; }
        .hero-greeting { font-size: 14px; margin-bottom: 6px; opacity: 0.95; }
        .hero-title { font-size: 32px; font-weight: 700; margin-bottom: 8px; text-shadow: 0 2px 10px rgba(0,0,0,0.2); }
        .hero-subtitle { font-size: 13px; opacity: 0.9; }
        
        @media (min-width: 769px) {
            .hero-greeting { font-size: 15px; }
            .hero-title { font-size: 36px; }
        }
        
        .tabs { display: flex; gap: 6px; margin-bottom: 1rem; overflow-x: auto; padding-bottom: 4px; }
        .tabs::-webkit-scrollbar { height: 3px; }
        .tabs::-webkit-scrollbar-track { background: var(--card-bg); }
        .tabs::-webkit-scrollbar-thumb { background: var(--primary); border-radius: 2px; }
        
        .tab-btn {
            padding: 8px 16px;
            border-radius: var(--radius-sm);
            background: var(--card-bg);
            border: 1px solid var(--border);
            color: var(--text-muted);
            cursor: pointer;
            transition: all 0.2s ease;
            white-space: nowrap;
            font-weight: 500;
            font-size: 13px;
        }
        
        .tab-btn:hover { background: var(--card-hover); color: var(--text); }
        .tab-btn.active { background: var(--primary); border-color: var(--primary); color: white; }
        
        .order-day-card { background: var(--card-bg); border: 1px solid var(--border); border-radius: var(--radius-sm); padding: 1rem; margin-bottom: 0.75rem; }
        .order-day-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.75rem; }
        .order-day-title { font-size: 16px; font-weight: 600; color: var(--primary); }
        .order-dish-list { display: grid; gap: 0.5rem; }
        
        .order-dish-item {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 0.75rem;
            background: rgba(102, 126, 234, 0.05);
            border-radius: var(--radius-sm);
            border: 1px solid transparent;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        
        .order-dish-item:hover { border-color: var(--primary); background: rgba(102, 126, 234, 0.08); }
        .order-dish-item.selected { border-color: var(--primary); background: rgba(102, 126, 234, 0.12); }
        .order-dish-name { flex: 1; font-size: 14px; font-weight: 500; }
        
        .staff-list { list-style: none; }
        .staff-item { display: flex; align-items: center; padding: 0.75rem; background: rgba(30, 41, 59, 0.5); border-radius: var(--radius-sm); margin-bottom: 6px; border: 1px solid transparent; transition: all 0.2s ease; }
        .staff-item:hover { background: var(--card-hover); border-color: var(--border); }
        .staff-item.eaten { opacity: 0.5; }
        .staff-details { flex: 1; }
        .staff-name { font-weight: 500; font-size: 14px; margin-bottom: 2px; }
        .staff-dish, .staff-email { font-size: 12px; color: var(--text-muted); }
        
        .profile-section { text-align: center; padding: 2rem 1rem; }
        .profile-avatar { width: 80px; height: 80px; border-radius: 50%; border: 3px solid var(--primary); margin: 0 auto 1rem; object-fit: cover; }
        .profile-name { font-size: 20px; font-weight: 600; margin-bottom: 0.25rem; }
        .profile-depart { font-size: 14px; color: var(--text-muted); margin-bottom: 2rem; }
        .profile-language-toggle { display: flex; gap: 0.5rem; justify-content: center; margin-bottom: 1.5rem; }
        
        .profile-language-toggle button {
            padding: 0.5rem 1.5rem;
            border-radius: var(--radius-sm);
            border: 1px solid var(--border);
            background: var(--card-bg);
            color: var(--text-muted);
            cursor: pointer;
            transition: all 0.2s ease;
            font-weight: 500;
            font-size: 13px;
        }
        
        .profile-language-toggle button.active { background: var(--primary); border-color: var(--primary); color: white; }
        
        .profile-menu { display: flex; flex-direction: column; gap: 0.5rem; max-width: 400px; margin: 0 auto; }
        .profile-menu-item { display: flex; align-items: center; gap: 1rem; padding: 1rem; background: var(--card-bg); border: 1px solid var(--border); border-radius: var(--radius-sm); cursor: pointer; transition: all 0.2s ease; }
        .profile-menu-item:hover { background: var(--card-hover); border-color: var(--primary); }
        .profile-menu-icon { width: 40px; height: 40px; border-radius: 10px; display: flex; align-items: center; justify-content: center; font-size: 18px; color: white; }
        .profile-menu-icon.green { background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%); }
        .profile-menu-icon.red { background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); }
        .profile-menu-text { flex: 1; text-align: left; }
        .profile-menu-label { font-size: 14px; font-weight: 500; }
        
        .btn { padding: 10px 20px; border-radius: var(--radius-sm); border: none; font-weight: 500; font-size: 13px; cursor: pointer; transition: all 0.2s ease; display: inline-flex; align-items: center; justify-content: center; gap: 6px; }
        .btn-primary { background: var(--gradient-1); color: white; box-shadow: 0 2px 8px rgba(102, 126, 234, 0.3); }
        .btn-primary:hover { transform: translateY(-1px); box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4); }
        .btn-secondary { background: var(--card-bg); color: var(--text); border: 1px solid var(--border); }
        .btn-secondary:hover { background: var(--card-hover); }
        .btn-danger { background: var(--error); color: white; }
        .btn:disabled { opacity: 0.5; cursor: not-allowed; }
        .btn-block { width: 100%; }
        
        .icon-btn { width: 36px; height: 36px; border-radius: var(--radius-sm); background: var(--card-bg); border: 1px solid var(--border); color: var(--text); display: flex; align-items: center; justify-content: center; cursor: pointer; transition: all 0.2s ease; font-size: 16px; }
        .icon-btn:hover { background: var(--card-hover); transform: translateY(-1px); }
        .icon-btn.active { background: var(--primary); border-color: var(--primary); }
        
        .form-group { margin-bottom: 1rem; }
        .form-label { display: block; margin-bottom: 6px; font-weight: 500; font-size: 13px; color: var(--text); }
        .form-input, .form-select, .form-textarea { width: 100%; padding: 10px 12px; background: rgba(15, 23, 42, 0.5); border: 1px solid var(--border); border-radius: var(--radius-sm); color: var(--text); font-size: 13px; transition: all 0.2s ease; font-family: 'Roboto', 'Arial', sans-serif; }
        .form-input:focus, .form-select:focus, .form-textarea:focus { outline: none; border-color: var(--primary); box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1); }
        .form-textarea { resize: none; overflow: hidden; min-height: 38px; }
        
        .search-bar { display: flex; gap: 8px; margin-bottom: 1rem; }
        .search-wrapper { position: relative; flex: 1; }
        .search-input { flex: 1; padding: 10px 12px 10px 38px; background: rgba(15, 23, 42, 0.5); border: 1px solid var(--border); border-radius: var(--radius-sm); color: var(--text); font-size: 13px; }
        .search-icon { position: absolute; left: 12px; top: 50%; transform: translateY(-50%); color: var(--text-muted); font-size: 14px; }
        
        .modal { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0, 0, 0, 0.75); backdrop-filter: blur(4px); display: flex; align-items: center; justify-content: center; z-index: 1000; padding: 1rem; }
        .modal-content { background: var(--card-bg); border-radius: var(--radius-lg); padding: 1.5rem; width: 100%; max-width: 450px; max-height: 90vh; overflow-y: auto; border: 1px solid var(--border); box-shadow: var(--shadow-lg); animation: modalSlideIn 0.2s ease; }
        @keyframes modalSlideIn { from { opacity: 0; transform: translateY(-10px); } to { opacity: 1; transform: translateY(0); } }
        .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem; }
        .modal-title { font-size: 18px; font-weight: 600; }
        .close-btn { width: 32px; height: 32px; border-radius: 6px; background: transparent; border: none; color: var(--text-muted); cursor: pointer; display: flex; align-items: center; justify-content: center; transition: all 0.2s ease; }
        .close-btn:hover { background: var(--card-hover); color: var(--text); }
        
        #tab-bar { position: fixed; bottom: 0.75rem; left: 50%; transform: translateX(-50%); background: rgba(30, 41, 59, 0.98); backdrop-filter: blur(10px); border: 1px solid var(--border); border-radius: 20px; padding: 6px; display: flex; gap: 4px; box-shadow: var(--shadow-lg); z-index: 100; width: calc(100% - 1.5rem); max-width: 400px; }
        @media (min-width: 769px) { #tab-bar { top: 1rem; bottom: auto; border-radius: 24px; padding: 8px; max-width: 500px; } }
        .nav-item { flex: 1; padding: 12px; border-radius: 14px; background: transparent; border: none; color: var(--text-muted); cursor: pointer; transition: all 0.2s ease; display: flex; flex-direction: column; align-items: center; justify-content: center; position: relative; }
        .nav-item i { font-size: 20px; width: 24px; height: 24px; display: flex; align-items: center; justify-content: center; }
        .nav-item:hover { color: var(--text); }
        .nav-item.active { background: var(--primary); color: white; }
        .nav-item.needs-attention::after { content: ''; position: absolute; top: 8px; right: 20px; width: 6px; height: 6px; background: var(--error); border-radius: 50%; animation: pulse-dot 1.5s infinite; }
        @media (min-width: 769px) { .nav-item.needs-attention::after { right: 24px; } }
        @keyframes pulse-dot { 0%, 100% { box-shadow: 0 0 0 0 rgba(245, 101, 101, 0.7); } 50% { box-shadow: 0 0 0 5px rgba(245, 101, 101, 0); } }
        
        #toast-notification { position: fixed; bottom: 100px; left: 50%; transform: translateX(-50%) translateY(150px); background: var(--card-bg); color: var(--text); padding: 12px 20px; border-radius: var(--radius-md); box-shadow: var(--shadow-lg); border: 1px solid var(--border); z-index: 1001; transition: transform 0.3s cubic-bezier(0.68, -0.55, 0.265, 1.55); max-width: 90%; display: flex; align-items: center; gap: 10px; font-size: 13px; }
        #toast-notification.show { transform: translateX(-50%) translateY(0); }
        #toast-notification.success { border-color: var(--success); }
        #toast-notification.error { border-color: var(--error); }
        .toast-icon { width: 20px; height: 20px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 11px; }
        .toast-icon.success { background: var(--success); }
        .toast-icon.error { background: var(--error); }
        
        #loader { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(15, 23, 42, 0.9); backdrop-filter: blur(4px); display: flex; align-items: center; justify-content: center; z-index: 9999; }
        .spinner { width: 48px; height: 48px; border: 3px solid rgba(102, 126, 234, 0.2); border-top-color: var(--primary); border-radius: 50%; animation: spin 0.8s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }
        
        .table-wrapper { overflow-x: auto; border-radius: var(--radius-sm); border: 1px solid var(--border); }
        table { width: 100%; border-collapse: collapse; }
        thead { background: rgba(102, 126, 234, 0.08); }
        th { padding: 10px 12px; text-align: left; font-weight: 600; color: var(--primary); font-size: 12px; text-transform: uppercase; letter-spacing: 0.5px; }
        td { padding: 10px 12px; border-top: 1px solid var(--border); font-size: 13px; }
        tr:hover { background: rgba(102, 126, 234, 0.04); }
        .action-buttons { display: flex; gap: 6px; }
        
        .shift-toggle { display: flex; gap: 6px; background: rgba(102, 126, 234, 0.08); padding: 4px; border-radius: var(--radius-sm); }
        .shift-toggle input[type="radio"] { display: none; }
        .shift-toggle label { flex: 1; padding: 8px 14px; text-align: center; border-radius: 6px; cursor: pointer; transition: all 0.2s ease; font-weight: 500; color: var(--text-muted); font-size: 13px; }
        .shift-toggle input[type="radio"]:checked + label { background: var(--primary); color: white; }
        
        .menu-item { display: flex; align-items: center; gap: 0.75rem; padding: 0.75rem; background: var(--card-bg); border: 1px solid var(--border); border-radius: var(--radius-sm); margin-bottom: 0.5rem; }
        .menu-item-text { flex: 1; font-size: 14px; }
        
        .hidden { display: none !important; }
        .text-center { text-align: center; }
        .text-muted { color: var(--text-muted); }
        .mt-2 { margin-top: 1rem; }
        .mt-3 { margin-top: 1.5rem; }
        .mb-3 { margin-bottom: 1.5rem; }
        .p-3 { padding: 1.5rem; }
        
        @media (max-width: 768px) {
            .hero-title { font-size: 28px; }
            .hide-mobile { display: none; }
        }
    </style>
</head>
<body>
    <div id="app">
        <main id="main-content"></main>
        
        <div id="personnel-modal" class="modal hidden"><div class="modal-content"><div class="modal-header"><h2 id="personnel-modal-title"></h2><button class="close-btn" data-modal="personnel-modal"><i class="fas fa-times"></i></button></div><input type="hidden" id="personnel-original-email-key"><div class="form-group"><label class="form-label" data-translate="name"></label><input type="text" id="personnel-name-input" class="form-input"></div><div class="form-group"><label class="form-label" data-translate="email"></label><input type="email" id="personnel-email-input" class="form-input"></div><div class="form-group"><label class="form-label" data-translate="department"></label><select id="personnel-depart-select" class="form-select"></select></div><button id="save-personnel-btn" class="btn btn-primary btn-block" data-translate="save"></button></div></div>
        <div id="guest-order-modal" class="modal hidden"><div class="modal-content"><div class="modal-header"><h2 class="modal-title" data-translate="guestOrderTitle"></h2><button class="close-btn" data-modal="guest-order-modal"><i class="fas fa-times"></i></button></div><div class="form-group"><label class="form-label" data-translate="guestName"></label><input type="text" id="guest-name-input" class="form-input" data-translate-placeholder="guestNamePlaceholder"></div><div class="form-group"><label class="form-label" data-translate="guestDepartment"></label><input type="text" id="guest-depart-input" class="form-input" data-translate-placeholder="guestDepartmentPlaceholder"></div><div class="form-group"><label class="form-label" data-translate="shift"></label><div class="shift-toggle"><input type="radio" id="guest-shift-m" name="guest-shift" value="M" checked><label for="guest-shift-m" data-translate="morningShift"></label><input type="radio" id="guest-shift-e" name="guest-shift" value="E"><label for="guest-shift-e" data-translate="afternoonShift"></label></div></div><div class="form-group"><label class="form-label" data-translate="week"></label><div class="shift-toggle"><input type="radio" id="guest-week-this" name="guest-week" value="this" checked><label for="guest-week-this" data-translate="thisWeek"></label><input type="radio" id="guest-week-next" name="guest-week" value="next"><label for="guest-week-next" data-translate="nextWeek"></label></div></div><div id="guest-order-days-container"></div><button id="save-guest-order-btn" class="btn btn-primary btn-block mt-3" data-translate="complete"></button></div></div>
        <div id="reopen-order-modal" class="modal hidden"><div class="modal-content"><div class="modal-header"><h2 id="reopen-order-modal-title" class="modal-title"></h2><button class="close-btn" data-modal="reopen-order-modal"><i class="fas fa-times"></i></button></div><p id="reopen-text" class="text-muted mb-3"></p><button id="confirm-reopen-order-btn" class="btn btn-danger btn-block" data-translate="confirmReopen"></button></div></div>
        <div id="delete-personnel-modal" class="modal hidden"><div class="modal-content"><div class="modal-header"><h2 class="modal-title" data-translate="deleteStaff"></h2><button class="close-btn" data-modal="delete-personnel-modal"><i class="fas fa-times"></i></button></div><p id="delete-personnel-text" class="text-muted mb-3"></p><div style="display: flex; gap: 12px;"><button class="btn btn-secondary" data-modal="delete-personnel-modal" style="flex: 1;" data-translate="cancel"></button><button id="confirm-delete-personnel-btn" class="btn btn-danger" style="flex: 1;" data-translate="delete"></button></div></div>

        <nav id="tab-bar" class="hidden"></nav>
        <div id="toast-notification"></div>
        <div id="loader" class="hidden"><div class="spinner"></div></div>
    </div>
    
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getFirestore, doc, getDoc, setDoc, updateDoc, deleteField } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
        import { getAuth, GoogleAuthProvider, signInWithPopup, signOut, onAuthStateChanged, browserLocalPersistence, setPersistence } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";

        const firebaseConfig = { apiKey: "AIzaSyCDrCaGUyr9xLkT-xOqzFd9grp6tN2u7Zo", authDomain: "hp-orders.firebaseapp.com", projectId: "hp-orders", storageBucket: "hp-orders.appspot.com", messagingSenderId: "616722831059", appId: "1:616722831059:web:9d19988d87397e7c13e626" };
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);
        const provider = new GoogleAuthProvider();
        
        const ADMIN_EMAILS = ['tri.vu.trong@inbold.com', 'truc.tran@inbold.com'];
        const SUPPORT_EMAIL = 'truc.tran@inbold.com';

        const state = {
            currentUser: null, staffProfile: null, isAdmin: false,
            currentTab: 'today', adminSubTab: 'support', authReady: false,
            orderSelection: {}, reopenTarget: { key: null, name: null }, deleteTarget: { key: null, name: null },
            cachedData: new Map(), statsViewMode: 'day', statsViewDate: new Date(), 
            guestOrderSelection: {}, tempMenuData: {}
        };

        const el = (id) => document.getElementById(id);
        
        const translations = {
            vi: {
                hello: "Chào", weekendGreeting: "Cuối tuần vui vẻ!", noMealService: "Hôm nay không phục vụ bữa ăn", yourMealToday: "Món ăn hôm nay của bạn", noOrderToday: "Chưa đặt món", noOrderTodaySubtitle: "Bạn chưa đặt món cho hôm nay",
                orderedForWeek: "Món đã đặt tuần", notOrdered: "Chưa đặt", offDay: "Nghỉ", orderForWeek: "Đặt món tuần",
                menuNotAvailable: "Thực đơn tuần {{week}} chưa có.", completeOrder: "Hoàn tất", optOut: "Không ăn",
                todayList: "Danh sách hôm nay", searchStaff: "Tìm nhân viên...", noData: "Chưa có dữ liệu.", noResults: "Không tìm thấy.", morningShift: "Ca sáng", afternoonShift: "Ca chiều",
                editProfile: "Sửa thông tin", addStaff: "Thêm nhân viên", name: "Tên", department: "Phòng ban", save: "Lưu",
                guestOrderTitle: "Đặt món cho khách", guestName: "Tên khách", guestNamePlaceholder: "Nhập tên", guestDepartment: "Phòng ban/Công ty", guestDepartmentPlaceholder: "Nhập tên công ty", shift: "Ca ăn", week: "Tuần", thisWeek: "Tuần này", nextWeek: "Tuần sau", complete: "Hoàn tất",
                reopenOrderFor: "Mở lại đặt món cho {{name}}?", reopenOrderNotice: "Thao tác này sẽ xóa mọi dữ liệu đặt món của người này trong tuần, cho phép họ đặt lại. Bạn có chắc chắn?", confirmReopen: "Xác nhận",
                deleteStaff: "Xóa nhân viên", deleteStaffConfirm: "Bạn có chắc muốn xóa nhân viên \"{{name}}\"? Hành động này không thể hoàn tác.", cancel: "Hủy", delete: "Xóa",
                support: "Hỗ trợ", stats: "Thống kê", menu: "Thực đơn", personnel: "Nhân sự", notYetOrdered: "Chưa đặt món", everyoneOrdered: "Mọi người đã đặt món.", orderForGuest: "Đặt cho khách", add: "Thêm",
                day: "Ngày", month: "Tháng", datePicker: "Chọn ngày", downloadXLSX: "Tải XLSX",
                thisWeekMenu: "Thực đơn tuần này", nextWeekMenu: "Thực đơn tuần sau", addDishesPlaceholder: "Món 1...\nMón 2...", saveMenu: "Lưu Thực Đơn", import: "Import", export: "Export", noDishes: "Chưa có món",
                staffManagement: "Quản lý nhân sự", email: "Email", actions: "Thao tác",
                vietnamese: "Tiếng Việt", english: "English", contactAdmin: "Liên hệ admin", logout: "Đăng xuất",
                welcome: "Chào mừng!", loginPrompt: "Vui lòng đăng nhập", login: "Đăng nhập",
                orderedSuccess: "Đặt món thành công!", orderedFail: "Đặt món thất bại", langChanged: "Đổi ngôn ngữ thành công", errorOccurred: "Có lỗi xảy ra", loggedOut: "Đã đăng xuất", dishRemoved: "Đã xóa món ăn", dishesAdded: "Đã thêm {{count}} món", menuSaved: "Đã lưu thực đơn", reopenedSuccess: "Đã mở lại đặt món",
                monday: "Thứ 2", tuesday: "Thứ 3", wednesday: "Thứ 4", thursday: "Thứ 5", friday: "Thứ 6", loginFail: "Đăng nhập thất bại", logoutConfirm: "Bạn có muốn đăng xuất?",
            },
            en: {
                hello: "Hello", weekendGreeting: "Happy Weekend!", noMealService: "No meal service today", yourMealToday: "Your meal for today is", noOrderToday: "No Order", noOrderTodaySubtitle: "You haven't ordered for today",
                orderedForWeek: "Ordered for week", notOrdered: "Not ordered", offDay: "Day off", orderForWeek: "Order for week",
                menuNotAvailable: "Menu for week {{week}} is not available yet.", completeOrder: "Complete Order", optOut: "Not eating",
                todayList: "Today's List", searchStaff: "Search staff...", noData: "No data available.", noResults: "No results found.", morningShift: "Morning Shift", afternoonShift: "Afternoon Shift",
                editProfile: "Edit Profile", addStaff: "Add Staff", name: "Name", department: "Department", save: "Save",
                guestOrderTitle: "Guest Order", guestName: "Guest Name", guestNamePlaceholder: "Enter name", guestDepartment: "Department/Company", guestDepartmentPlaceholder: "Enter company name", shift: "Shift", week: "Week", thisWeek: "This week", nextWeek: "Next week", complete: "Complete",
                reopenOrderFor: "Reopen order for {{name}}?", reopenOrderNotice: "This will delete this person's order data for the week, allowing them to order again. Are you sure?", confirmReopen: "Confirm",
                deleteStaff: "Delete Staff", deleteStaffConfirm: "Are you sure you want to delete \"{{name}}\"? This action cannot be undone.", cancel: "Cancel", delete: "Delete",
                support: "Support", stats: "Statistics", menu: "Menu", personnel: "Personnel", notYetOrdered: "Not yet ordered", everyoneOrdered: "Everyone has ordered.", orderForGuest: "Order for Guest", add: "Add",
                day: "Day", month: "Month", datePicker: "Select date", downloadXLSX: "Download XLSX",
                thisWeekMenu: "This Week's Menu", nextWeekMenu: "Next Week's Menu", addDishesPlaceholder: "Dish 1...\nDish 2...", saveMenu: "Save Menu", import: "Import", export: "Export", noDishes: "No dishes yet",
                staffManagement: "Staff Management", email: "Email", actions: "Actions",
                vietnamese: "Vietnamese", english: "English", contactAdmin: "Contact Admin", logout: "Logout",
                welcome: "Welcome!", loginPrompt: "Please log in", login: "Login",
                orderedSuccess: "Order successful!", orderedFail: "Order failed", langChanged: "Language changed successfully", errorOccurred: "An error occurred", loggedOut: "Logged out", dishRemoved: "Dish removed", dishesAdded: "{{count}} dishes added", menuSaved: "Menu saved", reopenedSuccess: "Order reopened successfully",
                monday: "Monday", tuesday: "Tuesday", wednesday: "Wednesday", thursday: "Thursday", friday: "Friday", loginFail: "Login failed", logoutConfirm: "Are you sure you want to logout?",
            }
        };
        const t = (key, params = {}) => {
            const lang = state.staffProfile?.lan || 'vi';
            let str = translations[lang][key] || key;
            for (const p in params) str = str.replace(`{{${p}}}`, params[p]);
            return str;
        };
        const applyTranslations = () => {
            document.querySelectorAll('[data-translate]').forEach(el => { el.textContent = t(el.dataset.translate); });
            document.querySelectorAll('[data-translate-placeholder]').forEach(el => { el.placeholder = t(el.dataset.translatePlaceholder); });
        };

        const getWeekString = (date) => {
            const d = new Date(date);
            d.setHours(0, 0, 0, 0);
            d.setDate(d.getDate() + 4 - (d.getDay() || 7));
            const yearStart = new Date(d.getFullYear(), 0, 1);
            const weekNo = Math.ceil((((d - yearStart) / 86400000) + 1) / 7);
            return `${d.getFullYear()}_${weekNo}`;
        };
        const getDayKey = (date = new Date()) => ['sun', 'mon', 'tue', 'wed', 'thu', 'fri', 'sat'][date.getDay()];
        const showLoader = () => el('loader').classList.remove('hidden');
        const hideLoader = () => el('loader').classList.add('hidden');
        const emailToKey = (email) => email.replace(/[.@]/g, '_');
        const parseDish = (dishString) => {
            if (!dishString) return '';
            if (dishString === 'OPT_OUT') return t('optOut');
            const parts = dishString.split('|');
            const lang = state.staffProfile?.lan || 'vi';
            return (lang === 'en' && parts.length > 1) ? parts[1].trim() : parts[0].trim();
        };
        const getFirstName = (fullName) => {
            if (!fullName) return '';
            const parts = fullName.trim().split(' ');
            return (state.staffProfile?.lan || 'vi') === 'vi' ? parts[parts.length - 1] : parts[0];
        };
        const showToast = (message, type = 'success') => {
            const toast = el('toast-notification');
            const iconMap = { success: 'check', error: 'times', info: 'info' };
            toast.innerHTML = `<div class="toast-icon ${type}"><i class="fas fa-${iconMap[type]}"></i></div><span>${message}</span>`;
            toast.className = `show ${type}`;
            setTimeout(() => toast.classList.remove('show'), 3000);
        };
        async function getDocument(collection, documentId, forceRefresh = false) {
            const cacheKey = `${collection}/${documentId}`;
            if (!forceRefresh && state.cachedData.has(cacheKey)) return state.cachedData.get(cacheKey);
            const docRef = doc(db, collection, documentId);
            const docSnap = await getDoc(docRef);
            const data = docSnap.exists() ? docSnap.data() : null;
            state.cachedData.set(cacheKey, data);
            return data;
        }

        async function render() {
            if (!state.authReady || !state.staffProfile) { hideLoader(); return; }
            showLoader();
            try {
                switch (state.currentTab) {
                    case 'today': await renderToday(); break;
                    case 'menu': await renderMenu(); break;
                    case 'profile': await renderProfile(); break;
                    case 'admin': await renderAdmin(); break;
                }
                applyTranslations();
            } catch (error) {
                console.error('Render error:', error);
                el('main-content').innerHTML = `<div class="card text-center" style="color: var(--error);"><i class="fas fa-exclamation-circle"></i> ${t('errorOccurred')}</div>`;
            }
            hideLoader();
        }

        async function renderToday() {
            const dayKey = getDayKey();
            const firstName = getFirstName(state.staffProfile.name);
            let heroHtml = '';

            if (['sun', 'sat'].includes(dayKey)) {
                heroHtml = `<div class="card hero-card"><div class="hero-content"><div class="hero-greeting">${t('hello')} ${firstName}</div><div class="hero-title">${t('weekendGreeting')}</div></div></div>`;
            } else {
                const dayData = await getDocument(getWeekString(new Date()), dayKey, false);
                const userOrder = dayData?.[emailToKey(state.currentUser.email)];
                if (userOrder) {
                    heroHtml = `<div class="card hero-card"><div class="hero-content"><div class="hero-greeting">${t('hello')} ${firstName}</div><div class="hero-title">${parseDish(userOrder.food)}</div><div class="hero-subtitle">${t('yourMealToday')}</div></div></div>`;
                } else {
                    heroHtml = `<div class="card hero-card"><div class="hero-content"><div class="hero-greeting">${t('hello')} ${firstName}</div><div class="hero-title">${t('noOrderToday')}</div><div class="hero-subtitle">${t('noOrderTodaySubtitle')}</div></div></div>`;
                }
            }
            el('main-content').innerHTML = heroHtml + `<div id="order-section-container"></div>`;
            await renderOrderSection(el('order-section-container'));
        }

        async function renderOrderSection(container) {
            const today = new Date();
            const dayOfWeek = today.getDay();
            const userEmailKey = emailToKey(state.currentUser.email);
            
            const weekForOrdering = (dayOfWeek >= 4 || dayOfWeek === 0) ? getWeekString(new Date(today.getTime() + 7 * 86400000)) : getWeekString(today);
            const userOrdersForOrderingWeek = await getDocument(weekForOrdering, 'mon', false);

            if (userOrdersForOrderingWeek && userOrdersForOrderingWeek[userEmailKey]) {
                const weekToDisplay = (dayOfWeek === 6 || dayOfWeek === 0) ? weekForOrdering : getWeekString(today);
                const days = { mon: t('monday'), tue: t('tuesday'), wed: t('wednesday'), thu: t('thursday'), fri: t('friday') };
                let summaryHTML = `<div class="card"><div class="card-header"><h2 class="card-title">${t('orderedForWeek')} ${weekToDisplay.split('_')[1]}</h2></div><ul class="staff-list">`;
                for (const [key, name] of Object.entries(days)) {
                    const dayData = await getDocument(weekToDisplay, key, false);
                    const dish = dayData?.[userEmailKey]?.food;
                    const dishText = parseDish(dish) || t('notOrdered');
                    summaryHTML += `<li class="staff-item"><div class="staff-details"><div class="staff-name">${name}</div><div class="staff-dish">${dishText}</div></div></li>`;
                }
                container.innerHTML = summaryHTML + `</ul></div>`;
                return;
            }

            const menu = await getDocument(weekForOrdering, "menu", false);
            if (!menu) {
                container.innerHTML = `<div class="card text-center"><p class="text-muted">${t('menuNotAvailable', {week: weekForOrdering.split('_')[1]})}</p></div>`;
                return;
            }

            const days = { mon: t('monday'), tue: t('tuesday'), wed: t('wednesday'), thu: t('thursday'), fri: t('friday') };
            let orderCardsHTML = '';
            for (const [dayKey, dayName] of Object.entries(days)) {
                const dishes = menu[dayKey] || [];
                orderCardsHTML += `<div class="order-day-card"><div class="order-day-header"><div class="order-day-title">${dayName}</div></div><div class="order-dish-list">
                    ${(Array.isArray(dishes) && dishes.length > 0) ? dishes.map(dish => `<div class="order-dish-item ${state.orderSelection[dayKey] === dish ? 'selected' : ''}" data-dish="${dish}" data-day-key="${dayKey}"><div class="order-dish-name">${parseDish(dish)}</div></div>`).join('') : ''}
                    <div class="order-dish-item opt-out-btn ${state.orderSelection[dayKey] === 'OPT_OUT' ? 'selected' : ''}" data-dish="OPT_OUT" data-day-key="${dayKey}"><div class="order-dish-name">${t('optOut')}</div></div>
                </div></div>`;
            }
            container.innerHTML = `<div class="card"><div class="card-header"><h2 class="card-title">${t('orderForWeek')} ${weekForOrdering.split('_')[1]}</h2></div>${orderCardsHTML}<button id="submit-order-btn" class="btn btn-primary btn-block mt-3" disabled><i class="fas fa-check-circle"></i> ${t('completeOrder')}</button></div>`;
            checkOrderCompletion();
        }
        
        const checkOrderCompletion = () => {
            const allSelected = ['mon', 'tue', 'wed', 'thu', 'fri'].every(day => state.orderSelection[day]);
            const submitBtn = el('submit-order-btn');
            if (submitBtn) submitBtn.disabled = !allSelected;
        };

        async function renderMenu() {
            el('main-content').innerHTML = `<div class="card"><div class="card-header"><h2 class="card-title" data-translate="todayList"></h2><button id="menu-filter-btn" class="icon-btn"><i class="fas fa-filter"></i></button></div><div class="search-bar"><div class="search-wrapper"><i class="fas fa-search search-icon"></i><input type="text" id="search-staff" class="search-input" data-translate-placeholder="searchStaff"></div></div><div id="staff-list-container"></div></div>`;
            const dayData = await getDocument(getWeekString(new Date()), getDayKey(), true);
            if (dayData) {
                updateStaffListView(dayData);
                el('search-staff').addEventListener('input', (e) => updateStaffListView(dayData, e.target.value));
            } else {
                el('staff-list-container').innerHTML = `<p class="text-center text-muted p-3">${t('noData')}</p>`;
            }
        }

        function updateStaffListView(dayData, searchTerm = '') {
            // Unchanged...
        }

        async function renderProfile() {
            // Unchanged...
        }

        async function renderAdmin() {
            // Unchanged...
        }
        async function renderAdminSubTab() {
            // Unchanged...
        }
        async function renderAdminSupport() {
            // Unchanged...
        }
        async function renderAdminStats() {
            // Unchanged...
        }
        async function renderStatsContent() {
            // Unchanged...
        }
        async function renderAdminMenu() {
            const renderMenuSection = (weekStr, isEditable, title) => {
                const menuData = state.tempMenuData[weekStr] || {};
                const days = { mon: t('monday'), tue: t('tuesday'), wed: t('wednesday'), thu: t('thursday'), fri: t('friday') };
                let html = `<h3 style="color:var(--primary);margin:1.5rem 0 1rem;font-size:18px;">${title}</h3>`;
                for (const [key, name] of Object.entries(days)) {
                    const dishes = Array.isArray(menuData?.[key]) ? menuData[key] : [];
                    html += `<div class="form-group"><label class="form-label">${name}</label><div id="menu-dishes-${weekStr}-${key}">
                        ${dishes.map((dish, idx) => `<div class="menu-item"><div class="menu-item-text">${dish}</div>${isEditable ? `<button class="icon-btn remove-dish-btn" data-week="${weekStr}" data-day="${key}" data-index="${idx}"><i class="fas fa-times"></i></button>` : ''}</div>`).join('')}
                        ${isEditable ? `<div style="display:flex;gap:.5rem;margin-top:.5rem;align-items:flex-start;"><textarea class="form-textarea auto-expand" data-week="${weekStr}" data-day="${key}" placeholder="${t('addDishesPlaceholder')}"></textarea><button class="icon-btn add-dish-btn" data-week="${weekStr}" data-day="${key}"><i class="fas fa-plus"></i></button></div>` : (dishes.length === 0 ? `<p class="text-muted" style="font-size:13px;padding:.5rem 0;">${t('noDishes')}</p>` : '')}
                    </div></div>`;
                }
                html += `<div style="display:flex;gap:.5rem;margin-top:1rem;"><button class="btn btn-secondary import-menu-btn" style="flex:1;" data-week="${weekStr}" ${!isEditable ? 'disabled' : ''}><i class="fas fa-file-import"></i> ${t('import')}</button><button class="btn btn-secondary export-menu-btn" style="flex:1;" data-week="${weekStr}"><i class="fas fa-file-export"></i> ${t('export')}</button></div>
                ${isEditable ? `<button class="btn btn-primary btn-block mt-2 save-menu-btn" data-week="${weekStr}"><i class="fas fa-save"></i> ${t('saveMenu')}</button>` : ''}`;
                return html;
            };
            const today = new Date();
            const thisWeek = getWeekString(today), nextWeek = getWeekString(new Date(today.getTime() + 7 * 86400000));
            state.tempMenuData[thisWeek] = JSON.parse(JSON.stringify(await getDocument(thisWeek, "menu") || {}));
            state.tempMenuData[nextWeek] = JSON.parse(JSON.stringify(await getDocument(nextWeek, "menu") || {}));
            el('admin-content').innerHTML = `<div class="mt-3">${renderMenuSection(thisWeek, false, `${t('thisWeekMenu')} (${thisWeek.split('_')[1]})`)}${renderMenuSection(nextWeek, true, `${t('nextWeekMenu')} (${nextWeek.split('_')[1]})`)}</div>`;
        }
        async function renderAdminPersonnel() {
            // Unchanged...
        }

        async function syncUserProfile() {
            // Unchanged...
        }

        function updateUIForUser(user) {
            // Unchanged...
        }
        
        async function renderGuestOrderDays(weekType, forceRefresh = false) {
            // Unchanged...
        }

        async function checkOrderNotification() {
            // Unchanged...
        }
        
        document.body.addEventListener('input', e => {
            if (e.target.classList.contains('auto-expand')) {
                e.target.style.height = 'auto';
                e.target.style.height = (e.target.scrollHeight) + 'px';
            }
        });
        document.body.addEventListener('change', async (e) => {
            const { id, name, value } = e.target;
            if (id === 'stats-date-picker') { state.statsViewDate = new Date(value); await renderStatsContent(); applyTranslations(); }
            else if (name === 'stats-mode') { state.statsViewMode = value; await renderStatsContent(); applyTranslations(); }
            else if (name === 'guest-week') { await renderGuestOrderDays(value, true); applyTranslations(); }
        });

        document.body.addEventListener('click', async (e) => {
            const target = e.target.closest('button, a, .profile-menu-item, .order-dish-item');
            if (!target) return;

            const { id, classList, dataset } = target;

            // Navigation
            if (classList.contains('nav-item')) {
                if (dataset.tab === state.currentTab) return;
                document.querySelector('.nav-item.active').classList.remove('active');
                target.classList.add('active');
                state.currentTab = dataset.tab;
                await render();
            } else if (dataset.subtab) {
                state.adminSubTab = dataset.subtab;
                await renderAdmin();
            }
            
            // Authentication
            else if (id === 'login-btn') {
                showLoader();
                try { await signInWithPopup(auth, provider); } catch(err) { showToast(t('loginFail'), 'error'); } 
                finally { hideLoader(); }
            } else if (id === 'logout-menu-item') {
                if (confirm(t('logoutConfirm'))) { await signOut(auth); showToast(t('loggedOut')); }
            }
            
            // User Actions
            else if (classList.contains('lang-toggle-btn')) {
                if (dataset.lang === state.staffProfile.lan) return;
                showLoader();
                try {
                    await updateDoc(doc(db, "staff_list", "staffs"), { [`${emailToKey(state.currentUser.email)}.lan`]: dataset.lang });
                    state.staffProfile.lan = dataset.lang; state.cachedData.clear();
                    await render(); showToast(t('langChanged'));
                } catch { showToast(t('errorOccurred'), 'error'); } finally { hideLoader(); }
            } else if (classList.contains('order-dish-item') && !classList.contains('guest-dish-item')) {
                const { dayKey, dish } = dataset;
                state.orderSelection[dayKey] = dish;
                document.querySelectorAll(`.order-dish-item[data-day-key="${dayKey}"]`).forEach(item => item.classList.remove('selected'));
                target.classList.add('selected');
                checkOrderCompletion();
            } else if (id === 'submit-order-btn') {
                showLoader();
                try {
                    const today = new Date();
                    const targetWeek = (today.getDay() >= 4 || today.getDay() === 0) ? getWeekString(new Date(today.getTime() + 7 * 86400000)) : getWeekString(today);
                    for (const dayKey in state.orderSelection) {
                        const payload = { [emailToKey(state.currentUser.email)]: { name: state.staffProfile.name, email: state.currentUser.email, food: state.orderSelection[dayKey], status: 'not', shift: 'M', depart: state.staffProfile.depart }};
                        await setDoc(doc(db, targetWeek, dayKey), payload, { merge: true });
                    }
                    showToast(t('orderedSuccess')); state.orderSelection = {}; state.cachedData.clear();
                    await render();
                } catch { showToast(t('orderedFail'), 'error'); } finally { hideLoader(); }
            }

            // Admin Actions
            else if (id === 'menu-filter-btn') {
                state.menuFilterMode = state.menuFilterMode === 'auto' ? 'all' : 'auto';
                const dayData = await getDocument(getWeekString(new Date()), getDayKey(), true);
                if (dayData) updateStaffListView(dayData);
            } else if (classList.contains('remove-dish-btn')) {
                const { week, day, index } = dataset;
                if (state.tempMenuData[week]?.[day]?.splice(parseInt(index), 1)) {
                    await renderAdminMenu(); applyTranslations();
                }
            } else if (classList.contains('add-dish-btn')) {
                const { week, day } = dataset;
                const textarea = document.querySelector(`textarea[data-week="${week}"][data-day="${day}"]`);
                const dishValues = textarea.value.trim().split('\n').map(d => d.trim()).filter(Boolean);
                if (dishValues.length === 0) return;
                if (!Array.isArray(state.tempMenuData[week][day])) state.tempMenuData[week][day] = [];
                state.tempMenuData[week][day].push(...dishValues);
                await renderAdminMenu(); applyTranslations();
            } else if (classList.contains('save-menu-btn')) {
                const { week } = dataset;
                showLoader();
                try {
                    await setDoc(doc(db, week, "menu"), state.tempMenuData[week]);
                    state.cachedData.delete(`${week}/menu`);
                    showToast(t('menuSaved'));
                } catch { showToast(t('errorOccurred'), 'error'); } finally { hideLoader(); }
            } else if (id === 'add-guest-order-btn') {
                state.guestOrderSelection = {};
                await renderGuestOrderDays('this', true);
                el('guest-order-modal').classList.remove('hidden');
                applyTranslations();
            } else if (classList.contains('guest-dish-item')) {
                const { dayKey, dish } = dataset;
                state.guestOrderSelection[dayKey] = state.guestOrderSelection[dayKey] === dish ? null : dish;
                document.querySelectorAll(`.guest-dish-item[data-day-key="${dayKey}"]`).forEach(item => item.classList.remove('selected'));
                if(state.guestOrderSelection[dayKey]) target.classList.add('selected');
            } else if (classList.contains('reopen-order-btn')) {
                 state.reopenTarget = { key: dataset.key, name: dataset.name };
                 el('reopen-order-modal-title').textContent = t('reopenOrderFor', {name: dataset.name});
                 el('reopen-text').textContent = t('reopenOrderNotice');
                 el('reopen-order-modal').classList.remove('hidden');
            } else if(id === 'confirm-reopen-order-btn'){
                showLoader();
                try {
                    const weekString = getWeekString(new Date());
                    for (const day of ['mon', 'tue', 'wed', 'thu', 'fri']) {
                        await updateDoc(doc(db, weekString, day), { [state.reopenTarget.key]: deleteField() });
                    }
                    showToast(t('reopenedSuccess'));
                    el('reopen-order-modal').classList.add('hidden');
                    await renderAdmin();
                } catch { showToast(t('errorOccurred'), 'error'); } finally { hideLoader(); }
            } else if (id === 'add-personnel-btn' || classList.contains('edit-personnel-btn')) {
                const isEdit = classList.contains('edit-personnel-btn');
                const key = isEdit ? dataset.key : null;
                const profile = isEdit ? (await getDocument("staff_list", "staffs", true))[key] : {};

                el('personnel-modal-title').textContent = t(isEdit ? 'editProfile' : 'addStaff');
                el('personnel-original-email-key').value = key || '';
                el('personnel-name-input').value = profile.name || '';
                el('personnel-email-input').value = profile.email || '';
                
                const departsData = await getDocument('staff_list', 'departs');
                el('personnel-depart-select').innerHTML = (departsData.list || []).map(d => `<option value="${d}" ${d === profile.depart ? 'selected' : ''}>${d}</option>`).join('');
                el('personnel-modal').classList.remove('hidden');
            } else if (id === 'save-personnel-btn') {
                showLoader();
                try {
                    const name = el('personnel-name-input').value.trim();
                    const email = el('personnel-email-input').value.trim();
                    const depart = el('personnel-depart-select').value;
                    const originalKey = el('personnel-original-email-key').value;
                    if (!name || !email) throw new Error("Vui lòng điền đủ thông tin");
                    const newKey = emailToKey(email);
                    const staffRef = doc(db, "staff_list", "staffs");
                    const allStaff = await getDocument("staff_list", "staffs", true) || {};
                    if (originalKey && originalKey !== newKey) delete allStaff[originalKey];
                    allStaff[newKey] = { name, email, depart, lan: allStaff[newKey]?.lan || 'vi' };
                    await setDoc(staffRef, allStaff);
                    state.cachedData.delete("staff_list/staffs");
                    el('personnel-modal').classList.add('hidden');
                    showToast(t('save') + ' ' + t('success'));
                    await renderAdmin();
                } catch(err) { showToast(err.message, 'error'); } 
                finally { hideLoader(); }
            } else if (classList.contains('delete-personnel-btn')) {
                state.deleteTarget = { key: dataset.key, name: dataset.name };
                el('delete-personnel-text').textContent = t('deleteStaffConfirm', { name: dataset.name });
                el('delete-personnel-modal').classList.remove('hidden');
            } else if (id === 'confirm-delete-personnel-btn') {
                showLoader();
                try {
                    await updateDoc(doc(db, "staff_list", "staffs"), { [state.deleteTarget.key]: deleteField() });
                    state.cachedData.delete("staff_list/staffs");
                    el('delete-personnel-modal').classList.add('hidden');
                    showToast(t('delete') + ' ' + t('success'));
                    await renderAdmin();
                } catch { showToast(t('errorOccurred'), 'error'); }
                finally { hideLoader(); }
            }
            
            else if(dataset.modal){
                 el(dataset.modal).classList.add('hidden');
            }
        });

        // --- Main App Initialization ---
        async function main() {
            showLoader();
            try {
                await setPersistence(auth, browserLocalPersistence);
                onAuthStateChanged(auth, async (user) => {
                    if (user && user.uid !== state.currentUser?.uid) {
                        try {
                            state.currentUser = user; state.authReady = true;
                            await syncUserProfile();
                            updateUIForUser(user);
                            await render();
                            showToast(`${t('welcome')}, ${getFirstName(state.staffProfile.name)}!`);
                            await checkOrderNotification();
                        } catch (authError) {
                            showToast(authError.message, 'error');
                            await signOut(auth);
                        }
                    } else if (!user) {
                        state.currentUser = null; state.isAdmin = false; state.authReady = true;
                        updateUIForUser(null);
                        applyTranslations();
                    }
                    hideLoader();
                });
            } catch (error) {
                console.error('App init error:', error);
                hideLoader();
                showToast(t('errorOccurred'), 'error');
            }
        }

        main();
    </script>
</body>
</html>
