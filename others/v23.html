<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Inbold Lunch Menu</title>
    <link rel="icon" href="data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 512 512'%3e%3cpath fill='%23667eea' d='M63.9 14.4C63.1 6.2 56.2 0 48 0s-15.1 6.2-16 14.3L17.9 149.7c-1.3 6-1.9 12.1-1.9 18.2 0 45.9 35.1 83.6 80 87.7L96 480c0 17.7 14.3 32 32 32s32-14.3 32-32l0-224.4c44.9-4.1 80-41.8 80-87.7 0-6.1-.6-12.2-1.9-18.2L223.9 14.3C223.1 6.2 216.2 0 208 0s-15.1 6.2-15.9 14.4L178.5 149.9c-.6 5.7-5.4 10.1-11.1 10.1-5.8 0-10.6-4.4-11.2-10.2L143.9 14.6C143.2 6.3 136.3 0 128 0s-15.2 6.3-15.9 14.6L99.8 149.8c-.5 5.8-5.4 10.2-11.2 10.2-5.8 0-10.6-4.4-11.1-10.1L63.9 14.4zM448 0C432 0 320 32 320 176l0 112c0 35.3 28.7 64 64 64l32 0 0 128c0 17.7 14.3 32 32 32s32-14.3 32-32l0-448c0-17.7-14.3-32-32-32z'/%3e%3c/svg%3e">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Montserrat:wght@300;400;500;600;700&display=swap');
        :root { --primary: #667eea; --primary-dark: #5a67d8; --bg: #0f172a; --card: #1e293b; --text: #f1f5f9; --text-muted: #94a3b8; --success: #48bb78; --warning: #ed8936; --error: #f56565; --border: #334155; --radius: 12px; }
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body { font-family: 'Montserrat', sans-serif; background: var(--bg); color: var(--text); font-size: 14px; line-height: 1.5; min-height: 100vh; display: flex; flex-direction: column; }
        #app { max-width: 800px; margin: 0 auto; width: 100%; padding: 1rem; padding-bottom: 80px; flex-grow: 1; }
        .card { background: var(--card); border-radius: var(--radius); padding: 1.25rem; margin-bottom: 1rem; border: 1px solid var(--border); box-shadow: 0 2px 8px rgba(0,0,0,0.2); }
        .btn { padding: 10px 20px; border-radius: 8px; border: none; font-weight: 600; cursor: pointer; transition: 0.2s; display: inline-flex; align-items: center; justify-content: center; gap: 8px; color: white; }
        .btn-primary { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); }
        .btn-secondary { background: var(--card); border: 1px solid var(--border); color: var(--text); }
        .btn-danger { background: var(--error); } .btn-success { background: var(--success); } .btn-warning { background: var(--warning); }
        .btn:disabled { opacity: 0.6; cursor: not-allowed; }
        .btn-block { width: 100%; }
        .hidden { display: none !important; }
        
        /* Header/Hero */
        .hero-card { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); text-align: center; padding: 2rem; position: relative; overflow: hidden; }
        .hero-title { font-size: 24px; font-weight: 700; margin-bottom: 0.5rem; text-shadow: 0 2px 4px rgba(0,0,0,0.2); }
        .hero-subtitle { font-size: 14px; opacity: 0.9; }

        /* Navigation */
        #tab-bar { position: fixed; bottom: 1rem; left: 50%; transform: translateX(-50%); background: rgba(30, 41, 59, 0.95); backdrop-filter: blur(8px); padding: 8px; border-radius: 24px; display: flex; gap: 4px; border: 1px solid var(--border); box-shadow: 0 4px 12px rgba(0,0,0,0.3); z-index: 100; }
        .nav-item { width: 44px; height: 44px; border-radius: 16px; display: flex; align-items: center; justify-content: center; color: var(--text-muted); background: transparent; border: none; cursor: pointer; font-size: 18px; transition: 0.2s; }
        .nav-item.active { background: var(--primary); color: white; transform: translateY(-2px); }
        .nav-item.needs-attention::after { content: ''; position: absolute; top: 8px; right: 8px; width: 8px; height: 8px; background: var(--error); border-radius: 50%; }

        /* Lists & Forms */
        .staff-list { list-style: none; }
        .staff-item { display: flex; justify-content: space-between; align-items: center; padding: 10px; background: rgba(255,255,255,0.03); border-radius: 8px; margin-bottom: 6px; }
        .staff-item.skipped { border-left: 3px solid var(--warning); background: rgba(237, 137, 54, 0.1); }
        .staff-item.eaten { opacity: 0.6; }
        .form-group { margin-bottom: 1rem; }
        .form-label { display: block; margin-bottom: 6px; font-weight: 500; font-size: 13px; }
        .form-input, .form-select { width: 100%; padding: 10px; background: rgba(15, 23, 42, 0.5); border: 1px solid var(--border); border-radius: 8px; color: var(--text); font-family: inherit; }
        
        /* Tabs inside content */
        .tabs { display: flex; gap: 8px; overflow-x: auto; padding-bottom: 8px; margin-bottom: 1rem; }
        .tab-btn { padding: 6px 16px; background: var(--card); border: 1px solid var(--border); border-radius: 20px; color: var(--text-muted); white-space: nowrap; cursor: pointer; }
        .tab-btn.active { background: var(--primary); border-color: var(--primary); color: white; }
        
        /* Dish Selection */
        .dish-grid { display: grid; gap: 8px; }
        .dish-item { padding: 12px; background: rgba(102, 126, 234, 0.1); border: 1px solid transparent; border-radius: 8px; cursor: pointer; transition: 0.2s; }
        .dish-item:hover { border-color: var(--primary); }
        .dish-item.selected { background: rgba(102, 126, 234, 0.25); border-color: var(--primary); font-weight: 600; }

        /* Loader & Toast */
        #loader { position: fixed; inset: 0; background: rgba(15, 23, 42, 0.9); display: flex; justify-content: center; align-items: center; z-index: 9999; }
        .spinner { width: 40px; height: 40px; border: 3px solid rgba(255,255,255,0.1); border-top-color: var(--primary); border-radius: 50%; animation: spin 0.8s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }
        #toast { position: fixed; bottom: 80px; left: 50%; transform: translateX(-50%); background: var(--card); padding: 12px 24px; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.3); border: 1px solid var(--border); z-index: 2000; opacity: 0; pointer-events: none; transition: 0.3s; display: flex; align-items: center; gap: 10px; }
        #toast.show { opacity: 1; transform: translateX(-50%) translateY(0); }
        
        /* Modal */
        .modal { position: fixed; inset: 0; background: rgba(0,0,0,0.8); display: flex; align-items: center; justify-content: center; z-index: 1000; backdrop-filter: blur(2px); }
        .modal-content { background: var(--card); width: 90%; max-width: 450px; padding: 1.5rem; border-radius: 16px; border: 1px solid var(--border); }
        .modal-header { display: flex; justify-content: space-between; margin-bottom: 1rem; }
        .close-btn { background: none; border: none; color: var(--text-muted); font-size: 20px; cursor: pointer; }

        /* Tables */
        .table-container { overflow-x: auto; }
        table { width: 100%; border-collapse: collapse; }
        th, td { padding: 12px; text-align: left; border-bottom: 1px solid var(--border); font-size: 13px; }
        th { color: var(--primary); font-weight: 600; }
    </style>
</head>
<body>
    <div id="app">
        <main id="main-view"></main>
    </div>

    <!-- Navigation -->
    <nav id="tab-bar" class="hidden">
        <button class="nav-item active" data-tab="today" onclick="app.navigate('today')"><i class="fas fa-home"></i></button>
        <button class="nav-item" data-tab="order" onclick="app.navigate('order')"><i class="fas fa-utensils"></i></button>
        <button class="nav-item" data-tab="menu" onclick="app.navigate('menu')"><i class="fas fa-list"></i></button>
        <button class="nav-item hidden" id="admin-tab-btn" data-tab="admin" onclick="app.navigate('admin')"><i class="fas fa-chart-pie"></i></button>
        <button class="nav-item" data-tab="profile" onclick="app.navigate('profile')"><i class="fas fa-user"></i></button>
    </nav>

    <!-- Modals -->
    <div id="guest-modal" class="modal hidden">
        <div class="modal-content">
            <div class="modal-header"><h3>Đặt món cho khách</h3><button class="close-btn" onclick="ui.toggleModal('guest-modal', false)">&times;</button></div>
            <div id="guest-form-body"></div>
        </div>
    </div>

    <div id="loader" class="hidden"><div class="spinner"></div></div>
    <div id="toast"><i class="fas fa-info-circle"></i><span id="toast-msg">Message</span></div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getFirestore, doc, getDoc, setDoc, updateDoc, deleteField } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
        import { getAuth, GoogleAuthProvider, signInWithPopup, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";

        // --- CONFIGURATION ---
        const firebaseConfig = {
            apiKey: "AIzaSyCDrCaGUyr9xLkT-xOqzFd9grp6tN2u7Zo",
            authDomain: "hp-orders.firebaseapp.com",
            projectId: "hp-orders",
            storageBucket: "hp-orders.appspot.com",
            messagingSenderId: "616722831059",
            appId: "1:616722831059:web:9d19988d87397e7c13e626"
        };
        
        const appInit = initializeApp(firebaseConfig);
        const db = getFirestore(appInit);
        const auth = getAuth(appInit);
        const provider = new GoogleAuthProvider();

        // --- UTILS ---
        const Utils = {
            emailToKey: (email) => email.replace(/[.@]/g, '_'),
            getWeekStr: (date) => {
                const d = new Date(date);
                d.setHours(0,0,0,0);
                d.setDate(d.getDate() + 4 - (d.getDay() || 7));
                const yearStart = new Date(d.getFullYear(), 0, 1);
                const weekNo = Math.ceil((((d - yearStart) / 86400000) + 1) / 7);
                return `${d.getFullYear()}_${weekNo}`;
            },
            getDayKey: (date = new Date()) => ['sun', 'mon', 'tue', 'wed', 'thu', 'fri', 'sat'][date.getDay()],
            parseDish: (str) => {
                if (!str) return '';
                const parts = str.split('|');
                const lang = Store.profile?.lan || 'vi';
                return (lang.startsWith('en') && parts.length > 1) ? parts[1].trim() : parts[0].trim();
            },
            getGreeting: () => {
                const h = new Date().getHours();
                return h < 12 ? 'Chào buổi sáng' : (h < 18 ? 'Chào buổi chiều' : 'Chào buổi tối');
            }
        };

        // --- STATE MANAGEMENT ---
        const Store = {
            user: null,
            profile: null,
            isAdmin: false,
            cache: new Map(), // Caching data to reduce reads
            currentTab: 'today',
            orderBuffer: {} // Temp storage for ordering
        };

        // --- DATA LAYER (Smart Caching) ---
        const API = {
            async getDoc(collection, docId, force = false) {
                const key = `${collection}/${docId}`;
                if (!force && Store.cache.has(key)) return Store.cache.get(key);
                
                try {
                    const snap = await getDoc(doc(db, collection, docId));
                    const data = snap.exists() ? snap.data() : null;
                    Store.cache.set(key, data);
                    return data;
                } catch (e) { console.error(e); return null; }
            },
            async setDoc(collection, docId, data, merge = true) {
                await setDoc(doc(db, collection, docId), data, { merge });
                Store.cache.delete(`${collection}/${docId}`); // Invalidate cache
            },
            async updateOrder(week, day, updates) {
                const userKey = Utils.emailToKey(Store.user.email);
                const key = `${week}/${day}`;
                // Optimistic update: update cache immediately
                const cached = Store.cache.get(key);
                if (cached && cached[userKey]) {
                    Object.assign(cached[userKey], updates);
                }
                await updateDoc(doc(db, week, day), { [`${userKey}`]: updates }); // Only update specific fields
                // Note: We kept the cache valid because we manually updated it above
            },
            clearCache() { Store.cache.clear(); }
        };

        // --- UI RENDERER ---
        const UI = {
            showLoader: (show) => document.getElementById('loader').classList.toggle('hidden', !show),
            
            toast: (msg, type = 'info') => {
                const t = document.getElementById('toast');
                const icon = type === 'success' ? 'check-circle' : (type === 'error' ? 'exclamation-circle' : 'info-circle');
                const color = type === 'success' ? 'var(--success)' : (type === 'error' ? 'var(--error)' : 'var(--primary)');
                t.innerHTML = `<i class="fas fa-${icon}" style="color:${color}"></i> <span>${msg}</span>`;
                t.classList.add('show');
                setTimeout(() => t.classList.remove('show'), 3000);
            },

            toggleModal: (id, show) => document.getElementById(id).classList.toggle('hidden', !show),

            renderHero: (title, subtitle, actions = '') => {
                return `<div class="card hero-card">
                    <div class="hero-title">${title}</div>
                    <div class="hero-subtitle">${subtitle}</div>
                    ${actions ? `<div style="margin-top:1rem; display:flex; gap:10px; justify-content:center;">${actions}</div>` : ''}
                </div>`;
            },

            renderEmpty: (msg) => `<div class="card" style="text-align:center; padding:2rem; color:var(--text-muted);"><i class="fas fa-inbox" style="font-size:32px; margin-bottom:10px;"></i><br>${msg}</div>`
        };

        // --- CONTROLLERS (Views) ---
        const Views = {
            // 1. TODAY TAB
            async renderToday() {
                const container = document.getElementById('main-view');
                const dayKey = Utils.getDayKey();
                const weekStr = Utils.getWeekStr(new Date());
                const userKey = Utils.emailToKey(Store.user.email);
                
                // Weekend Logic
                if (dayKey === 'sat' || dayKey === 'sun') {
                    container.innerHTML = UI.renderHero('Cuối tuần vui vẻ!', 'Hẹn gặp lại vào thứ Hai.');
                    return;
                }

                UI.showLoader(true);
                // Fetch ONLY today's data first (Fast)
                let dayData = await API.getDoc(weekStr, dayKey);
                let myOrder = dayData?.[userKey];

                // Reopen Logic Check (Only if status is explicitly 'reopen')
                if (myOrder?.status === 'reopen') {
                    Views.renderReopenFlow(container);
                    UI.showLoader(false);
                    return;
                }

                if (!myOrder || myOrder.food.includes('Không đặt')) {
                    container.innerHTML = UI.renderHero(Utils.getGreeting(), 'Bạn chưa đặt món cho hôm nay.', 
                        `<button class="btn btn-secondary" onclick="app.navigate('order')">Đặt món ngay</button>`);
                } else {
                    const isEaten = myOrder.status === 'eaten';
                    const isSkip = myOrder.status === 'skip';
                    const btnSkipped = `<button class="btn btn-warning" onclick="app.handleAction('${weekStr}', '${dayKey}', 'skip')" ${isSkip || isEaten ? 'disabled' : ''}><i class="fas fa-ban"></i> Nhường</button>`;
                    const btnEaten = `<button class="btn btn-success" onclick="app.handleAction('${weekStr}', '${dayKey}', 'eaten')" ${isEaten ? 'disabled' : ''}><i class="fas fa-check"></i> Đã ăn</button>`;
                    
                    container.innerHTML = UI.renderHero(Utils.parseDish(myOrder.food), 'Phần ăn hôm nay của bạn', btnSkipped + btnEaten);
                }
                UI.showLoader(false);
            },

            // 2. ORDER TAB (Complex Logic Here)
            async renderOrder() {
                const container = document.getElementById('main-view');
                const now = new Date();
                const dayIdx = now.getDay(); // 0=Sun, 1=Mon...
                const hour = now.getHours();

                // Rule: Fri > 15h or Sat/Sun -> Order for NEXT WEEK. Else -> CURRENT WEEK.
                const isLateFriday = dayIdx === 5 && hour >= 15;
                const isWeekend = dayIdx === 6 || dayIdx === 0;
                const targetDate = (isLateFriday || isWeekend) ? new Date(now.getTime() + 7*86400000) : now;
                const targetWeek = Utils.getWeekStr(targetDate);
                
                UI.showLoader(true);
                
                // Parallel Fetch: Menu + Orders of 5 days
                const days = ['mon', 'tue', 'wed', 'thu', 'fri'];
                const promises = [API.getDoc(targetWeek, 'menu')];
                days.forEach(d => promises.push(API.getDoc(targetWeek, d)));
                
                const results = await Promise.all(promises);
                const menu = results[0];
                const userKey = Utils.emailToKey(Store.user.email);

                // Check if already ordered fully
                let existingOrders = {};
                let hasOrder = false;
                days.forEach((d, i) => {
                    const dayData = results[i+1];
                    if (dayData && dayData[userKey] && dayData[userKey].status !== 'reopen') {
                        existingOrders[d] = dayData[userKey].food;
                        hasOrder = true;
                    }
                });

                // View: Summary if ordered
                if (hasOrder) {
                    let html = `<div class="card"><div style="margin-bottom:1rem; font-weight:bold; font-size:16px;">Thực đơn đã đặt (Tuần ${targetWeek.split('_')[1]})</div><ul class="staff-list">`;
                    days.forEach(d => {
                        const dish = existingOrders[d] || 'Chưa đặt';
                        html += `<li class="staff-item"><span>${{mon:'Thứ 2', tue:'Thứ 3', wed:'Thứ 4', thu:'Thứ 5', fri:'Thứ 6'}[d]}</span><span style="font-weight:500; color:var(--primary)">${Utils.parseDish(dish)}</span></li>`;
                    });
                    html += `</ul></div>`;
                    container.innerHTML = html;
                    UI.showLoader(false);
                    return;
                }

                // View: Order Form
                if (!menu) {
                    container.innerHTML = UI.renderEmpty('Chưa có thực đơn cho tuần này.');
                    UI.showLoader(false);
                    return;
                }

                let html = `<div class="card"><div style="margin-bottom:1rem; font-weight:bold;">Đặt món tuần ${targetWeek.split('_')[1]}</div>
                <div class="form-group"><label class="form-label">Ca làm việc</label><select id="shift-select" class="form-select"><option value="M">Ca Sáng</option><option value="E">Ca Chiều</option></select></div>`;
                
                // Generate Tabs & Content
                html += `<div class="tabs">
                    ${days.map(d => `<button class="tab-btn ${d==='mon'?'active':''}" onclick="app.switchOrderTab('${d}')" id="tab-${d}">${{mon:'T2', tue:'T3', wed:'T4', thu:'T5', fri:'T6'}[d]}</button>`).join('')}
                </div>`;

                days.forEach(d => {
                    const dishes = menu[d] || [];
                    html += `<div id="content-${d}" class="dish-container ${d!=='mon'?'hidden':''}">`;
                    if (dishes.length === 0) {
                        html += `<div class="dish-item selected" onclick="app.selectDish('${d}', 'Nghỉ', this)">Nghỉ (Không có món)</div>`;
                        Store.orderBuffer[d] = 'Nghỉ';
                    } else {
                        dishes.forEach(dish => {
                            html += `<div class="dish-item" onclick="app.selectDish('${d}', '${dish}', this)">${Utils.parseDish(dish)}</div>`;
                        });
                    }
                    html += `</div>`;
                });

                html += `<button class="btn btn-primary btn-block" style="margin-top:1.5rem;" onclick="app.submitOrder('${targetWeek}')">Xác nhận đặt món</button></div>`;
                
                container.innerHTML = html;
                Store.orderBuffer = {}; // Reset buffer
                UI.showLoader(false);
            },

            // 3. MENU LIST TAB (Who ordered what?)
            async renderMenu() {
                const container = document.getElementById('main-view');
                const dayKey = Utils.getDayKey();
                const weekStr = Utils.getWeekStr(new Date());

                UI.showLoader(true);
                const dayData = await API.getDoc(weekStr, dayKey);

                if (!dayData) {
                    container.innerHTML = UI.renderEmpty('Chưa có dữ liệu hôm nay.');
                    UI.showLoader(false);
                    return;
                }

                const list = Object.entries(dayData)
                    .filter(([k, v]) => v.status !== 'reopen' && !v.food.includes('Không đặt'))
                    .map(([k, v]) => ({ ...v, key: k }));
                
                const skipped = list.filter(i => i.status === 'skip');
                const eaten = list.filter(i => i.status === 'eaten');
                const waiting = list.filter(i => i.status === 'not');

                const renderGroup = (title, items, cls='') => {
                    if (items.length === 0) return '';
                    return `<h4 style="margin:1rem 0 0.5rem; color:var(--primary)">${title} (${items.length})</h4>
                    <ul class="staff-list">${items.map(i => `
                        <li class="staff-item ${i.status==='eaten'?'eaten':''} ${cls}">
                            <div>
                                <div style="font-weight:600; font-size:13px;">${i.name}</div>
                                <div style="font-size:12px; color:var(--text-muted)">${Utils.parseDish(i.food)}</div>
                            </div>
                            ${i.status==='skip' ? '<i class="fas fa-hand-holding-heart" style="color:var(--warning)"></i>' : ''}
                        </li>`).join('')}</ul>`;
                };

                container.innerHTML = `<div class="card">
                    <div style="display:flex; justify-content:space-between; align-items:center;">
                        <h3>Danh sách hôm nay</h3>
                        <button class="btn btn-secondary" style="padding:6px 12px; font-size:12px;" onclick="Views.renderMenu()">Refresh</button>
                    </div>
                    ${renderGroup('Đã nhường', skipped, 'skipped')}
                    ${renderGroup('Chưa ăn', waiting)}
                    ${renderGroup('Đã ăn', eaten)}
                </div>`;
                UI.showLoader(false);
            },

            // 4. ADMIN TAB
            async renderAdmin() {
                const container = document.getElementById('main-view');
                if (!Store.isAdmin) {
                    container.innerHTML = UI.renderEmpty('Bạn không có quyền truy cập.');
                    return;
                }
                
                container.innerHTML = `<div class="card">
                    <h3>Admin Dashboard</h3>
                    <div class="tabs" style="margin-top:1rem;">
                        <button class="tab-btn active" onclick="app.renderStats()">Thống kê</button>
                        <button class="tab-btn" onclick="app.openGuestModal()">Đặt khách</button>
                    </div>
                    <div id="admin-content">
                        <p style="color:var(--text-muted); padding:1rem; text-align:center;">Chọn chức năng trên thanh công cụ</p>
                    </div>
                </div>`;
                app.renderStats(); // Default view
            },
            
            // 5. PROFILE
            renderProfile() {
                const p = Store.profile;
                document.getElementById('main-view').innerHTML = `<div class="card" style="text-align:center;">
                    <img src="${Store.user.photoURL}" style="width:80px; height:80px; border-radius:50%; margin-bottom:1rem; border:2px solid var(--primary);">
                    <h2 style="font-size:18px;">${p.name}</h2>
                    <p style="color:var(--text-muted); margin-bottom:1rem;">${p.depart || 'Chưa cập nhật phòng ban'}</p>
                    <div style="display:flex; gap:10px; justify-content:center; margin-bottom:2rem;">
                        <button class="btn btn-secondary" onclick="app.setLang('vi')" ${p.lan==='vi'?'style="background:var(--primary);border:none;"':''}>Tiếng Việt</button>
                        <button class="btn btn-secondary" onclick="app.setLang('en')" ${p.lan==='en'?'style="background:var(--primary);border:none;"':''}>English</button>
                    </div>
                    <button class="btn btn-danger btn-block" onclick="app.logout()">Đăng xuất</button>
                </div>`;
            },

            renderReopenFlow(container) {
                container.innerHTML = `<div class="card" style="text-align:center; border-color:var(--warning);">
                    <i class="fas fa-redo" style="font-size:32px; color:var(--warning); margin-bottom:1rem;"></i>
                    <h3>Đặt lại món</h3>
                    <p class="text-muted">Admin đã mở lại quyền đặt món cho bạn.</p>
                    <button class="btn btn-primary btn-block" style="margin-top:1rem;" onclick="app.navigate('order')">Đặt món ngay</button>
                </div>`;
            }
        };

        // --- MAIN APP LOGIC ---
        window.app = {
            navigate: (tab) => {
                Store.currentTab = tab;
                document.querySelectorAll('.nav-item').forEach(b => b.classList.toggle('active', b.dataset.tab === tab));
                
                if (tab === 'today') Views.renderToday();
                else if (tab === 'order') Views.renderOrder();
                else if (tab === 'menu') Views.renderMenu();
                else if (tab === 'admin') Views.renderAdmin();
                else if (tab === 'profile') UI.renderProfile();
            },

            switchOrderTab: (day) => {
                document.querySelectorAll('.dish-container').forEach(el => el.classList.add('hidden'));
                document.getElementById(`content-${day}`).classList.remove('hidden');
                document.querySelectorAll('.tab-btn').forEach(el => el.classList.remove('active'));
                document.getElementById(`tab-${day}`).classList.add('active');
            },

            selectDish: (day, dishName, el) => {
                Store.orderBuffer[day] = dishName;
                const parent = el.parentElement;
                parent.querySelectorAll('.dish-item').forEach(i => i.classList.remove('selected'));
                el.classList.add('selected');
            },

            submitOrder: async (weekStr) => {
                const days = ['mon', 'tue', 'wed', 'thu', 'fri'];
                // Validate: Must select for all 5 days
                const missing = days.filter(d => !Store.orderBuffer[d]);
                if (missing.length > 0) {
                    // Auto fill 'Nghỉ' if strict mode is off, but here let's ask user
                    if(!confirm(`Bạn chưa chọn món cho: ${missing.join(', ')}. Hệ thống sẽ tự chọn "Nghỉ" cho các ngày này?`)) return;
                    missing.forEach(d => Store.orderBuffer[d] = 'Nghỉ');
                }

                UI.showLoader(true);
                const shift = document.getElementById('shift-select').value;
                const userKey = Utils.emailToKey(Store.user.email);
                const payload = {
                    name: Store.profile.name,
                    email: Store.user.email,
                    depart: Store.profile.depart,
                    shift: shift,
                    status: 'not'
                };

                try {
                    const promises = days.map(day => {
                        const dish = Store.orderBuffer[day];
                        return API.setDoc(weekStr, day, {
                            [userKey]: { ...payload, food: dish }
                        });
                    });
                    await Promise.all(promises);
                    UI.toast('Đặt món thành công!', 'success');
                    API.clearCache(); // Clear cache to reflect new orders
                    app.navigate('today');
                } catch (e) {
                    console.error(e);
                    UI.toast('Lỗi khi lưu dữ liệu.', 'error');
                } finally {
                    UI.showLoader(false);
                }
            },

            handleAction: async (week, day, action) => {
                // Optimistic UI update
                const btn = event.target.closest('button');
                if(btn) btn.disabled = true;
                
                try {
                    await API.updateOrder(week, day, { status: action });
                    UI.toast(action === 'skip' ? 'Đã nhường suất ăn' : 'Đã xác nhận ăn', 'success');
                    Views.renderToday(); // Re-render to update UI state properly
                } catch (e) {
                    UI.toast('Có lỗi xảy ra', 'error');
                    if(btn) btn.disabled = false;
                }
            },

            setLang: async (lan) => {
                if (Store.profile.lan === lan) return;
                UI.showLoader(true);
                await updateDoc(doc(db, "staff_list", "staffs"), { 
                    [`${Utils.emailToKey(Store.user.email)}.lan`]: lan 
                });
                Store.profile.lan = lan;
                API.clearCache();
                UI.renderProfile();
                UI.showLoader(false);
                UI.toast('Đã đổi ngôn ngữ', 'success');
            },

            logout: () => signOut(auth),

            // Admin functions
            renderStats: async () => {
                const content = document.getElementById('admin-content');
                if(!content) return;
                
                const weekStr = Utils.getWeekStr(new Date());
                const dayKey = Utils.getDayKey();
                UI.showLoader(true);
                
                // Load today's data for stats
                const data = await API.getDoc(weekStr, dayKey);
                if (!data) {
                    content.innerHTML = `<p class="text-center">Không có dữ liệu hôm nay.</p>`;
                    UI.showLoader(false); return;
                }

                const stats = { M: {total:0, eaten:0}, E: {total:0, eaten:0} };
                
                Object.values(data).forEach(o => {
                    if(o.status === 'reopen' || o.food?.includes('Không đặt')) return;
                    const s = o.shift || 'M';
                    if(!stats[s]) stats[s] = {total:0, eaten:0};
                    stats[s].total++;
                    if(o.status === 'eaten') stats[s].eaten++;
                });

                content.innerHTML = `
                <div style="display:grid; grid-template-columns:1fr 1fr; gap:1rem; margin-top:1rem;">
                    <div class="card" style="text-align:center; padding:1rem; background:rgba(102, 126, 234, 0.1);">
                        <div style="font-weight:bold; color:var(--primary)">Ca Sáng</div>
                        <div style="font-size:24px;">${stats.M.eaten}/${stats.M.total}</div>
                        <div style="font-size:12px; color:var(--text-muted)">Đã ăn / Tổng</div>
                    </div>
                    <div class="card" style="text-align:center; padding:1rem; background:rgba(237, 137, 54, 0.1);">
                        <div style="font-weight:bold; color:var(--warning)">Ca Chiều</div>
                        <div style="font-size:24px;">${stats.E.eaten}/${stats.E.total}</div>
                        <div style="font-size:12px; color:var(--text-muted)">Đã ăn / Tổng</div>
                    </div>
                </div>
                <button class="btn btn-secondary btn-block" onclick="app.exportExcel('${weekStr}', '${dayKey}')"><i class="fas fa-file-excel"></i> Tải báo cáo hôm nay</button>`;
                UI.showLoader(false);
            },

            exportExcel: async (week, day) => {
                const data = await API.getDoc(week, day);
                if(!data) return UI.toast('Không có dữ liệu', 'error');
                
                const rows = Object.values(data).map(u => ({
                    Name: u.name,
                    Department: u.depart,
                    Dish: Utils.parseDish(u.food),
                    Status: u.status,
                    Shift: u.shift
                }));
                
                const wb = XLSX.utils.book_new();
                const ws = XLSX.utils.json_to_sheet(rows);
                XLSX.utils.book_append_sheet(wb, ws, `${day}`);
                XLSX.writeFile(wb, `Report_${day}.xlsx`);
            },

            openGuestModal: () => {
                // Simplistic guest order logic
                const form = document.getElementById('guest-form-body');
                form.innerHTML = `<div class="form-group"><label class="form-label">Tên khách</label><input type="text" id="g-name" class="form-input"></div>
                <div class="form-group"><label class="form-label">Món ăn (Nhập tay)</label><input type="text" id="g-dish" class="form-input"></div>
                <button class="btn btn-primary btn-block" onclick="app.submitGuest()">Lưu</button>`;
                UI.toggleModal('guest-modal', true);
            },
            
            submitGuest: async () => {
                const name = document.getElementById('g-name').value;
                const dish = document.getElementById('g-dish').value;
                if(!name || !dish) return UI.toast('Nhập đủ thông tin', 'error');
                
                const week = Utils.getWeekStr(new Date());
                const day = Utils.getDayKey();
                const key = `guest_${Date.now()}`;
                
                await API.setDoc(week, day, {
                    [key]: { name, food: dish, depart: 'Khách', status: 'not', shift: 'M' }
                });
                UI.toggleModal('guest-modal', false);
                UI.toast('Đã thêm khách', 'success');
            }
        };

        // --- INIT ---
        UI.showLoader(true);
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                Store.user = user;
                // 1. Get Profile
                const staffs = await API.getDoc("staff_list", "staffs", true); // Critical, force load
                const userKey = Utils.emailToKey(user.email);
                
                if (staffs && staffs[userKey]) {
                    Store.profile = staffs[userKey];
                    
                    // 2. Check Admin
                    const admins = await API.getDoc("admin_list", "admins", true);
                    Store.isAdmin = !!(admins && admins[userKey]);
                    if(Store.isAdmin) document.getElementById('admin-tab-btn').classList.remove('hidden');

                    document.getElementById('tab-bar').classList.remove('hidden');
                    app.navigate('today'); // Start app
                } else {
                    document.getElementById('main-view').innerHTML = UI.renderEmpty('Tài khoản không có quyền truy cập.');
                    UI.showLoader(false);
                }
            } else {
                document.getElementById('tab-bar').classList.add('hidden');
                document.getElementById('main-view').innerHTML = `<div class="card hero-card" style="margin-top:30vh;">
                    <div class="hero-title">Hệ thống đặt cơm</div>
                    <div class="hero-subtitle">Vui lòng đăng nhập để tiếp tục</div>
                    <button class="btn btn-light" style="background:white; color:#333; margin-top:1.5rem; width:100%;" id="login-btn"><i class="fab fa-google"></i> Đăng nhập với Google</button>
                </div>`;
                document.getElementById('login-btn').onclick = () => signInWithPopup(auth, provider);
                UI.showLoader(false);
            }
        });
    </script>
</body>
</html>
