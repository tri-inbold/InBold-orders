<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Inbold Menu</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;600;700&display=swap');
        
        :root {
            --primary: #667eea;
            --primary-dark: #5a67d8;
            --primary-light: #7c8aed;
            --secondary: #4299e1;
            --accent: #ed64a6;
            --success: #48bb78;
            --warning: #ed8936;
            --error: #f56565;
            --dark-bg: #0f172a;
            --card-bg: #1e293b;
            --card-hover: #334155;
            --border: #334155;
            --text: #f1f5f9;
            --text-muted: #94a3b8;
            --gradient-1: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            --gradient-2: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            --gradient-3: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            --shadow-sm: 0 1px 3px rgba(0, 0, 0, 0.1);
            --shadow-md: 0 2px 8px rgba(0, 0, 0, 0.15);
            --shadow-lg: 0 4px 16px rgba(0, 0, 0, 0.2);
            --radius-sm: 8px;
            --radius-md: 12px;
            --radius-lg: 16px;
        }
        
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }
        
        body {
            font-family: 'Roboto', 'Arial', -apple-system, BlinkMacSystemFont, sans-serif;
            background: var(--dark-bg);
            color: var(--text);
            line-height: 1.5;
            font-size: 14px;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }
        
        #app {
            max-width: 900px;
            margin: 0 auto;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            padding-bottom: 100px;
        }
        
        @media (min-width: 769px) {
            #app {
                padding: 1.5rem;
            }
            
            body {
                font-size: 13px;
            }
        }
        
        /* Header */
        header {
            padding: 1rem 1.5rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: sticky;
            top: 0;
            z-index: 50;
            background: rgba(15, 23, 42, 0.95);
            backdrop-filter: blur(10px);
            border-bottom: 1px solid var(--border);
        }
        
        @media (min-width: 769px) {
            header {
                border-radius: var(--radius-lg);
                margin-bottom: 1.5rem;
            }
        }
        
        .user-profile {
            display: flex;
            align-items: center;
            gap: 10px;
            cursor: pointer;
            padding: 6px 10px;
            border-radius: var(--radius-sm);
            transition: all 0.2s ease;
        }
        
        .user-profile:hover {
            background: var(--card-bg);
        }
        
        .user-avatar {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            border: 2px solid var(--primary);
            object-fit: cover;
        }
        
        .user-info h2 {
            font-size: 14px;
            font-weight: 500;
            color: var(--text);
        }
        
        .user-info p {
            font-size: 11px;
            color: var(--text-muted);
        }
        
        .header-actions {
            display: flex;
            gap: 8px;
            align-items: center;
        }
        
        .icon-btn {
            width: 36px;
            height: 36px;
            border-radius: var(--radius-sm);
            background: var(--card-bg);
            border: 1px solid var(--border);
            color: var(--text);
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.2s ease;
            font-size: 16px;
        }
        
        .icon-btn:hover {
            background: var(--card-hover);
            transform: translateY(-1px);
        }
        
        .icon-btn.active {
            background: var(--primary);
            border-color: var(--primary);
        }
        
        /* Main Content */
        main {
            flex-grow: 1;
            padding: 0 1rem;
        }
        
        @media (min-width: 769px) {
            main {
                padding: 0 1.5rem;
            }
        }
        
        .card {
            background: var(--card-bg);
            border-radius: var(--radius-md);
            padding: 1.25rem;
            margin-bottom: 1rem;
            border: 1px solid var(--border);
            box-shadow: var(--shadow-sm);
            transition: all 0.2s ease;
        }
        
        @media (min-width: 769px) {
            .card {
                padding: 1.5rem;
            }
        }
        
        .card:hover {
            box-shadow: var(--shadow-md);
        }
        
        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }
        
        .card-title {
            font-size: 18px;
            font-weight: 600;
            color: var(--text);
        }
        
        @media (min-width: 769px) {
            .card-title {
                font-size: 20px;
            }
        }
        
        /* Hero Section */
        .hero-card {
            background: var(--gradient-1);
            position: relative;
            overflow: hidden;
            min-height: 160px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            text-align: center;
        }
        
        @media (min-width: 769px) {
            .hero-card {
                min-height: 180px;
            }
        }
        
        .hero-card::before {
            content: '';
            position: absolute;
            top: -50%;
            right: -50%;
            width: 200%;
            height: 200%;
            background: radial-gradient(circle, rgba(255,255,255,0.08) 0%, transparent 70%);
            animation: pulse 4s ease-in-out infinite;
        }
        
        @keyframes pulse {
            0%, 100% { transform: scale(1); opacity: 0.5; }
            50% { transform: scale(1.05); opacity: 0.7; }
        }
        
        .hero-content {
            position: relative;
            z-index: 1;
        }
        
        .hero-greeting {
            font-size: 14px;
            font-weight: 400;
            margin-bottom: 6px;
            opacity: 0.95;
        }
        
        .hero-title {
            font-size: 32px;
            font-weight: 700;
            margin-bottom: 8px;
            text-shadow: 0 2px 10px rgba(0,0,0,0.2);
        }
        
        @media (min-width: 769px) {
            .hero-greeting {
                font-size: 15px;
            }
            
            .hero-title {
                font-size: 36px;
            }
        }
        
        .hero-subtitle {
            font-size: 13px;
            opacity: 0.9;
        }
        
        /* Stats Grid */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
            gap: 0.75rem;
            margin-top: 1rem;
        }
        
        .stat-card {
            background: var(--card-bg);
            padding: 1rem;
            border-radius: var(--radius-md);
            border: 1px solid var(--border);
            transition: all 0.2s ease;
        }
        
        .stat-card:hover {
            transform: translateY(-2px);
            border-color: var(--primary);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.15);
        }
        
        .stat-icon {
            width: 40px;
            height: 40px;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            margin-bottom: 0.75rem;
        }
        
        .stat-icon.purple { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); }
        .stat-icon.blue { background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%); }
        .stat-icon.pink { background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); }
        .stat-icon.green { background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%); }
        
        .stat-value {
            font-size: 24px;
            font-weight: 700;
            margin-bottom: 2px;
        }
        
        .stat-label {
            font-size: 12px;
            color: var(--text-muted);
        }
        
        /* Tabs */
        .tabs {
            display: flex;
            gap: 6px;
            margin-bottom: 1rem;
            overflow-x: auto;
            padding-bottom: 4px;
        }
        
        .tabs::-webkit-scrollbar {
            height: 3px;
        }
        
        .tabs::-webkit-scrollbar-track {
            background: var(--card-bg);
        }
        
        .tabs::-webkit-scrollbar-thumb {
            background: var(--primary);
            border-radius: 2px;
        }
        
        .tab-btn {
            padding: 8px 16px;
            border-radius: var(--radius-sm);
            background: var(--card-bg);
            border: 1px solid var(--border);
            color: var(--text-muted);
            cursor: pointer;
            transition: all 0.2s ease;
            white-space: nowrap;
            font-weight: 500;
            font-size: 13px;
        }
        
        .tab-btn:hover {
            background: var(--card-hover);
            color: var(--text);
        }
        
        .tab-btn.active {
            background: var(--primary);
            border-color: var(--primary);
            color: white;
        }
        
        /* Food Options */
        .food-options {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 0.75rem;
        }
        
        .food-option {
            background: var(--card-bg);
            border: 1px solid var(--border);
            border-radius: var(--radius-sm);
            padding: 1rem;
            cursor: pointer;
            transition: all 0.2s ease;
            text-align: center;
            position: relative;
        }
        
        .food-option:hover {
            border-color: var(--primary);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.15);
        }
        
        .food-option.selected {
            border-color: var(--primary);
            background: rgba(102, 126, 234, 0.08);
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }
        
        .food-icon {
            font-size: 36px;
            margin-bottom: 8px;
        }
        
        .food-name {
            font-size: 14px;
            font-weight: 500;
            color: var(--text);
        }
        
        /* Staff List */
        .staff-list {
            list-style: none;
        }
        
        .staff-item {
            display: flex;
            align-items: center;
            padding: 0.75rem;
            background: rgba(30, 41, 59, 0.5);
            border-radius: var(--radius-sm);
            margin-bottom: 6px;
            border: 1px solid transparent;
            transition: all 0.2s ease;
        }
        
        .staff-item:hover {
            background: var(--card-hover);
            border-color: var(--border);
        }
        
        .staff-item.eaten {
            opacity: 0.5;
        }
        
        .staff-avatar {
            width: 34px;
            height: 34px;
            border-radius: 50%;
            background: var(--gradient-1);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            margin-right: 10px;
            font-size: 13px;
        }
        
        .staff-details {
            flex: 1;
        }
        
        .staff-name {
            font-weight: 500;
            font-size: 14px;
            margin-bottom: 2px;
        }
        
        .staff-dish {
            font-size: 12px;
            color: var(--text-muted);
        }
        
        /* Buttons */
        .btn {
            padding: 10px 20px;
            border-radius: var(--radius-sm);
            border: none;
            font-weight: 500;
            font-size: 13px;
            cursor: pointer;
            transition: all 0.2s ease;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
        }
        
        .btn-primary {
            background: var(--gradient-1);
            color: white;
            box-shadow: 0 2px 8px rgba(102, 126, 234, 0.3);
        }
        
        .btn-primary:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
        }
        
        .btn-secondary {
            background: var(--card-bg);
            color: var(--text);
            border: 1px solid var(--border);
        }
        
        .btn-secondary:hover {
            background: var(--card-hover);
        }
        
        .btn-danger {
            background: var(--error);
            color: white;
        }
        
        .btn-success {
            background: var(--success);
            color: white;
        }
        
        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        .btn-block {
            width: 100%;
        }
        
        /* Forms */
        .form-group {
            margin-bottom: 1rem;
        }
        
        .form-label {
            display: block;
            margin-bottom: 6px;
            font-weight: 500;
            font-size: 13px;
            color: var(--text);
        }
        
        .form-input,
        .form-select,
        .form-textarea {
            width: 100%;
            padding: 10px 12px;
            background: rgba(15, 23, 42, 0.5);
            border: 1px solid var(--border);
            border-radius: var(--radius-sm);
            color: var(--text);
            font-size: 13px;
            transition: all 0.2s ease;
            font-family: 'Roboto', 'Arial', sans-serif;
        }
        
        .form-input:focus,
        .form-select:focus,
        .form-textarea:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }
        
        .form-textarea {
            resize: vertical;
            min-height: 80px;
        }
        
        /* Search Bar */
        .search-bar {
            display: flex;
            gap: 8px;
            margin-bottom: 1rem;
        }
        
        .search-input {
            flex: 1;
            padding: 10px 12px;
            padding-left: 38px;
            background: rgba(15, 23, 42, 0.5);
            border: 1px solid var(--border);
            border-radius: var(--radius-sm);
            color: var(--text);
            font-size: 13px;
        }
        
        .search-wrapper {
            position: relative;
            flex: 1;
        }
        
        .search-icon {
            position: absolute;
            left: 12px;
            top: 50%;
            transform: translateY(-50%);
            color: var(--text-muted);
            font-size: 14px;
        }
        
        /* Modal */
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.75);
            backdrop-filter: blur(4px);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            padding: 1rem;
        }
        
        .modal-content {
            background: var(--card-bg);
            border-radius: var(--radius-lg);
            padding: 1.5rem;
            width: 100%;
            max-width: 450px;
            max-height: 90vh;
            overflow-y: auto;
            border: 1px solid var(--border);
            box-shadow: var(--shadow-lg);
            animation: modalSlideIn 0.2s ease;
        }
        
        @keyframes modalSlideIn {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }
        
        .modal-title {
            font-size: 18px;
            font-weight: 600;
        }
        
        .close-btn {
            width: 32px;
            height: 32px;
            border-radius: 6px;
            background: transparent;
            border: none;
            color: var(--text-muted);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
        }
        
        .close-btn:hover {
            background: var(--card-hover);
            color: var(--text);
        }
        
        /* Bottom Navigation */
        #tab-bar {
            position: fixed;
            bottom: 0.75rem;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(30, 41, 59, 0.98);
            backdrop-filter: blur(10px);
            border: 1px solid var(--border);
            border-radius: 20px;
            padding: 6px;
            display: flex;
            gap: 4px;
            box-shadow: var(--shadow-lg);
            z-index: 100;
            width: calc(100% - 1.5rem);
            max-width: 500px;
        }
        
        .nav-item {
            flex: 1;
            padding: 10px 12px;
            border-radius: 14px;
            background: transparent;
            border: none;
            color: var(--text-muted);
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 3px;
            font-size: 11px;
            font-weight: 500;
            position: relative;
        }
        
        .nav-item i {
            font-size: 18px;
        }
        
        .nav-item:hover {
            color: var(--text);
        }
        
        .nav-item.active {
            background: var(--primary);
            color: white;
        }
        
        .nav-item.needs-attention::after {
            content: '';
            position: absolute;
            top: 6px;
            right: 16px;
            width: 6px;
            height: 6px;
            background: var(--error);
            border-radius: 50%;
            animation: pulse-dot 1.5s infinite;
        }
        
        @keyframes pulse-dot {
            0%, 100% {
                box-shadow: 0 0 0 0 rgba(245, 101, 101, 0.7);
            }
            50% {
                box-shadow: 0 0 0 5px rgba(245, 101, 101, 0);
            }
        }
        
        /* Toast */
        #toast-notification {
            position: fixed;
            bottom: 100px;
            left: 50%;
            transform: translateX(-50%) translateY(150px);
            background: var(--card-bg);
            color: var(--text);
            padding: 12px 20px;
            border-radius: var(--radius-md);
            box-shadow: var(--shadow-lg);
            border: 1px solid var(--border);
            z-index: 1001;
            transition: transform 0.3s cubic-bezier(0.68, -0.55, 0.265, 1.55);
            max-width: 90%;
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 13px;
        }
        
        #toast-notification.show {
            transform: translateX(-50%) translateY(0);
        }
        
        #toast-notification.success {
            border-color: var(--success);
        }
        
        #toast-notification.error {
            border-color: var(--error);
        }
        
        .toast-icon {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 11px;
        }
        
        .toast-icon.success {
            background: var(--success);
        }
        
        .toast-icon.error {
            background: var(--error);
        }
        
        /* Loader */
        #loader {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(15, 23, 42, 0.9);
            backdrop-filter: blur(4px);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 9999;
        }
        
        .spinner {
            width: 48px;
            height: 48px;
            border: 3px solid rgba(102, 126, 234, 0.2);
            border-top-color: var(--primary);
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        /* Table */
        .table-wrapper {
            overflow-x: auto;
            border-radius: var(--radius-sm);
            border: 1px solid var(--border);
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
        }
        
        thead {
            background: rgba(102, 126, 234, 0.08);
        }
        
        th {
            padding: 10px 12px;
            text-align: left;
            font-weight: 600;
            color: var(--primary);
            font-size: 12px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        td {
            padding: 10px 12px;
            border-top: 1px solid var(--border);
            font-size: 13px;
        }
        
        tr:hover {
            background: rgba(102, 126, 234, 0.04);
        }
        
        .action-buttons {
            display: flex;
            gap: 6px;
        }
        
        /* Shift Toggle */
        .shift-toggle {
            display: flex;
            gap: 6px;
            background: rgba(102, 126, 234, 0.08);
            padding: 4px;
            border-radius: var(--radius-sm);
        }
        
        .shift-toggle input[type="radio"] {
            display: none;
        }
        
        .shift-toggle label {
            flex: 1;
            padding: 8px 14px;
            text-align: center;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s ease;
            font-weight: 500;
            color: var(--text-muted);
            font-size: 13px;
        }
        
        .shift-toggle input[type="radio"]:checked + label {
            background: var(--primary);
            color: white;
        }
        
        /* Menu Editor Styles */
        .menu-day-editor {
            margin-bottom: 1rem;
        }
        
        .menu-dish-input-group {
            display: flex;
            gap: 6px;
            margin-bottom: 6px;
        }
        
        .menu-dish-input-group input {
            margin-bottom: 0;
        }
        
        .menu-dish-input-group .icon-btn {
            height: 38px;
            width: 38px;
        }
        
        /* Utilities */
        .hidden {
            display: none !important;
        }
        
        .text-center {
            text-align: center;
        }
        
        .mt-1 { margin-top: 0.5rem; }
        .mt-2 { margin-top: 1rem; }
        .mt-3 { margin-top: 1.5rem; }
        .mb-1 { margin-bottom: 0.5rem; }
        .mb-2 { margin-bottom: 1rem; }
        .mb-3 { margin-bottom: 1.5rem; }
        
        /* Responsive */
        @media (max-width: 768px) {
            .hero-title {
                font-size: 28px;
            }
            
            .stats-grid {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .food-options {
                grid-template-columns: 1fr;
            }
            
            .nav-item span {
                display: none;
            }
        };
            gap: 12px;
            cursor: pointer;
            padding: 8px 12px;
            border-radius: var(--radius-sm);
            transition: all 0.3s ease;
        }
        
        .user-profile:hover {
            background: var(--card-bg);
        }
        
        .user-avatar {
            width: 44px;
            height: 44px;
            border-radius: 50%;
            border: 2px solid var(--primary);
            object-fit: cover;
        }
        
        .user-info h2 {
            font-size: 16px;
            font-weight: 600;
            color: var(--text);
        }
        
        .user-info p {
            font-size: 12px;
            color: var(--text-muted);
        }
        
        .header-actions {
            display: flex;
            gap: 12px;
            align-items: center;
        }
        
        .icon-btn {
            width: 44px;
            height: 44px;
            border-radius: var(--radius-sm);
            background: var(--card-bg);
            border: 1px solid var(--border);
            color: var(--text);
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 18px;
        }
        
        .icon-btn:hover {
            background: var(--card-hover);
            transform: translateY(-2px);
            box-shadow: var(--shadow-md);
        }
        
        .icon-btn.active {
            background: var(--primary);
            border-color: var(--primary);
        }
        
        /* Main Content */
        main {
            flex-grow: 1;
            padding: 1.5rem;
        }
        
        .card {
            background: var(--card-bg);
            border-radius: var(--radius-lg);
            padding: 2rem;
            margin-bottom: 1.5rem;
            border: 1px solid var(--border);
            box-shadow: var(--shadow-md);
            transition: all 0.3s ease;
        }
        
        .card:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-lg);
        }
        
        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
        }
        
        .card-title {
            font-size: 24px;
            font-weight: 700;
            background: var(--gradient-1);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        
        /* Hero Section */
        .hero-card {
            background: var(--gradient-1);
            position: relative;
            overflow: hidden;
            min-height: 200px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            text-align: center;
        }
        
        .hero-card::before {
            content: '';
            position: absolute;
            top: -50%;
            right: -50%;
            width: 200%;
            height: 200%;
            background: radial-gradient(circle, rgba(255,255,255,0.1) 0%, transparent 70%);
            animation: pulse 4s ease-in-out infinite;
        }
        
        @keyframes pulse {
            0%, 100% { transform: scale(1); opacity: 0.5; }
            50% { transform: scale(1.1); opacity: 0.8; }
        }
        
        .hero-content {
            position: relative;
            z-index: 1;
        }
        
        .hero-greeting {
            font-size: 18px;
            font-weight: 500;
            margin-bottom: 8px;
            opacity: 0.9;
        }
        
        .hero-title {
            font-size: 48px;
            font-weight: 800;
            margin-bottom: 1rem;
            text-shadow: 0 4px 20px rgba(0,0,0,0.3);
        }
        
        .hero-subtitle {
            font-size: 16px;
            opacity: 0.9;
        }
        
        /* Stats Grid */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin-top: 1.5rem;
        }
        
        .stat-card {
            background: var(--card-bg);
            padding: 1.5rem;
            border-radius: var(--radius-md);
            border: 1px solid var(--border);
            transition: all 0.3s ease;
        }
        
        .stat-card:hover {
            transform: translateY(-4px);
            border-color: var(--primary);
            box-shadow: 0 8px 24px rgba(139, 92, 246, 0.2);
        }
        
        .stat-icon {
            width: 48px;
            height: 48px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            margin-bottom: 1rem;
        }
        
        .stat-icon.purple { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); }
        .stat-icon.blue { background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%); }
        .stat-icon.pink { background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); }
        .stat-icon.green { background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%); }
        
        .stat-value {
            font-size: 32px;
            font-weight: 700;
            margin-bottom: 4px;
        }
        
        .stat-label {
            font-size: 13px;
            color: var(--text-muted);
        }
        
        /* Tabs */
        .tabs {
            display: flex;
            gap: 8px;
            margin-bottom: 1.5rem;
            overflow-x: auto;
            padding-bottom: 8px;
        }
        
        .tabs::-webkit-scrollbar {
            height: 4px;
        }
        
        .tabs::-webkit-scrollbar-track {
            background: var(--card-bg);
            border-radius: 2px;
        }
        
        .tabs::-webkit-scrollbar-thumb {
            background: var(--primary);
            border-radius: 2px;
        }
        
        .tab-btn {
            padding: 10px 20px;
            border-radius: var(--radius-sm);
            background: var(--card-bg);
            border: 1px solid var(--border);
            color: var(--text-muted);
            cursor: pointer;
            transition: all 0.3s ease;
            white-space: nowrap;
            font-weight: 500;
            font-size: 14px;
        }
        
        .tab-btn:hover {
            background: var(--card-hover);
            color: var(--text);
        }
        
        .tab-btn.active {
            background: var(--primary);
            border-color: var(--primary);
            color: white;
            box-shadow: 0 4px 12px rgba(139, 92, 246, 0.4);
        }
        
        /* Food Options */
        .food-options {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 1rem;
        }
        
        .food-option {
            background: var(--card-bg);
            border: 2px solid var(--border);
            border-radius: var(--radius-md);
            padding: 1.5rem;
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: center;
            position: relative;
            overflow: hidden;
        }
        
        .food-option::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: var(--gradient-1);
            transform: scaleX(0);
            transition: transform 0.3s ease;
        }
        
        .food-option:hover {
            border-color: var(--primary);
            transform: translateY(-4px);
            box-shadow: 0 8px 24px rgba(139, 92, 246, 0.2);
        }
        
        .food-option:hover::before {
            transform: scaleX(1);
        }
        
        .food-option.selected {
            border-color: var(--primary);
            background: linear-gradient(135deg, rgba(139, 92, 246, 0.1) 0%, rgba(124, 58, 237, 0.05) 100%);
        }
        
        .food-option.selected::before {
            transform: scaleX(1);
        }
        
        .food-icon {
            font-size: 48px;
            margin-bottom: 12px;
        }
        
        .food-name {
            font-size: 16px;
            font-weight: 600;
            color: var(--text);
        }
        
        /* Staff List */
        .staff-list {
            list-style: none;
        }
        
        .staff-item {
            display: flex;
            align-items: center;
            padding: 1rem;
            background: var(--card-bg);
            border-radius: var(--radius-sm);
            margin-bottom: 8px;
            border: 1px solid var(--border);
            transition: all 0.3s ease;
        }
        
        .staff-item:hover {
            background: var(--card-hover);
            transform: translateX(4px);
        }
        
        .staff-item.eaten {
            opacity: 0.5;
        }
        
        .staff-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: var(--gradient-1);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            margin-right: 12px;
        }
        
        .staff-details {
            flex: 1;
        }
        
        .staff-name {
            font-weight: 600;
            font-size: 15px;
            margin-bottom: 2px;
        }
        
        .staff-dish {
            font-size: 13px;
            color: var(--text-muted);
        }
        
        /* Buttons */
        .btn {
            padding: 12px 24px;
            border-radius: var(--radius-sm);
            border: none;
            font-weight: 600;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }
        
        .btn-primary {
            background: var(--gradient-1);
            color: white;
            box-shadow: 0 4px 12px rgba(139, 92, 246, 0.4);
        }
        
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(139, 92, 246, 0.5);
        }
        
        .btn-secondary {
            background: var(--card-bg);
            color: var(--text);
            border: 1px solid var(--border);
        }
        
        .btn-secondary:hover {
            background: var(--card-hover);
        }
        
        .btn-danger {
            background: var(--error);
            color: white;
        }
        
        .btn-success {
            background: var(--success);
            color: white;
        }
        
        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        .btn-block {
            width: 100%;
        }
        
        /* Forms */
        .form-group {
            margin-bottom: 1.5rem;
        }
        
        .form-label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            font-size: 14px;
            color: var(--text);
        }
        
        .form-input,
        .form-select,
        .form-textarea {
            width: 100%;
            padding: 12px 16px;
            background: var(--card-bg);
            border: 1px solid var(--border);
            border-radius: var(--radius-sm);
            color: var(--text);
            font-size: 14px;
            transition: all 0.3s ease;
        }
        
        .form-input:focus,
        .form-select:focus,
        .form-textarea:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(139, 92, 246, 0.1);
        }
        
        .form-textarea {
            resize: vertical;
            min-height: 100px;
            font-family: inherit;
        }
        
        /* Search Bar */
        .search-bar {
            display: flex;
            gap: 12px;
            margin-bottom: 1.5rem;
        }
        
        .search-input {
            flex: 1;
            padding: 12px 16px;
            padding-left: 44px;
            background: var(--card-bg);
            border: 1px solid var(--border);
            border-radius: var(--radius-sm);
            color: var(--text);
            font-size: 14px;
        }
        
        .search-wrapper {
            position: relative;
            flex: 1;
        }
        
        .search-icon {
            position: absolute;
            left: 14px;
            top: 50%;
            transform: translateY(-50%);
            color: var(--text-muted);
            font-size: 16px;
        }
        
        /* Modal */
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.7);
            backdrop-filter: blur(4px);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            padding: 1rem;
        }
        
        .modal-content {
            background: var(--card-bg);
            border-radius: var(--radius-lg);
            padding: 2rem;
            width: 100%;
            max-width: 500px;
            max-height: 90vh;
            overflow-y: auto;
            border: 1px solid var(--border);
            box-shadow: var(--shadow-lg);
            animation: modalSlideIn 0.3s ease;
        }
        
        @keyframes modalSlideIn {
            from {
                opacity: 0;
                transform: translateY(-20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
        }
        
        .modal-title {
            font-size: 24px;
            font-weight: 700;
        }
        
        .close-btn {
            width: 36px;
            height: 36px;
            border-radius: 8px;
            background: transparent;
            border: none;
            color: var(--text-muted);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
        }
        
        .close-btn:hover {
            background: var(--card-hover);
            color: var(--text);
        }
        
        /* Bottom Navigation */
        #tab-bar {
            position: fixed;
            bottom: 1rem;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(30, 41, 59, 0.95);
            backdrop-filter: blur(20px);
            border: 1px solid var(--border);
            border-radius: 24px;
            padding: 8px;
            display: flex;
            gap: 4px;
            box-shadow: var(--shadow-lg);
            z-index: 100;
            width: calc(100% - 2rem);
            max-width: 600px;
        }
        
        .nav-item {
            flex: 1;
            padding: 12px 16px;
            border-radius: 16px;
            background: transparent;
            border: none;
            color: var(--text-muted);
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 4px;
            font-size: 12px;
            font-weight: 500;
            position: relative;
        }
        
        .nav-item i {
            font-size: 20px;
        }
        
        .nav-item:hover {
            color: var(--text);
        }
        
        .nav-item.active {
            background: var(--primary);
            color: white;
        }
        
        .nav-item.needs-attention::after {
            content: '';
            position: absolute;
            top: 8px;
            right: 20px;
            width: 8px;
            height: 8px;
            background: var(--error);
            border-radius: 50%;
            animation: pulse-dot 1.5s infinite;
        }
        
        @keyframes pulse-dot {
            0%, 100% {
                box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.7);
            }
            50% {
                box-shadow: 0 0 0 6px rgba(239, 68, 68, 0);
            }
        }
        
        /* Toast */
        #toast-notification {
            position: fixed;
            bottom: 120px;
            left: 50%;
            transform: translateX(-50%) translateY(200px);
            background: var(--card-bg);
            color: var(--text);
            padding: 16px 24px;
            border-radius: var(--radius-md);
            box-shadow: var(--shadow-lg);
            border: 1px solid var(--border);
            z-index: 1001;
            transition: transform 0.4s cubic-bezier(0.68, -0.55, 0.265, 1.55);
            max-width: 90%;
            display: flex;
            align-items: center;
            gap: 12px;
        }
        
        #toast-notification.show {
            transform: translateX(-50%) translateY(0);
        }
        
        #toast-notification.success {
            border-color: var(--success);
        }
        
        #toast-notification.error {
            border-color: var(--error);
        }
        
        .toast-icon {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .toast-icon.success {
            background: var(--success);
        }
        
        .toast-icon.error {
            background: var(--error);
        }
        
        /* Loader */
        #loader {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(15, 23, 42, 0.9);
            backdrop-filter: blur(8px);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 9999;
        }
        
        .spinner {
            width: 60px;
            height: 60px;
            border: 4px solid rgba(139, 92, 246, 0.2);
            border-top-color: var(--primary);
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        /* Table */
        .table-wrapper {
            overflow-x: auto;
            border-radius: var(--radius-md);
            border: 1px solid var(--border);
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
        }
        
        thead {
            background: rgba(139, 92, 246, 0.1);
        }
        
        th {
            padding: 12px 16px;
            text-align: left;
            font-weight: 600;
            color: var(--primary);
            font-size: 13px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        td {
            padding: 12px 16px;
            border-top: 1px solid var(--border);
        }
        
        tr:hover {
            background: rgba(139, 92, 246, 0.05);
        }
        
        .action-buttons {
            display: flex;
            gap: 8px;
        }
        
        /* Shift Toggle */
        .shift-toggle {
            display: flex;
            gap: 8px;
            background: rgba(139, 92, 246, 0.1);
            padding: 4px;
            border-radius: var(--radius-sm);
        }
        
        .shift-toggle input[type="radio"] {
            display: none;
        }
        
        .shift-toggle label {
            flex: 1;
            padding: 8px 16px;
            text-align: center;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 500;
            color: var(--text-muted);
        }
        
        .shift-toggle input[type="radio"]:checked + label {
            background: var(--primary);
            color: white;
        }
        
        /* Utilities */
        .hidden {
            display: none !important;
        }
        
        .text-center {
            text-align: center;
        }
        
        .mt-1 { margin-top: 0.5rem; }
        .mt-2 { margin-top: 1rem; }
        .mt-3 { margin-top: 1.5rem; }
        .mb-1 { margin-bottom: 0.5rem; }
        .mb-2 { margin-bottom: 1rem; }
        .mb-3 { margin-bottom: 1.5rem; }
        
        /* Responsive */
        @media (max-width: 768px) {
            main {
                padding: 1rem;
            }
            
            .card {
                padding: 1.5rem;
            }
            
            .hero-title {
                font-size: 32px;
            }
            
            .stats-grid {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .food-options {
                grid-template-columns: 1fr;
            }
            
            .nav-item span {
                display: none;
            }
            
            #tab-bar {
                width: calc(100% - 1rem);
            }
        }
        
        @media (min-width: 769px) {
            #app {
                padding: 2rem;
            }
            
            header {
                border-radius: var(--radius-lg);
                margin-bottom: 2rem;
            }
        }
    </style>
</head>
<body>
    <div id="app">
        <header>
            <div id="user-profile" class="user-profile">
                <h1 style="font-size: 24px; font-weight: 800; background: var(--gradient-1); -webkit-background-clip: text; -webkit-text-fill-color: transparent;">Inbold Menu</h1>
            </div>
            <div class="header-actions">
                <button id="lang-toggle-btn" class="icon-btn hidden"></button>
            </div>
        </header>

        <main id="main-content"></main>
        
        <!-- Modals -->
        <div id="settings-modal" class="modal hidden">
            <div class="modal-content">
                <div class="modal-header">
                    <h2 class="modal-title">Cài đặt</h2>
                    <button id="close-settings-btn" class="close-btn"><i class="fas fa-times"></i></button>
                </div>
                <div class="form-group">
                    <label class="form-label">Phòng ban</label>
                    <select id="department-select" class="form-select"></select>
                </div>
                <div class="form-group">
                    <label class="form-label">Loại ca</label>
                    <div class="shift-toggle">
                        <input type="radio" id="shift-m" name="shift-type" value="M" checked>
                        <label for="shift-m">Ca sáng</label>
                        <input type="radio" id="shift-e" name="shift-type" value="E">
                        <label for="shift-e">Ca chiều</label>
                    </div>
                </div>
                <button id="save-settings-btn" class="btn btn-primary btn-block">Lưu thay đổi</button>
            </div>
        </div>
        
        <div id="personnel-modal" class="modal hidden">
            <div class="modal-content">
                <div class="modal-header">
                    <h2 id="personnel-modal-title" class="modal-title">Thêm nhân viên</h2>
                    <button id="close-personnel-modal-btn" class="close-btn"><i class="fas fa-times"></i></button>
                </div>
                <input type="hidden" id="personnel-original-email-key">
                <div class="form-group">
                    <label class="form-label">Tên</label>
                    <input type="text" id="personnel-name-input" class="form-input">
                </div>
                <div class="form-group">
                    <label class="form-label">Email</label>
                    <input type="email" id="personnel-email-input" class="form-input">
                </div>
                <div class="form-group">
                    <label class="form-label">Phòng ban</label>
                    <select id="personnel-depart-select" class="form-select"></select>
                </div>
                <button id="save-personnel-btn" class="btn btn-primary btn-block">Lưu</button>
            </div>
        </div>
        
        <div id="reopen-order-modal" class="modal hidden">
            <div class="modal-content">
                <div class="modal-header">
                    <h2 id="reopen-order-modal-title" class="modal-title"></h2>
                    <button id="close-reopen-order-modal-btn" class="close-btn"><i class="fas fa-times"></i></button>
                </div>
                <p style="color: var(--text-muted); margin-bottom: 1.5rem;">Thao tác này sẽ xóa mọi dữ liệu đặt món của người này trong tuần, cho phép họ đặt lại. Bạn có chắc chắn?</p>
                <button id="confirm-reopen-order-btn" class="btn btn-danger btn-block">Xác nhận Mở lại</button>
            </div>
        </div>
        
        <div id="delete-personnel-modal" class="modal hidden">
            <div class="modal-content">
                <div class="modal-header">
                    <h2 class="modal-title">Xóa nhân viên</h2>
                    <button id="close-delete-personnel-modal-btn" class="close-btn"><i class="fas fa-times"></i></button>
                </div>
                <p id="delete-personnel-text" style="color: var(--text-muted); margin-bottom: 1.5rem;"></p>
                <div style="display: flex; gap: 12px;">
                    <button id="cancel-delete-personnel-btn" class="btn btn-secondary" style="flex: 1;">Hủy</button>
                    <button id="confirm-delete-personnel-btn" class="btn btn-danger" style="flex: 1;">Xóa</button>
                </div>
            </div>
        </div>

        <nav id="tab-bar" class="hidden"></nav>
        <div id="toast-notification"></div>
        <div id="loader" class="hidden"><div class="spinner"></div></div>
    </div>
    
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getFirestore, doc, getDoc, setDoc, updateDoc, deleteField } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
        import { getAuth, GoogleAuthProvider, signInWithPopup, signOut, onAuthStateChanged, browserLocalPersistence, setPersistence } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";

        const firebaseConfig = {
            apiKey: "AIzaSyCDrCaGUyr9xLkT-xOqzFd9grp6tN2u7Zo",
            authDomain: "hp-orders.firebaseapp.com",
            projectId: "hp-orders",
            storageBucket: "hp-orders.appspot.com",
            messagingSenderId: "616722831059",
            appId: "1:616722831059:web:9d19988d87397e7c13e626"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);
        const provider = new GoogleAuthProvider();
        
        const ADMIN_EMAILS = ['tri.vu.trong@inbold.com', 'truc.tran@inbold.com'];
        const FOOD_ICONS = ['🍜', '🍲', '🥘', '🍛', '🍝', '🥗', '🍱', '🍣', '🥙', '🌮'];

        const elements = {
            mainContent: document.getElementById('main-content'),
            tabBar: document.getElementById('tab-bar'),
            loader: document.getElementById('loader'),
            userProfileDiv: document.getElementById('user-profile'),
            langToggleBtn: document.getElementById('lang-toggle-btn'),
            settingsModal: document.getElementById('settings-modal'),
            personnelModal: document.getElementById('personnel-modal'),
            reopenOrderModal: document.getElementById('reopen-order-modal'),
            deletePersonnelModal: document.getElementById('delete-personnel-modal'),
            toast: document.getElementById('toast-notification'),
        };

        const state = {
            currentUser: null,
            staffProfile: null,
            isAdmin: false,
            currentTab: 'today',
            adminSubTab: 'support',
            authReady: false,
            menuFilterMode: 'auto',
            orderSelection: { mon: null, tue: null, wed: null, thu: null, fri: null },
            reopenTarget: { key: null, name: null },
            deleteTarget: { key: null, name: null },
            cachedData: new Map(),
            statsViewMode: 'day',
            statsViewDate: new Date(),
        };

        // Utility Functions
        const getWeekString = (date) => {
            const d = new Date(date);
            d.setHours(0, 0, 0, 0);
            d.setDate(d.getDate() + 4 - (d.getDay() || 7));
            const yearStart = new Date(d.getFullYear(), 0, 1);
            const weekNo = Math.ceil((((d - yearStart) / 86400000) + 1) / 7);
            return `${d.getFullYear()}_${weekNo}`;
        };

        const getDayKey = (date = new Date()) => ['sun', 'mon', 'tue', 'wed', 'thu', 'fri', 'sat'][date.getDay()];
        const showLoader = () => elements.loader.classList.remove('hidden');
        const hideLoader = () => elements.loader.classList.add('hidden');
        const emailToKey = (email) => email.replace(/[.@]/g, '_');

        const parseDish = (dishString) => {
            if (!dishString) return '';
            const parts = dishString.split('|');
            const lang = state.staffProfile?.lan || 'vi';
            return (lang.startsWith('en') && parts.length > 1) ? parts[1].trim() : parts[0].trim();
        };

        const showToast = (message, type = 'success') => {
            const iconMap = {
                success: '<i class="fas fa-check"></i>',
                error: '<i class="fas fa-times"></i>',
                info: '<i class="fas fa-info"></i>'
            };
            elements.toast.innerHTML = `
                <div class="toast-icon ${type}">${iconMap[type]}</div>
                <span>${message}</span>
            `;
            elements.toast.className = `show ${type}`;
            setTimeout(() => {
                elements.toast.classList.remove('show');
            }, 3000);
        };

        const getInitials = (name) => {
            return name.split(' ').map(n => n[0]).join('').toUpperCase().slice(0, 2);
        };

        const getFoodIcon = (index) => {
            return FOOD_ICONS[index % FOOD_ICONS.length];
        };

        async function getDocument(collection, documentId, forceRefresh = false) {
            const cacheKey = `${collection}/${documentId}`;
            if (!forceRefresh && state.cachedData.has(cacheKey)) {
                return state.cachedData.get(cacheKey);
            }
            const docRef = doc(db, collection, documentId);
            const docSnap = await getDoc(docRef);
            const data = docSnap.exists() ? docSnap.data() : null;
            state.cachedData.set(cacheKey, data);
            return data;
        }

        async function render() {
            if (!state.authReady || !state.staffProfile) {
                hideLoader();
                return;
            }
            showLoader();
            try {
                switch (state.currentTab) {
                    case 'today':
                        await renderToday();
                        break;
                    case 'menu':
                        await renderMenu();
                        break;
                    case 'order':
                        await renderOrder();
                        break;
                    case 'admin':
                        await renderAdmin();
                        break;
                }
            } catch (error) {
                console.error('Render error:', error);
                elements.mainContent.innerHTML = `
                    <div class="card">
                        <p style="color: var(--error); text-align: center;">
                            <i class="fas fa-exclamation-circle"></i> 
                            Có lỗi xảy ra khi tải dữ liệu.
                        </p>
                    </div>
                `;
            }
            hideLoader();
        }

        async function renderToday() {
            const dayKey = getDayKey();
            const firstName = state.staffProfile.name.split(' ')[0];
            
            if (['sun', 'sat'].includes(dayKey)) {
                elements.mainContent.innerHTML = `
                    <div class="card hero-card">
                        <div class="hero-content">
                            <div class="hero-greeting">Chào ${firstName} 👋</div>
                            <div class="hero-title">Cuối tuần vui vẻ!</div>
                            <div class="hero-subtitle">Hôm nay không phục vụ bữa ăn</div>
                        </div>
                    </div>
                `;
                return;
            }

            const weekString = getWeekString(new Date());
            const dayData = await getDocument(weekString, dayKey, true);
            const userEmailKey = emailToKey(state.currentUser.email);

            if (dayData && dayData[userEmailKey]) {
                const userOrder = dayData[userEmailKey];
                const dishName = parseDish(userOrder.food);
                elements.mainContent.innerHTML = `
                    <div class="card hero-card">
                        <div class="hero-content">
                            <div class="hero-greeting">Chào ${firstName} 👋</div>
                            <div class="hero-title">${dishName}</div>
                            <div class="hero-subtitle">Hôm nay bạn ăn món này</div>
                        </div>
                    </div>
                `;
            } else {
                elements.mainContent.innerHTML = `
                    <div class="card hero-card">
                        <div class="hero-content">
                            <div class="hero-greeting">Chào ${firstName} 👋</div>
                            <div class="hero-title">Chưa có món</div>
                            <div class="hero-subtitle">Bạn chưa đặt món cho hôm nay</div>
                        </div>
                    </div>
                `;
            }
        }

        async function renderMenu() {
            const dayKey = getDayKey();
            const weekString = getWeekString(new Date());
            const dayData = await getDocument(weekString, dayKey, true);

            let content = `
                <div class="card">
                    <div class="card-header">
                        <h2 class="card-title">Danh sách hôm nay</h2>
                        <button id="menu-filter-btn" class="icon-btn">
                            <i class="fas fa-filter"></i>
                        </button>
                    </div>
                    <div class="search-bar">
                        <div class="search-wrapper">
                            <i class="fas fa-search search-icon"></i>
                            <input type="text" id="search-staff" class="search-input" placeholder="Tìm kiếm nhân viên...">
                        </div>
                    </div>
                    <div id="staff-list-container"></div>
                </div>
            `;

            elements.mainContent.innerHTML = content;

            if (dayData) {
                updateStaffListView(dayData);
                document.getElementById('search-staff').addEventListener('input', (e) => {
                    updateStaffListView(dayData, e.target.value);
                });
            } else {
                document.getElementById('staff-list-container').innerHTML = `
                    <p class="text-center" style="color: var(--text-muted); padding: 2rem;">
                        Chưa có dữ liệu cho hôm nay
                    </p>
                `;
            }
        }

        function updateStaffListView(dayData, searchTerm = '') {
            const container = document.getElementById('staff-list-container');
            const filterBtn = document.getElementById('menu-filter-btn');
            const hour = new Date().getHours();

            const staffOrders = Object.entries(dayData)
                .map(([emailKey, order]) => ({ emailKey, ...order }))
                .filter(o => o.name && o.name.toLowerCase().includes(searchTerm.toLowerCase()));

            filterBtn.innerHTML = state.menuFilterMode === 'auto' 
                ? `<i class="fas ${hour < 15 ? 'fa-sun' : 'fa-moon'}"></i>`
                : `<i class="fas fa-users"></i>`;

            const createListHTML = (list) => {
                return list
                    .sort((a, b) => (a.status === 'eaten' ? 1 : -1) || a.name.localeCompare(b.name))
                    .map(order => `
                        <li class="staff-item ${order.status === 'eaten' ? 'eaten' : ''}">
                            <div class="staff-avatar">${getInitials(order.name)}</div>
                            <div class="staff-details">
                                <div class="staff-name">${order.name}</div>
                                <div class="staff-dish">${parseDish(order.food)}</div>
                            </div>
                        </li>
                    `).join('');
            };

            const sang = staffOrders.filter(o => o.shift === 'M');
            const chieu = staffOrders.filter(o => o.shift === 'E');

            let html = '<ul class="staff-list">';
            
            if ((state.menuFilterMode === 'auto' && hour < 15) || state.menuFilterMode === 'all') {
                if (sang.length > 0) {
                    html += `<h3 style="color: var(--primary); padding: 1rem 0 0.5rem; font-size: 18px;">☀️ Ca sáng</h3>${createListHTML(sang)}`;
                }
            }
            
            if ((state.menuFilterMode === 'auto' && hour >= 15) || state.menuFilterMode === 'all') {
                if (chieu.length > 0) {
                    html += `<h3 style="color: var(--primary); padding: 1rem 0 0.5rem; font-size: 18px;">🌙 Ca chiều</h3>${createListHTML(chieu)}`;
                }
            }
            
            html += '</ul>';

            container.innerHTML = html || `<p class="text-center" style="color: var(--text-muted); padding: 2rem;">Không tìm thấy kết quả</p>`;
        }

        async function renderOrder() {
            const today = new Date();
            const dayOfWeek = today.getDay();
            const targetWeek = (dayOfWeek >= 4 || dayOfWeek === 0) 
                ? getWeekString(new Date(today.getTime() + 7 * 24 * 60 * 60 * 1000))
                : getWeekString(today);

            const userEmailKey = emailToKey(state.currentUser.email);
            const userOrdersForMon = await getDocument(targetWeek, 'mon');

            // Check if user already ordered
            if (userOrdersForMon && userOrdersForMon[userEmailKey]) {
                const days = { mon: "Thứ 2", tue: "Thứ 3", wed: "Thứ 4", thu: "Thứ 5", fri: "Thứ 6" };
                let summaryHTML = `
                    <div class="card">
                        <div class="card-header">
                            <h2 class="card-title">Đã đặt món tuần ${targetWeek.split('_')[1]}</h2>
                        </div>
                        <ul class="staff-list">
                `;

                for (const [key, name] of Object.entries(days)) {
                    const dayData = await getDocument(targetWeek, key);
                    const dish = dayData?.[userEmailKey]?.food;
                    summaryHTML += `
                        <li class="staff-item">
                            <div class="staff-avatar">${name.slice(-1)}</div>
                            <div class="staff-details">
                                <div class="staff-name">${name}</div>
                                <div class="staff-dish">${parseDish(dish) || 'Chưa đặt'}</div>
                            </div>
                        </li>
                    `;
                }

                elements.mainContent.innerHTML = summaryHTML + `</ul></div>`;
                return;
            }

            // Show order form
            const menu = await getDocument(targetWeek, "menu");
            if (!menu) {
                elements.mainContent.innerHTML = `
                    <div class="card">
                        <div class="text-center">
                            <i class="fas fa-calendar-times" style="font-size: 48px; color: var(--text-muted); margin-bottom: 1rem;"></i>
                            <p style="color: var(--text-muted);">Thực đơn cho tuần này chưa được cập nhật</p>
                        </div>
                    </div>
                `;
                return;
            }

            const days = { mon: "Thứ 2", tue: "Thứ 3", wed: "Thứ 4", thu: "Thứ 5", fri: "Thứ 6" };
            
            elements.mainContent.innerHTML = `
                <div class="card">
                    <div class="card-header">
                        <h2 class="card-title">Đặt món tuần ${targetWeek.split('_')[1]}</h2>
                    </div>
                    <div class="tabs" id="day-tabs">
                        ${Object.keys(days).map((key, i) => `
                            <button class="tab-btn ${i === 0 ? 'active' : ''}" data-day="${key}">
                                ${days[key]}
                            </button>
                        `).join('')}
                    </div>
                    <div id="order-form-content"></div>
                    <button id="submit-order-btn" class="btn btn-primary btn-block mt-3" disabled>
                        <i class="fas fa-check-circle"></i>
                        Hoàn tất đặt món
                    </button>
                </div>
            `;

            renderDayOptions(Object.keys(days)[0], menu);

            // Add day tab listeners
            document.querySelectorAll('#day-tabs .tab-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    document.querySelectorAll('#day-tabs .tab-btn').forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');
                    renderDayOptions(btn.dataset.day, menu);
                });
            });
        }

        function renderDayOptions(dayKey, menu) {
            const dishes = menu[dayKey]?.split(',').map(d => d.trim()).filter(d => d) || [];
            const content = document.getElementById('order-form-content');
            
            content.innerHTML = `
                <div class="food-options">
                    ${dishes.map((dish, index) => `
                        <div class="food-option ${state.orderSelection[dayKey] === dish ? 'selected' : ''}" 
                             data-dish="${dish}" data-day-key="${dayKey}">
                            <div class="food-icon">${getFoodIcon(index)}</div>
                            <div class="food-name">${parseDish(dish)}</div>
                        </div>
                    `).join('')}
                </div>
            `;

            // Check if all days are selected
            const allSelected = Object.values(state.orderSelection).every(dish => dish !== null);
            document.getElementById('submit-order-btn').disabled = !allSelected;
        }

        async function renderAdmin() {
            elements.mainContent.innerHTML = `
                <div class="card">
                    <div class="tabs">
                        <button class="tab-btn ${state.adminSubTab === 'support' ? 'active' : ''}" data-subtab="support">
                            <i class="fas fa-headset"></i> Hỗ trợ
                        </button>
                        <button class="tab-btn ${state.adminSubTab === 'stats' ? 'active' : ''}" data-subtab="stats">
                            <i class="fas fa-chart-bar"></i> Thống kê
                        </button>
                        <button class="tab-btn ${state.adminSubTab === 'menu' ? 'active' : ''}" data-subtab="menu">
                            <i class="fas fa-utensils"></i> Thực đơn
                        </button>
                        <button class="tab-btn ${state.adminSubTab === 'personnel' ? 'active' : ''}" data-subtab="personnel">
                            <i class="fas fa-users"></i> Nhân sự
                        </button>
                    </div>
                    <div id="admin-content"></div>
                </div>
            `;
            
            await renderAdminSubTab();
        }

        async function renderAdminSubTab() {
            switch (state.adminSubTab) {
                case 'support':
                    await renderAdminSupport();
                    break;
                case 'stats':
                    await renderAdminStats();
                    break;
                case 'menu':
                    await renderAdminMenu();
                    break;
                case 'personnel':
                    await renderAdminPersonnel();
                    break;
            }
        }

        async function renderAdminSupport() {
            const thisWeek = getWeekString(new Date());
            const [allStaff, monOrders] = await Promise.all([
                getDocument("staff_list", "staffs", true),
                getDocument(thisWeek, "mon")
            ]);

            let notOrderedList = [];
            if (allStaff) {
                for (const key in allStaff) {
                    if (key.startsWith('guest_')) continue;
                    if (!monOrders || !monOrders[key]) {
                        notOrderedList.push({ key, profile: allStaff[key] });
                    }
                }
            }

            notOrderedList.sort((a, b) => a.profile.name.localeCompare(b.profile.name));

            document.getElementById('admin-content').innerHTML = `
                <div class="mt-3">
                    <h3 style="color: var(--primary); margin-bottom: 1rem; font-size: 18px;">
                        <i class="fas fa-exclamation-circle"></i> 
                        Nhân viên chưa đặt món tuần này
                    </h3>
                    ${notOrderedList.length > 0 ? `
                        <ul class="staff-list">
                            ${notOrderedList.map(item => `
                                <li class="staff-item">
                                    <div class="staff-avatar">${getInitials(item.profile.name)}</div>
                                    <div class="staff-details">
                                        <div class="staff-name">${item.profile.name}</div>
                                        <div class="staff-dish">${item.profile.email}</div>
                                    </div>
                                    <button class="btn btn-secondary reopen-order-btn" data-key="${item.key}" data-name="${item.profile.name}">
                                        <i class="fas fa-redo"></i>
                                    </button>
                                </li>
                            `).join('')}
                        </ul>
                    ` : `
                        <p class="text-center" style="color: var(--text-muted); padding: 2rem;">
                            <i class="fas fa-check-circle" style="font-size: 48px; margin-bottom: 1rem; display: block;"></i>
                            Mọi người đã đặt món đủ!
                        </p>
                    `}
                </div>
            `;
        }

        async function renderAdminStats() {
            const content = document.getElementById('admin-content');
            
            content.innerHTML = `
                <div class="mt-3">
                    <div class="tabs">
                        <button class="tab-btn ${state.statsViewMode === 'day' ? 'active' : ''}" data-mode="day">Ngày</button>
                        <button class="tab-btn ${state.statsViewMode === 'week' ? 'active' : ''}" data-mode="week">Tuần</button>
                        <button class="tab-btn ${state.statsViewMode === 'month' ? 'active' : ''}" data-mode="month">Tháng</button>
                    </div>
                    <div id="stats-content" class="mt-3"></div>
                    <button id="export-stats-btn" class="btn btn-primary btn-block mt-3">
                        <i class="fas fa-file-excel"></i>
                        Tải về XLSX
                    </button>
                </div>
            `;

            await renderStatsContent();
        }

        async function renderStatsContent() {
            const statsContent = document.getElementById('stats-content');
            
            if (state.statsViewMode === 'day') {
                const dayKey = getDayKey(state.statsViewDate);
                const weekString = getWeekString(state.statsViewDate);
                const dayData = await getDocument(weekString, dayKey);

                if (!dayData) {
                    statsContent.innerHTML = `<p class="text-center" style="color: var(--text-muted);">Không có dữ liệu</p>`;
                    return;
                }

                const stats = {};
                Object.values(dayData).forEach(order => {
                    const dish = parseDish(order.food);
                    stats[dish] = (stats[dish] || 0) + 1;
                });

                statsContent.innerHTML = `
                    <div class="stats-grid">
                        ${Object.entries(stats).map(([dish, count], index) => `
                            <div class="stat-card">
                                <div class="stat-icon ${['purple', 'blue', 'pink', 'green'][index % 4]}">
                                    ${getFoodIcon(index)}
                                </div>
                                <div class="stat-value">${count}</div>
                                <div class="stat-label">${dish}</div>
                            </div>
                        `).join('')}
                    </div>
                `;
            } else {
                statsContent.innerHTML = `<p class="text-center" style="color: var(--text-muted);">Chức năng đang được xây dựng</p>`;
            }
        }

        async function renderAdminMenu() {
            const today = new Date();
            const dayOfWeek = today.getDay();
            const nextWeek = getWeekString(new Date(today.getTime() + 7 * 24 * 60 * 60 * 1000));
            const menuData = await getDocument(nextWeek, "menu") || {};
            const isEditable = dayOfWeek >= 1 && dayOfWeek <= 4;
            const days = { mon: "Thứ 2", tue: "Thứ 3", wed: "Thứ 4", thu: "Thứ 5", fri: "Thứ 6" };

            let formHTML = '';
            for (const [key, name] of Object.entries(days)) {
                formHTML += `
                    <div class="form-group">
                        <label class="form-label">${name}</label>
                        <textarea id="menu-input-${key}" class="form-textarea" rows="3" ${!isEditable ? 'disabled' : ''}>${menuData[key] || ''}</textarea>
                    </div>
                `;
            }

            document.getElementById('admin-content').innerHTML = `
                <div class="mt-3">
                    <h3 style="color: var(--primary); margin-bottom: 1rem;">Chỉnh sửa thực đơn tuần sau</h3>
                    <div class="form-group">
                        <label class="form-label">Tuần</label>
                        <input type="text" class="form-input" value="${nextWeek}" disabled>
                    </div>
                    ${formHTML}
                    <button id="save-menu-btn" class="btn ${isEditable ? 'btn-primary' : 'btn-secondary'} btn-block" ${!isEditable ? 'disabled' : ''}>
                        <i class="fas ${isEditable ? 'fa-save' : 'fa-lock'}"></i>
                        ${isEditable ? 'Lưu Thực đơn' : 'Đã khóa chỉnh sửa'}
                    </button>
                </div>
            `;
        }

        async function renderAdminPersonnel() {
            const allStaff = await getDocument("staff_list", "staffs", true);
            let tableRows = '';

            if (allStaff) {
                const sorted = Object.entries(allStaff).sort((a, b) => a[1].name.localeCompare(b[1].name));
                tableRows = sorted.map(([key, profile]) => `
                    <tr>
                        <td>
                            <div style="display: flex; align-items: center; gap: 12px;">
                                <div class="staff-avatar" style="width: 32px; height: 32px; font-size: 12px;">
                                    ${getInitials(profile.name)}
                                </div>
                                <span>${profile.name}</span>
                            </div>
                        </td>
                        <td>${profile.email}</td>
                        <td>${profile.depart || '-'}</td>
                        <td>
                            <div class="action-buttons">
                                <button class="icon-btn edit-personnel-btn" data-key="${key}">
                                    <i class="fas fa-edit"></i>
                                </button>
                                <button class="icon-btn delete-personnel-btn" data-key="${key}" data-name="${profile.name}">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </td>
                    </tr>
                `).join('');
            }

            document.getElementById('admin-content').innerHTML = `
                <div class="mt-3">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
                        <h3 style="color: var(--primary); font-size: 18px;">Quản lý nhân sự</h3>
                        <div style="display: flex; gap: 8px;">
                            <button id="add-personnel-btn" class="icon-btn">
                                <i class="fas fa-plus"></i>
                            </button>
                            <button id="export-personnel-btn" class="icon-btn">
                                <i class="fas fa-file-excel"></i>
                            </button>
                        </div>
                    </div>
                    <div class="table-wrapper">
                        <table>
                            <thead>
                                <tr>
                                    <th>Tên</th>
                                    <th>Email</th>
                                    <th>Phòng ban</th>
                                    <th style="width: 120px;">Thao tác</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${tableRows || '<tr><td colspan="4" class="text-center" style="color: var(--text-muted);">Chưa có dữ liệu</td></tr>'}
                            </tbody>
                        </table>
                    </div>
                </div>
            `;
        }

        async function syncUserProfile() {
            const user = state.currentUser;
            const userEmailKey = emailToKey(user.email);
            const staffData = await getDocument("staff_list", "staffs", true);

            if (!staffData || !staffData[userEmailKey]) {
                await signOut(auth);
                throw new Error("Tài khoản của bạn không có trong danh sách được phép.");
            }

            state.staffProfile = staffData[userEmailKey];
            state.isAdmin = ADMIN_EMAILS.includes(user.email);
        }

        function updateUIForUser(user) {
            if (user && state.staffProfile) {
                elements.userProfileDiv.innerHTML = `
                    <div class="user-profile">
                        <img src="${user.photoURL}" alt="avatar" class="user-avatar">
                        <div class="user-info">
                            <h2>${state.staffProfile.name}</h2>
                            <p id="logout-btn" style="cursor: pointer;">Đăng xuất</p>
                        </div>
                    </div>
                `;

                elements.langToggleBtn.textContent = (state.staffProfile.lan || 'vi').toUpperCase();
                elements.langToggleBtn.classList.remove('hidden');

                let tabBarHTML = `
                    <button class="nav-item active" data-tab="today">
                        <i class="fas fa-home"></i>
                        <span>Hôm Nay</span>
                    </button>
                    <button class="nav-item" data-tab="menu">
                        <i class="fas fa-list"></i>
                        <span>Thực đơn</span>
                    </button>
                    <button class="nav-item" data-tab="order">
                        <i class="fas fa-shopping-cart"></i>
                        <span>Đặt Món</span>
                    </button>
                `;

                if (state.isAdmin) {
                    tabBarHTML += `
                        <button class="nav-item" data-tab="admin">
                            <i class="fas fa-crown"></i>
                            <span>Admin</span>
                        </button>
                    `;
                }

                elements.tabBar.innerHTML = tabBarHTML;
                elements.tabBar.classList.remove('hidden');
            } else {
                elements.userProfileDiv.innerHTML = `
                    <h1 style="font-size: 24px; font-weight: 800; background: var(--gradient-1); -webkit-background-clip: text; -webkit-text-fill-color: transparent;">
                        Inbold Menu
                    </h1>
                `;
                elements.langToggleBtn.classList.add('hidden');
                elements.tabBar.classList.add('hidden');
                elements.mainContent.innerHTML = `
                    <div class="card hero-card">
                        <div class="hero-content">
                            <div class="hero-title">Chào mừng! 👋</div>
                            <div class="hero-subtitle" style="margin-bottom: 2rem;">Vui lòng đăng nhập bằng tài khoản công ty</div>
                            <button id="login-btn" class="btn btn-primary">
                                <i class="fab fa-google"></i>
                                Đăng nhập bằng Google
                            </button>
                        </div>
                    </div>
                `;
            }
        }

        // Event Listeners
        document.body.addEventListener('click', async (e) => {
            const target = e.target.closest('button, .user-profile');
            if (!target) return;

            // Login
            if (target.id === 'login-btn' || target.closest('#login-btn')) {
                showLoader();
                try {
                    await signInWithPopup(auth, provider);
                } catch (err) {
                    console.error('Login error:', err);
                    showToast('Đăng nhập thất bại. Tài khoản của bạn có thể không được phép.', 'error');
                    hideLoader();
                }
                return;
            }

            // Logout
            if (target.id === 'logout-btn' || target.closest('#logout-btn')) {
                if (confirm('Bạn có chắc muốn đăng xuất?')) {
                    await signOut(auth);
                    showToast('Đã đăng xuất thành công');
                }
                return;
            }

            // User profile click - open settings
            if (target.classList.contains('user-profile')) {
                const profile = state.staffProfile;
                const departsData = await getDocument('staff_list', 'departs');
                const departSelect = document.getElementById('department-select');
                
                if (departsData) {
                    departSelect.innerHTML = (departsData.list || [])
                        .map(d => `<option value="${d}" ${d === profile.depart ? 'selected' : ''}>${d}</option>`)
                        .join('') + `<option value="${departsData.guest || 'Khách'}" ${departsData.guest === profile.depart ? 'selected' : ''}>${departsData.guest || 'Khách'}</option>`;
                }
                
                document.querySelector(`input[name="shift-type"][value="${profile.shift}"]`).checked = true;
                elements.settingsModal.classList.remove('hidden');
                return;
            }

            // Tab Navigation
            if (target.classList.contains('nav-item')) {
                const tab = target.dataset.tab;
                if (tab === state.currentTab) return;
                
                document.querySelectorAll('.nav-item').forEach(item => item.classList.remove('active'));
                target.classList.add('active');
                state.currentTab = tab;
                await render();
                return;
            }

            // Admin Sub Tabs
            if (target.dataset.subtab) {
                state.adminSubTab = target.dataset.subtab;
                document.querySelectorAll('[data-subtab]').forEach(btn => btn.classList.remove('active'));
                target.classList.add('active');
                await renderAdminSubTab();
                return;
            }

            // Stats mode tabs
            if (target.dataset.mode) {
                state.statsViewMode = target.dataset.mode;
                document.querySelectorAll('[data-mode]').forEach(btn => btn.classList.remove('active'));
                target.classList.add('active');
                await renderStatsContent();
                return;
            }

            // Add dish to menu
            const addDishBtn = target.closest('.add-dish-btn');
            if (addDishBtn) {
                const day = addDishBtn.dataset.day;
                const container = document.getElementById(`dish-list-${day}`);
                const newGroup = document.createElement('div');
                newGroup.className = 'menu-dish-input-group';
                newGroup.innerHTML = `
                    <input type="text" class="form-input menu-dish-input" data-day="${day}" placeholder="Món ăn|Dish name">
                    <button class="icon-btn remove-dish-btn">
                        <i class="fas fa-minus"></i>
                    </button>
                `;
                container.appendChild(newGroup);
                return;
            }

            // Remove dish from menu
            const removeDishBtn = target.closest('.remove-dish-btn');
            if (removeDishBtn) {
                removeDishBtn.parentElement.remove();
                return;
            }

            // Admin: Save Menu
            if (target.id === 'save-menu-btn') {
                showLoader();
                try {
                    const today = new Date();
                    const nextWeek = getWeekString(new Date(today.getTime() + 7 * 24 * 60 * 60 * 1000));
                    const days = ['mon', 'tue', 'wed', 'thu', 'fri'];
                    const menuData = {};
                    
                    days.forEach(day => {
                        const dishes = [...document.querySelectorAll(`.menu-dish-input[data-day="${day}"]`)]
                            .map(input => input.value.trim())
                            .filter(dish => dish);
                        menuData[day] = dishes.join(', ');
                    });
                    
                    await setDoc(doc(db, nextWeek, "menu"), menuData);
                    state.cachedData.delete(`${nextWeek}/menu`);
                    showToast('Lưu thực đơn thành công!');
                } catch (error) {
                    showToast('Lưu thực đơn thất bại', 'error');
                    console.error(error);
                }
                hideLoader();
                return;
            }

            // Export Stats
            if (target.id === 'export-stats-btn' || target.closest('#export-stats-btn')) {
                showLoader();
                try {
                    const dateString = state.statsViewDate || new Date().toISOString().split('T')[0];
                    
                    if (state.statsViewMode === 'day') {
                        const date = new Date(dateString);
                        const week = getWeekString(date);
                        const day = getDayKey(date);
                        const data = await getDocument(week, day);
                        
                        if (!data) {
                            showToast('Không có dữ liệu để xuất', 'error');
                            hideLoader();
                            return;
                        }
                        
                        const exportData = Object.entries(data).map(([key, order]) => ({
                            'Tên': order.name,
                            'Email': order.email,
                            'Món ăn': parseDish(order.food),
                            'Ca': order.shift === 'M' ? 'Sáng' : 'Chiều',
                            'Phòng ban': order.depart,
                        }));
                        
                        const ws = XLSX.utils.json_to_sheet(exportData);
                        const wb = XLSX.utils.book_new();
                        XLSX.utils.book_append_sheet(wb, ws, "Thống kê");
                        XLSX.writeFile(wb, `thong-ke-${week}-${day}.xlsx`);
                    } else if (state.statsViewMode === 'week') {
                        const date = new Date(dateString);
                        const week = getWeekString(date);
                        const days = ['mon', 'tue', 'wed', 'thu', 'fri'];
                        
                        const weekData = await Promise.all(days.map(day => getDocument(week, day)));
                        const allOrders = [];
                        
                        weekData.forEach((dayData, index) => {
                            if (!dayData) return;
                            const dayName = ['Thứ 2', 'Thứ 3', 'Thứ 4', 'Thứ 5', 'Thứ 6'][index];
                            Object.entries(dayData).forEach(([key, order]) => {
                                allOrders.push({
                                    'Ngày': dayName,
                                    'Tên': order.name,
                                    'Email': order.email,
                                    'Món ăn': parseDish(order.food),
                                    'Ca': order.shift === 'M' ? 'Sáng' : 'Chiều',
                                    'Phòng ban': order.depart,
                                });
                            });
                        });
                        
                        const ws = XLSX.utils.json_to_sheet(allOrders);
                        const wb = XLSX.utils.book_new();
                        XLSX.utils.book_append_sheet(wb, ws, "Thống kê tuần");
                        XLSX.writeFile(wb, `thong-ke-tuan-${week}.xlsx`);
                    }
                    
                    showToast('Đã tải về file Excel');
                } catch (error) {
                    showToast('Xuất file thất bại', 'error');
                    console.error(error);
                }
                hideLoader();
                return;
            }

            // Export Personnel (keep existing)
            if (target.id === 'export-personnel-btn' || target.closest('#export-personnel-btn')) {
                const allStaff = await getDocument("staff_list", "staffs", true);
                if (!allStaff) return;
                
                const data = Object.entries(allStaff).map(([key, profile]) => ({
                    'Tên': profile.name,
                    'Email': profile.email,
                    'Phòng ban': profile.depart,
                    'Ca': profile.shift === 'M' ? 'Sáng' : 'Chiều',
                    'Ngôn ngữ': profile.lan
                }));
                
                const ws = XLSX.utils.json_to_sheet(data);
                const wb = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(wb, ws, "Nhân sự");
                XLSX.writeFile(wb, `nhan-su-${new Date().toISOString().split('T')[0]}.xlsx`);
                showToast('Đã tải về file Excel');
                return;
            }

            // Language Toggle
            if (target.id === 'lang-toggle-btn') {
                showLoader();
                try {
                    const newLang = state.staffProfile.lan === 'vi' ? 'en' : 'vi';
                    await updateDoc(doc(db, "staff_list", "staffs"), {
                        [`${emailToKey(state.currentUser.email)}.lan`]: newLang
                    });
                    state.staffProfile.lan = newLang;
                    state.cachedData.delete("staff_list/staffs");
                    elements.langToggleBtn.textContent = newLang.toUpperCase();
                    showToast(`Language switched to ${newLang.toUpperCase()}`);
                    await render();
                } catch (error) {
                    showToast('Language switch failed', 'error');
                }
                hideLoader();
                return;
            }

            // Menu Filter
            if (target.id === 'menu-filter-btn' || target.closest('#menu-filter-btn')) {
                state.menuFilterMode = state.menuFilterMode === 'auto' ? 'all' : 'auto';
                const dayKey = getDayKey();
                const weekString = getWeekString(new Date());
                const dayData = await getDocument(weekString, dayKey, true);
                if (dayData) updateStaffListView(dayData);
                return;
            }

            // Settings Modal
            if (target.id === 'close-settings-btn' || (target === elements.settingsModal && e.target === elements.settingsModal)) {
                elements.settingsModal.classList.add('hidden');
                return;
            }

            if (target.id === 'save-settings-btn') {
                showLoader();
                try {
                    const newProfile = {
                        ...state.staffProfile,
                        depart: document.getElementById('department-select').value,
                        shift: document.querySelector('input[name="shift-type"]:checked').value,
                    };
                    await updateDoc(doc(db, "staff_list", "staffs"), {
                        [emailToKey(state.currentUser.email)]: newProfile
                    });
                    state.staffProfile = newProfile;
                    state.cachedData.delete("staff_list/staffs");
                    elements.settingsModal.classList.add('hidden');
                    showToast('Cập nhật thành công!');
                } catch (error) {
                    showToast('Cập nhật thất bại', 'error');
                }
                hideLoader();
                return;
            }

            // Food Selection
            if (target.classList.contains('food-option') || target.closest('.food-option')) {
                const option = target.classList.contains('food-option') ? target : target.closest('.food-option');
                const dayKey = option.dataset.dayKey;
                const dish = option.dataset.dish;
                
                state.orderSelection[dayKey] = dish;
                
                // Re-render to update UI
                const menu = await getDocument(getWeekString(new Date()), "menu");
                renderDayOptions(dayKey, menu);
                return;
            }

            // Submit Order
            if (target.id === 'submit-order-btn') {
                showLoader();
                try {
                    const today = new Date();
                    const dayOfWeek = today.getDay();
                    const targetWeek = (dayOfWeek >= 4 || dayOfWeek === 0)
                        ? getWeekString(new Date(today.getTime() + 7 * 24 * 60 * 60 * 1000))
                        : getWeekString(today);

                    const userEmailKey = emailToKey(state.currentUser.email);
                    
                    for (const dayKey in state.orderSelection) {
                        const dayDocRef = doc(db, targetWeek, dayKey);
                        const updatePayload = {
                            [userEmailKey]: {
                                name: state.staffProfile.name,
                                email: state.currentUser.email,
                                food: state.orderSelection[dayKey],
                                status: 'not',
                                shift: state.staffProfile.shift,
                                depart: state.staffProfile.depart,
                            }
                        };
                        await setDoc(dayDocRef, updatePayload, { merge: true });
                        state.cachedData.delete(`${targetWeek}/${dayKey}`);
                    }

                    showToast('Đặt món thành công!');
                    state.orderSelection = { mon: null, tue: null, wed: null, thu: null, fri: null };
                    
                    // Switch to today tab
                    state.currentTab = 'today';
                    document.querySelectorAll('.nav-item').forEach(item => {
                        item.classList.toggle('active', item.dataset.tab === 'today');
                    });
                    await render();
                } catch (error) {
                    console.error('Order submission error:', error);
                    showToast('Đặt món thất bại', 'error');
                }
                hideLoader();
                return;
            }

            // Admin: Reopen Order
            if (target.classList.contains('reopen-order-btn') || target.closest('.reopen-order-btn')) {
                const btn = target.classList.contains('reopen-order-btn') ? target : target.closest('.reopen-order-btn');
                state.reopenTarget = { key: btn.dataset.key, name: btn.dataset.name };
                document.getElementById('reopen-order-modal-title').textContent = `Mở lại đặt món cho ${state.reopenTarget.name}?`;
                elements.reopenOrderModal.classList.remove('hidden');
                return;
            }

            if (target.id === 'close-reopen-order-modal-btn' || (target === elements.reopenOrderModal && e.target === elements.reopenOrderModal)) {
                elements.reopenOrderModal.classList.add('hidden');
                return;
            }

            if (target.id === 'confirm-reopen-order-btn') {
                showLoader();
                try {
                    const weekString = getWeekString(new Date());
                    const days = ['mon', 'tue', 'wed', 'thu', 'fri'];
                    
                    for (const day of days) {
                        const docRef = doc(db, weekString, day);
                        await updateDoc(docRef, { [state.reopenTarget.key]: deleteField() });
                        state.cachedData.delete(`${weekString}/${day}`);
                    }
                    
                    showToast(`Đã mở lại đặt món cho ${state.reopenTarget.name}`);
                    elements.reopenOrderModal.classList.add('hidden');
                    await renderAdmin();
                } catch (error) {
                    showToast('Có lỗi xảy ra', 'error');
                    console.error(error);
                }
                hideLoader();
                return;
            }

            // Admin: Save Menu
            if (target.id === 'save-menu-btn') {
                showLoader();
                try {
                    const today = new Date();
                    const nextWeek = getWeekString(new Date(today.getTime() + 7 * 24 * 60 * 60 * 1000));
                    const days = ['mon', 'tue', 'wed', 'thu', 'fri'];
                    const menuData = {};
                    
                    days.forEach(day => {
                        menuData[day] = document.getElementById(`menu-input-${day}`).value;
                    });
                    
                    await setDoc(doc(db, nextWeek, "menu"), menuData);
                    state.cachedData.delete(`${nextWeek}/menu`);
                    showToast('Lưu thực đơn thành công!');
                } catch (error) {
                    showToast('Lưu thực đơn thất bại', 'error');
                    console.error(error);
                }
                hideLoader();
                return;
            }

            // Admin: Add Personnel
            if (target.id === 'add-personnel-btn' || target.closest('#add-personnel-btn')) {
                document.getElementById('personnel-modal-title').textContent = 'Thêm nhân viên';
                document.getElementById('personnel-original-email-key').value = '';
                document.getElementById('personnel-name-input').value = '';
                document.getElementById('personnel-email-input').value = '';
                
                const departsData = await getDocument('staff_list', 'departs');
                const departSelect = document.getElementById('personnel-depart-select');
                if (departsData) {
                    departSelect.innerHTML = (departsData.list || [])
                        .map(d => `<option value="${d}">${d}</option>`)
                        .join('');
                }
                
                elements.personnelModal.classList.remove('hidden');
                return;
            }

            // Admin: Edit Personnel
            if (target.classList.contains('edit-personnel-btn') || target.closest('.edit-personnel-btn')) {
                const btn = target.classList.contains('edit-personnel-btn') ? target : target.closest('.edit-personnel-btn');
                const key = btn.dataset.key;
                const allStaff = await getDocument("staff_list", "staffs", true);
                const profile = allStaff[key];
                
                document.getElementById('personnel-modal-title').textContent = 'Sửa thông tin';
                document.getElementById('personnel-original-email-key').value = key;
                document.getElementById('personnel-name-input').value = profile.name;
                document.getElementById('personnel-email-input').value = profile.email;
                
                const departsData = await getDocument('staff_list', 'departs');
                const departSelect = document.getElementById('personnel-depart-select');
                if (departsData) {
                    departSelect.innerHTML = (departsData.list || [])
                        .map(d => `<option value="${d}" ${d === profile.depart ? 'selected' : ''}>${d}</option>`)
                        .join('');
                }
                
                elements.personnelModal.classList.remove('hidden');
                return;
            }

            // Admin: Delete Personnel
            if (target.classList.contains('delete-personnel-btn') || target.closest('.delete-personnel-btn')) {
                const btn = target.classList.contains('delete-personnel-btn') ? target : target.closest('.delete-personnel-btn');
                state.deleteTarget = { key: btn.dataset.key, name: btn.dataset.name };
                document.getElementById('delete-personnel-text').textContent = `Bạn có chắc muốn xóa nhân viên "${state.deleteTarget.name}"? Hành động này không thể hoàn tác.`;
                elements.deletePersonnelModal.classList.remove('hidden');
                return;
            }

            // Personnel Modal
            if (target.id === 'close-personnel-modal-btn' || (target === elements.personnelModal && e.target === elements.personnelModal)) {
                elements.personnelModal.classList.add('hidden');
                return;
            }

            if (target.id === 'save-personnel-btn') {
                showLoader();
                try {
                    const name = document.getElementById('personnel-name-input').value.trim();
                    const email = document.getElementById('personnel-email-input').value.trim();
                    const depart = document.getElementById('personnel-depart-select').value;
                    const originalKey = document.getElementById('personnel-original-email-key').value;
                    
                    if (!name || !email) {
                        showToast('Vui lòng điền đầy đủ thông tin', 'error');
                        hideLoader();
                        return;
                    }
                    
                    const newKey = emailToKey(email);
                    const staffRef = doc(db, "staff_list", "staffs");
                    const allStaff = await getDocument("staff_list", "staffs", true);
                    
                    // If editing and email changed, delete old entry
                    if (originalKey && originalKey !== newKey) {
                        delete allStaff[originalKey];
                    }
                    
                    allStaff[newKey] = {
                        name,
                        email,
                        depart,
                        shift: allStaff[newKey]?.shift || 'M',
                        lan: allStaff[newKey]?.lan || 'vi'
                    };
                    
                    await setDoc(staffRef, allStaff);
                    state.cachedData.delete("staff_list/staffs");
                    
                    elements.personnelModal.classList.add('hidden');
                    showToast(originalKey ? 'Cập nhật thành công!' : 'Thêm nhân viên thành công!');
                    await renderAdminPersonnel();
                } catch (error) {
                    showToast('Có lỗi xảy ra', 'error');
                    console.error(error);
                }
                hideLoader();
                return;
            }

            // Delete Personnel Modal
            if (target.id === 'close-delete-personnel-modal-btn' || target.id === 'cancel-delete-personnel-btn' || (target === elements.deletePersonnelModal && e.target === elements.deletePersonnelModal)) {
                elements.deletePersonnelModal.classList.add('hidden');
                return;
            }

            if (target.id === 'confirm-delete-personnel-btn') {
                showLoader();
                try {
                    const staffRef = doc(db, "staff_list", "staffs");
                    await updateDoc(staffRef, { [state.deleteTarget.key]: deleteField() });
                    state.cachedData.delete("staff_list/staffs");
                    
                    elements.deletePersonnelModal.classList.add('hidden');
                    showToast('Đã xóa nhân viên');
                    await renderAdminPersonnel();
                } catch (error) {
                    showToast('Có lỗi xảy ra', 'error');
                    console.error(error);
                }
                hideLoader();
                return;
            }

            // Export Personnel
            if (target.id === 'export-personnel-btn' || target.closest('#export-personnel-btn')) {
                const allStaff = await getDocument("staff_list", "staffs", true);
                if (!allStaff) return;
                
                const data = Object.entries(allStaff).map(([key, profile]) => ({
                    'Tên': profile.name,
                    'Email': profile.email,
                    'Phòng ban': profile.depart,
                    'Ca': profile.shift === 'M' ? 'Sáng' : 'Chiều',
                    'Ngôn ngữ': profile.lan
                }));
                
                const ws = XLSX.utils.json_to_sheet(data);
                const wb = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(wb, ws, "Nhân sự");
                XLSX.writeFile(wb, `nhan-su-${new Date().toISOString().split('T')[0]}.xlsx`);
                showToast('Đã tải về file Excel');
                return;
            }

            // Export Stats
            if (target.id === 'export-stats-btn') {
                showLoader();
                try {
                    const dayKey = getDayKey(state.statsViewDate);
                    const weekString = getWeekString(state.statsViewDate);
                    const dayData = await getDocument(weekString, dayKey);
                    
                    if (!dayData) {
                        showToast('Không có dữ liệu để xuất', 'error');
                        hideLoader();
                        return;
                    }
                    
                    const data = Object.entries(dayData).map(([key, order]) => ({
                        'Tên': order.name,
                        'Email': order.email,
                        'Món ăn': parseDish(order.food),
                        'Ca': order.shift === 'M' ? 'Sáng' : 'Chiều',
                        'Phòng ban': order.depart,
                        'Trạng thái': order.status === 'eaten' ? 'Đã ăn' : 'Chưa ăn'
                    }));
                    
                    const ws = XLSX.utils.json_to_sheet(data);
                    const wb = XLSX.utils.book_new();
                    XLSX.utils.book_append_sheet(wb, ws, "Thống kê");
                    XLSX.writeFile(wb, `thong-ke-${weekString}-${dayKey}.xlsx`);
                    showToast('Đã tải về file Excel');
                } catch (error) {
                    showToast('Xuất file thất bại', 'error');
                    console.error(error);
                }
                hideLoader();
                return;
            }
        });

        // Check Order Notification
        async function checkOrderNotification() {
            if (!elements.tabBar.querySelector('.nav-item[data-tab="order"]') || !state.currentUser) return;
            
            const orderTab = elements.tabBar.querySelector('.nav-item[data-tab="order"]');
            const today = new Date();
            const dayOfWeek = today.getDay();
            
            if (dayOfWeek >= 4 || dayOfWeek === 0) {
                const nextWeek = getWeekString(new Date(today.getTime() + 7 * 24 * 60 * 60 * 1000));
                const nextWeekOrders = await getDocument(nextWeek, 'mon');
                orderTab.classList.toggle('needs-attention', !nextWeekOrders || !nextWeekOrders[emailToKey(state.currentUser.email)]);
            } else {
                orderTab.classList.remove('needs-attention');
            }
        }

        // Main App Initialization
        async function main() {
            showLoader();
            try {
                await setPersistence(auth, browserLocalPersistence);
                
                onAuthStateChanged(auth, async (user) => {
                    if (user && user.uid !== state.currentUser?.uid) {
                        try {
                            state.currentUser = user;
                            state.authReady = true;
                            await syncUserProfile();
                            await checkOrderNotification();
                            updateUIForUser(user);
                            await render();
                            showToast(`Chào mừng, ${state.staffProfile.name}!`);
                        } catch (authError) {
                            showToast(authError.message, 'error');
                            await signOut(auth);
                        }
                    } else if (!user) {
                        state.currentUser = null;
                        state.isAdmin = false;
                        state.authReady = true;
                        updateUIForUser(null);
                    }
                    hideLoader();
                });
            } catch (error) {
                console.error('App init error:', error);
                hideLoader();
                showToast('Không thể khởi tạo ứng dụng', 'error');
            }
        }

        main();
    </script>
</body>
</html>
