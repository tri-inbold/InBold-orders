<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Inbold Menu</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;600;700&display=swap');
        
        :root {
            --primary: #667eea;
            --primary-dark: #5a67d8;
            --success: #48bb78;
            --error: #f56565;
            --dark-bg: #0f172a;
            --card-bg: #1e293b;
            --card-hover: #334155;
            --border: #334155;
            --text: #f1f5f9;
            --text-muted: #94a3b8;
            --gradient-1: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            --shadow-sm: 0 1px 3px rgba(0, 0, 0, 0.1);
            --shadow-md: 0 2px 8px rgba(0, 0, 0, 0.15);
            --radius-sm: 8px;
            --radius-md: 12px;
        }
        
        * { box-sizing: border-box; margin: 0; padding: 0; }
        
        body {
            font-family: 'Roboto', 'Arial', sans-serif;
            background: var(--dark-bg);
            color: var(--text);
            line-height: 1.5;
            font-size: 14px;
            -webkit-font-smoothing: antialiased;
        }
        
        #app {
            max-width: 900px;
            margin: 0 auto;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }
        
        @media (min-width: 769px) {
            #app { padding: 0 1.5rem 1.5rem; }
            body { font-size: 13px; }
        }
        
        /* Tab Bar - Desktop at top, Mobile at bottom */
        #tab-bar {
            display: flex;
            gap: 6px;
            padding: 8px;
            background: rgba(30, 41, 59, 0.98);
            backdrop-filter: blur(10px);
            border: 1px solid var(--border);
            box-shadow: var(--shadow-md);
            z-index: 100;
        }
        
        @media (max-width: 768px) {
            #app { padding-bottom: 90px; }
            #tab-bar {
                position: fixed;
                bottom: 0.75rem;
                left: 50%;
                transform: translateX(-50%);
                border-radius: 20px;
                width: calc(100% - 1.5rem);
                max-width: 500px;
            }
        }
        
        @media (min-width: 769px) {
            #tab-bar {
                border-radius: var(--radius-md);
                margin-bottom: 1.5rem;
                position: sticky;
                top: 0;
            }
        }
        
        .nav-item {
            flex: 1;
            padding: 10px 12px;
            border-radius: 12px;
            background: transparent;
            border: none;
            color: var(--text-muted);
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 3px;
            font-size: 11px;
            font-weight: 500;
            position: relative;
        }
        
        .nav-item i, .nav-item img {
            font-size: 18px;
            width: 18px;
            height: 18px;
        }
        
        .nav-item img {
            border-radius: 50%;
            object-fit: cover;
        }
        
        .nav-item:hover { color: var(--text); }
        .nav-item.active { background: var(--primary); color: white; }
        
        .nav-item.needs-attention::after {
            content: '';
            position: absolute;
            top: 6px;
            right: 16px;
            width: 6px;
            height: 6px;
            background: var(--error);
            border-radius: 50%;
            animation: pulse-dot 1.5s infinite;
        }
        
        @keyframes pulse-dot {
            0%, 100% { box-shadow: 0 0 0 0 rgba(245, 101, 101, 0.7); }
            50% { box-shadow: 0 0 0 5px rgba(245, 101, 101, 0); }
        }
        
        @media (max-width: 768px) {
            .nav-item span { display: none; }
        }
        
        /* Main Content */
        main {
            flex-grow: 1;
            padding: 0 1rem;
        }
        
        @media (min-width: 769px) {
            main { padding: 0; }
        }
        
        .card {
            background: var(--card-bg);
            border-radius: var(--radius-md);
            padding: 1.25rem;
            margin-bottom: 1rem;
            border: 1px solid var(--border);
            box-shadow: var(--shadow-sm);
        }
        
        @media (min-width: 769px) {
            .card { padding: 1.5rem; }
        }
        
        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }
        
        .card-title {
            font-size: 18px;
            font-weight: 600;
        }
        
        /* Hero Card */
        .hero-card {
            background: var(--gradient-1);
            position: relative;
            overflow: hidden;
            min-height: 160px;
            display: flex;
            justify-content: center;
            align-items: center;
            text-align: center;
        }
        
        .hero-content { position: relative; z-index: 1; }
        .hero-greeting { font-size: 14px; margin-bottom: 6px; opacity: 0.95; }
        .hero-title { font-size: 32px; font-weight: 700; margin-bottom: 8px; }
        .hero-subtitle { font-size: 13px; opacity: 0.9; }
        
        /* Profile Tab */
        .profile-section {
            text-align: center;
            padding: 2rem 1rem;
        }
        
        .profile-avatar {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            margin: 0 auto 1rem;
            border: 3px solid var(--primary);
        }
        
        .profile-name {
            font-size: 20px;
            font-weight: 600;
            margin-bottom: 0.5rem;
        }
        
        .profile-email {
            font-size: 13px;
            color: var(--text-muted);
            margin-bottom: 0.25rem;
        }
        
        .profile-depart {
            font-size: 13px;
            color: var(--text-muted);
            margin-bottom: 2rem;
        }
        
        .profile-actions {
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
            max-width: 300px;
            margin: 0 auto;
        }
        
        /* Buttons */
        .btn {
            padding: 10px 20px;
            border-radius: var(--radius-sm);
            border: none;
            font-weight: 500;
            font-size: 13px;
            cursor: pointer;
            transition: all 0.2s ease;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
        }
        
        .btn-primary {
            background: var(--gradient-1);
            color: white;
        }
        
        .btn-secondary {
            background: var(--card-bg);
            color: var(--text);
            border: 1px solid var(--border);
        }
        
        .btn-danger { background: var(--error); color: white; }
        .btn:disabled { opacity: 0.5; cursor: not-allowed; }
        .btn-block { width: 100%; }
        
        .icon-btn {
            width: 36px;
            height: 36px;
            border-radius: var(--radius-sm);
            background: var(--card-bg);
            border: 1px solid var(--border);
            color: var(--text);
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.2s ease;
            font-size: 16px;
        }
        
        .icon-btn:hover { background: var(--card-hover); }
        
        /* Forms */
        .form-group { margin-bottom: 1rem; }
        
        .form-label {
            display: block;
            margin-bottom: 6px;
            font-weight: 500;
            font-size: 13px;
        }
        
        .form-input, .form-select, .form-textarea {
            width: 100%;
            padding: 10px 12px;
            background: rgba(15, 23, 42, 0.5);
            border: 1px solid var(--border);
            border-radius: var(--radius-sm);
            color: var(--text);
            font-size: 13px;
            font-family: 'Roboto', 'Arial', sans-serif;
        }
        
        .form-input:focus, .form-select:focus, .form-textarea:focus {
            outline: none;
            border-color: var(--primary);
        }
        
        .form-textarea {
            resize: vertical;
            min-height: 80px;
        }
        
        /* Tabs */
        .tabs {
            display: flex;
            gap: 6px;
            margin-bottom: 1rem;
            overflow-x: auto;
        }
        
        .tab-btn {
            padding: 8px 16px;
            border-radius: var(--radius-sm);
            background: var(--card-bg);
            border: 1px solid var(--border);
            color: var(--text-muted);
            cursor: pointer;
            transition: all 0.2s ease;
            white-space: nowrap;
            font-weight: 500;
            font-size: 13px;
        }
        
        .tab-btn:hover { background: var(--card-hover); color: var(--text); }
        .tab-btn.active { background: var(--primary); border-color: var(--primary); color: white; }
        
        /* Food Options */
        .food-options {
            display: grid;
            gap: 0.75rem;
        }
        
        .food-option {
            background: var(--card-bg);
            border: 1px solid var(--border);
            border-radius: var(--radius-sm);
            padding: 1rem;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            gap: 1rem;
        }
        
        .food-option:hover {
            border-color: var(--primary);
            transform: translateX(4px);
        }
        
        .food-option.selected {
            border-color: var(--primary);
            background: rgba(102, 126, 234, 0.08);
        }
        
        .food-day {
            font-size: 11px;
            color: var(--text-muted);
            font-weight: 600;
            text-transform: uppercase;
            min-width: 50px;
        }
        
        .food-name {
            font-size: 16px;
            font-weight: 500;
            flex: 1;
        }
        
        /* Staff List */
        .staff-list { list-style: none; }
        
        .staff-item {
            display: flex;
            align-items: center;
            padding: 0.75rem;
            background: rgba(30, 41, 59, 0.5);
            border-radius: var(--radius-sm);
            margin-bottom: 6px;
            gap: 10px;
        }
        
        .staff-item:hover { background: var(--card-hover); }
        
        .staff-details { flex: 1; }
        
        .staff-name {
            font-weight: 500;
            font-size: 14px;
            margin-bottom: 2px;
        }
        
        .staff-dish {
            font-size: 12px;
            color: var(--text-muted);
        }
        
        /* Search */
        .search-wrapper {
            position: relative;
            margin-bottom: 1rem;
        }
        
        .search-input {
            width: 100%;
            padding: 10px 12px 10px 38px;
            background: rgba(15, 23, 42, 0.5);
            border: 1px solid var(--border);
            border-radius: var(--radius-sm);
            color: var(--text);
            font-size: 13px;
        }
        
        .search-icon {
            position: absolute;
            left: 12px;
            top: 50%;
            transform: translateY(-50%);
            color: var(--text-muted);
        }
        
        /* Table */
        .table-wrapper {
            overflow-x: auto;
            border-radius: var(--radius-sm);
            border: 1px solid var(--border);
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
        }
        
        thead { background: rgba(102, 126, 234, 0.08); }
        
        th {
            padding: 10px 12px;
            text-align: left;
            font-weight: 600;
            color: var(--primary);
            font-size: 12px;
            text-transform: uppercase;
        }
        
        td {
            padding: 10px 12px;
            border-top: 1px solid var(--border);
            font-size: 13px;
        }
        
        tr:hover { background: rgba(102, 126, 234, 0.04); }
        
        .action-buttons { display: flex; gap: 6px; }
        
        /* Shift Toggle */
        .shift-toggle {
            display: flex;
            gap: 6px;
            background: rgba(102, 126, 234, 0.08);
            padding: 4px;
            border-radius: var(--radius-sm);
        }
        
        .shift-toggle input[type="radio"] { display: none; }
        
        .shift-toggle label {
            flex: 1;
            padding: 8px 14px;
            text-align: center;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s ease;
            font-weight: 500;
            color: var(--text-muted);
            font-size: 13px;
        }
        
        .shift-toggle input[type="radio"]:checked + label {
            background: var(--primary);
            color: white;
        }
        
        /* Menu Items */
        .menu-items { display: flex; flex-direction: column; gap: 6px; }
        
        .menu-item {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 12px;
            background: rgba(15, 23, 42, 0.5);
            border-radius: var(--radius-sm);
            border: 1px solid var(--border);
        }
        
        .menu-item input {
            flex: 1;
            background: transparent;
            border: none;
            color: var(--text);
            font-size: 13px;
            padding: 0;
            margin: 0;
        }
        
        .menu-item input:focus { outline: none; }
        
        /* Modal */
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.75);
            backdrop-filter: blur(4px);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            padding: 1rem;
        }
        
        .modal-content {
            background: var(--card-bg);
            border-radius: var(--radius-md);
            padding: 1.5rem;
            width: 100%;
            max-width: 500px;
            max-height: 90vh;
            overflow-y: auto;
            border: 1px solid var(--border);
        }
        
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }
        
        .modal-title { font-size: 18px; font-weight: 600; }
        
        .close-btn {
            width: 32px;
            height: 32px;
            border-radius: 6px;
            background: transparent;
            border: none;
            color: var(--text-muted);
            cursor: pointer;
            font-size: 20px;
        }
        
        /* Toast */
        #toast-notification {
            position: fixed;
            bottom: 100px;
            left: 50%;
            transform: translateX(-50%) translateY(150px);
            background: var(--card-bg);
            color: var(--text);
            padding: 12px 20px;
            border-radius: var(--radius-md);
            box-shadow: var(--shadow-md);
            border: 1px solid var(--border);
            z-index: 1001;
            transition: transform 0.3s ease;
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 13px;
        }
        
        #toast-notification.show { transform: translateX(-50%) translateY(0); }
        #toast-notification.success { border-color: var(--success); }
        #toast-notification.error { border-color: var(--error); }
        
        /* Loader */
        #loader {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(15, 23, 42, 0.9);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 9999;
        }
        
        .spinner {
            width: 48px;
            height: 48px;
            border: 3px solid rgba(102, 126, 234, 0.2);
            border-top-color: var(--primary);
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }
        
        @keyframes spin { to { transform: rotate(360deg); } }
        
        /* Utilities */
        .hidden { display: none !important; }
        .text-center { text-align: center; }
        .mt-2 { margin-top: 1rem; }
        .mb-2 { margin-bottom: 1rem; }
        
        /* Responsive - Mobile Table */
        @media (max-width: 768px) {
            .table-wrapper table .hide-mobile { display: none; }
        }
        
        /* Day selector for guest order */
        .day-selector {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 6px;
            margin-bottom: 1rem;
        }
        
        .day-checkbox {
            position: relative;
        }
        
        .day-checkbox input {
            position: absolute;
            opacity: 0;
        }
        
        .day-checkbox label {
            display: block;
            padding: 8px;
            text-align: center;
            border: 1px solid var(--border);
            border-radius: var(--radius-sm);
            cursor: pointer;
            font-size: 12px;
            transition: all 0.2s ease;
        }
        
        .day-checkbox input:checked + label {
            background: var(--primary);
            border-color: var(--primary);
            color: white;
        }
    </style>
</head>
<body>
    <div id="app">
        <nav id="tab-bar" class="hidden"></nav>
        <main id="main-content"></main>
        
        <!-- Modals -->
        <div id="settings-modal" class="modal hidden">
            <div class="modal-content">
                <div class="modal-header">
                    <h2 class="modal-title">C√†i ƒë·∫∑t</h2>
                    <button class="close-btn" onclick="document.getElementById('settings-modal').classList.add('hidden')">&times;</button>
                </div>
                <div class="form-group">
                    <label class="form-label">Ph√≤ng ban</label>
                    <select id="department-select" class="form-select"></select>
                </div>
                <button id="save-settings-btn" class="btn btn-primary btn-block">L∆∞u thay ƒë·ªïi</button>
            </div>
        </div>
        
        <div id="guest-order-modal" class="modal hidden">
            <div class="modal-content">
                <div class="modal-header">
                    <h2 class="modal-title">ƒê·∫∑t m√≥n cho kh√°ch</h2>
                    <button class="close-btn" onclick="document.getElementById('guest-order-modal').classList.add('hidden')">&times;</button>
                </div>
                <div class="form-group">
                    <label class="form-label">T√™n kh√°ch</label>
                    <input type="text" id="guest-name" class="form-input" placeholder="T√™n kh√°ch">
                </div>
                <div class="form-group">
                    <label class="form-label">C√¥ng ty / B·ªô ph·∫≠n</label>
                    <input type="text" id="guest-depart" class="form-input" placeholder="T√™n c√¥ng ty ho·∫∑c b·ªô ph·∫≠n">
                </div>
                <div class="form-group">
                    <label class="form-label">Ca</label>
                    <div class="shift-toggle">
                        <input type="radio" id="guest-shift-m" name="guest-shift" value="M" checked>
                        <label for="guest-shift-m">S√°ng</label>
                        <input type="radio" id="guest-shift-e" name="guest-shift" value="E">
                        <label for="guest-shift-e">Chi·ªÅu</label>
                    </div>
                </div>
                <div class="form-group">
                    <label class="form-label">Tu·∫ßn</label>
                    <div class="shift-toggle">
                        <input type="radio" id="guest-week-this" name="guest-week" value="this" checked>
                        <label for="guest-week-this">Tu·∫ßn n√†y</label>
                        <input type="radio" id="guest-week-next" name="guest-week" value="next">
                        <label for="guest-week-next">Tu·∫ßn sau</label>
                    </div>
                </div>
                <div id="guest-days-container"></div>
                <button id="save-guest-order-btn" class="btn btn-primary btn-block">L∆∞u ƒë·∫∑t m√≥n</button>
            </div>
        </div>
        
        <div id="personnel-modal" class="modal hidden">
            <div class="modal-content">
                <div class="modal-header">
                    <h2 id="personnel-modal-title" class="modal-title">Th√™m nh√¢n vi√™n</h2>
                    <button class="close-btn" onclick="document.getElementById('personnel-modal').classList.add('hidden')">&times;</button>
                </div>
                <input type="hidden" id="personnel-original-key">
                <div class="form-group">
                    <label class="form-label">T√™n</label>
                    <input type="text" id="personnel-name" class="form-input">
                </div>
                <div class="form-group">
                    <label class="form-label">Email</label>
                    <input type="email" id="personnel-email" class="form-input">
                </div>
                <div class="form-group">
                    <label class="form-label">Ph√≤ng ban</label>
                    <select id="personnel-depart" class="form-select"></select>
                </div>
                <button id="save-personnel-btn" class="btn btn-primary btn-block">L∆∞u</button>
            </div>
        </div>
        
        <div id="delete-modal" class="modal hidden">
            <div class="modal-content">
                <div class="modal-header">
                    <h2 class="modal-title">X√°c nh·∫≠n</h2>
                    <button class="close-btn" onclick="document.getElementById('delete-modal').classList.add('hidden')">&times;</button>
                </div>
                <p id="delete-message" style="margin-bottom: 1rem; color: var(--text-muted);"></p>
                <div style="display: flex; gap: 8px;">
                    <button class="btn btn-secondary" style="flex: 1;" onclick="document.getElementById('delete-modal').classList.add('hidden')">H·ªßy</button>
                    <button id="confirm-delete-btn" class="btn btn-danger" style="flex: 1;">X√°c nh·∫≠n</button>
                </div>
            </div>
        </div>

        <div id="toast-notification"></div>
        <div id="loader" class="hidden"><div class="spinner"></div></div>
    </div>
    
    <script type="module">
        // ===================================================================================
        // LU·ªíNG LOGIC C·ª¶A SCRIPT:
        // 1. KH·ªûI T·∫†O: Thi·∫øt l·∫≠p Firebase, c√°c ƒë·ªëi t∆∞·ª£ng database/auth.
        // 2. H·∫∞NG S·ªê & TR·∫†NG TH√ÅI TO√ÄN C·ª§C: C√°c bi·∫øn v√† c√†i ƒë·∫∑t chung cho ·ª©ng d·ª•ng.
        // 3. H√ÄM TI·ªÜN √çCH & H·ªñ TR·ª¢: C√°c h√†m c√≥ th·ªÉ t√°i s·ª≠ d·ª•ng (ƒë·ªãnh d·∫°ng ng√†y, loader, cache...).
        // 4. LOGIC HI·ªÇN TH·ªä GIAO DI·ªÜN (RENDERING): C√°c h√†m t·∫°o HTML cho m·ªói tab/ch·ª©c nƒÉng.
        // 5. LOGIC C·ªêT L√ïI C·ª¶A ·ª®NG D·ª§NG: ƒê·ªìng b·ªô h·ªì s∆° ng∆∞·ªùi d√πng, c·∫≠p nh·∫≠t UI theo tr·∫°ng th√°i ƒëƒÉng nh·∫≠p.
        // 6. X·ª¨ L√ù S·ª∞ KI·ªÜN (EVENT HANDLERS): Listener ch√≠nh x·ª≠ l√Ω m·ªçi t∆∞∆°ng t√°c c·ªßa ng∆∞·ªùi d√πng.
        // 7. KH·ªûI CH·∫†Y ·ª®NG D·ª§NG: H√†m main() ƒë·ªÉ b·∫Øt ƒë·∫ßu to√†n b·ªô ·ª©ng d·ª•ng.
        // ===================================================================================

        // 1. KH·ªûI T·∫†O
        // -----------------------------------------------------------------------------------
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getFirestore, doc, getDoc, setDoc, updateDoc, deleteField } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
        import { getAuth, GoogleAuthProvider, signInWithPopup, signOut, onAuthStateChanged, browserLocalPersistence, setPersistence } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";

        const firebaseConfig = {
            apiKey: "AIzaSyCDrCaGUyr9xLkT-xOqzFd9grp6tN2u7Zo",
            authDomain: "hp-orders.firebaseapp.com",
            projectId: "hp-orders",
            storageBucket: "hp-orders.appspot.com",
            messagingSenderId: "616722831059",
            appId: "1:616722831059:web:9d19988d87397e7c13e626"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);
        const provider = new GoogleAuthProvider();
        
        // 2. H·∫∞NG S·ªê & TR·∫†NG TH√ÅI TO√ÄN C·ª§C
        // -----------------------------------------------------------------------------------
        const ADMIN_EMAILS = ['tri.vu.trong@inbold.com', 'truc.tran@inbold.com'];
        const FOOD_ICONS = ['üçú', 'üç≤', 'ü•ò', 'üçõ', 'üçù', 'ü•ó', 'üç±', 'üç£', 'ü•ô', 'üåÆ'];
        
        const state = {
            currentUser: null,
            staffProfile: null,
            isAdmin: false,
            currentTab: 'today',
            adminSubTab: 'support',
            authReady: false,
            orderSelection: {},
            statsViewMode: 'day',
            statsViewDate: new Date().toISOString().split('T')[0],
            cachedData: new Map(),
            deleteTarget: null,
        };

        const CACHE_KEY = 'inbold_menu_cache';
        const CACHE_DURATION = 5 * 60 * 1000; // 5 minutes

        // 3. H√ÄM TI·ªÜN √çCH & H·ªñ TR·ª¢
        // -----------------------------------------------------------------------------------
        const getWeekString = (date) => {
            const d = new Date(date);
            d.setHours(0, 0, 0, 0);
            d.setDate(d.getDate() + 4 - (d.getDay() || 7));
            const yearStart = new Date(d.getFullYear(), 0, 1);
            const weekNo = Math.ceil((((d - yearStart) / 86400000) + 1) / 7);
            return `${d.getFullYear()}_${weekNo}`;
        };

        const getDayKey = (date = new Date()) => ['sun', 'mon', 'tue', 'wed', 'thu', 'fri', 'sat'][date.getDay()];
        const showLoader = () => document.getElementById('loader').classList.remove('hidden');
        const hideLoader = () => document.getElementById('loader').classList.add('hidden');
        const emailToKey = (email) => email.replace(/[.@]/g, '_');
        
        const getFirstName = (fullName) => {
            const parts = fullName.trim().split(' ');
            if (parts.length > 1) return parts[parts.length - 1]; // Vietnamese name
            return parts[0]; // English name
        };

        const parseDish = (dishString) => {
            if (!dishString) return '';
            const parts = dishString.split('|');
            const lang = state.staffProfile?.lan || 'vi';
            return (lang.startsWith('en') && parts.length > 1) ? parts[1].trim() : parts[0].trim();
        };

        const showToast = (message, type = 'success') => {
            const toast = document.getElementById('toast-notification');
            toast.innerHTML = `<span>${message}</span>`;
            toast.className = `show ${type}`;
            setTimeout(() => toast.classList.remove('show'), 3000);
        };

        const getFoodIcon = (index) => FOOD_ICONS[index % FOOD_ICONS.length];

        function saveToCache(key, data) {
            const cache = { data, timestamp: Date.now() };
            localStorage.setItem(`${CACHE_KEY}_${key}`, JSON.stringify(cache));
        }

        function getFromCache(key) {
            const cached = localStorage.getItem(`${CACHE_KEY}_${key}`);
            if (!cached) return null;
            
            const { data, timestamp } = JSON.parse(cached);
            if (Date.now() - timestamp > CACHE_DURATION) {
                localStorage.removeItem(`${CACHE_KEY}_${key}`);
                return null;
            }
            return data;
        }

        async function getDocument(collection, documentId, forceRefresh = false) {
            const cacheKey = `${collection}/${documentId}`;
            if (!forceRefresh && state.cachedData.has(cacheKey)) {
                return state.cachedData.get(cacheKey);
            }
            const docRef = doc(db, collection, documentId);
            const docSnap = await getDoc(docRef);
            const data = docSnap.exists() ? docSnap.data() : null;
            state.cachedData.set(cacheKey, data);
            return data;
        }

        // 4. LOGIC HI·ªÇN TH·ªä GIAO DI·ªÜN (RENDERING)
        // -----------------------------------------------------------------------------------
        async function render() {
            if (!state.authReady || !state.staffProfile) {
                hideLoader();
                return;
            }
            
            showLoader();
            try {
                switch (state.currentTab) {
                    case 'today': await renderToday(); break;
                    case 'menu': await renderMenu(); break;
                    case 'order': await renderOrder(); break;
                    case 'profile': await renderProfile(); break;
                    case 'admin': await renderAdmin(); break;
                }
            } catch (error) {
                console.error('Render error:', error);
                document.getElementById('main-content').innerHTML = `
                    <div class="card"><p style="color: var(--error); text-align: center;">C√≥ l·ªói x·∫£y ra khi t·∫£i d·ªØ li·ªáu</p></div>`;
            }
            hideLoader();
        }

        async function renderToday() {
            const mainContent = document.getElementById('main-content');
            const dayKey = getDayKey();
            const firstName = getFirstName(state.staffProfile.name);
            
            if (['sun', 'sat'].includes(dayKey)) {
                mainContent.innerHTML = `
                    <div class="card hero-card">
                        <div class="hero-content">
                            <div class="hero-greeting">Ch√†o ${firstName} üëã</div>
                            <div class="hero-title">Cu·ªëi tu·∫ßn vui v·∫ª!</div>
                            <div class="hero-subtitle">H√¥m nay kh√¥ng ph·ª•c v·ª• b·ªØa ƒÉn</div>
                        </div>
                    </div>`;
                return;
            }

            const weekString = getWeekString(new Date());
            const cacheKey = `today_${weekString}_${dayKey}_${state.currentUser.email}`;
            let cachedData = getFromCache(cacheKey);
            
            if (!cachedData) {
                const dayData = await getDocument(weekString, dayKey, true);
                const userEmailKey = emailToKey(state.currentUser.email);
                cachedData = dayData?.[userEmailKey] || null;
                if (cachedData) saveToCache(cacheKey, cachedData);
            }

            if (cachedData && cachedData.food) {
                mainContent.innerHTML = `
                    <div class="card hero-card">
                        <div class="hero-content">
                            <div class="hero-greeting">Ch√†o ${firstName} üëã</div>
                            <div class="hero-title">${parseDish(cachedData.food)}</div>
                            <div class="hero-subtitle">H√¥m nay b·∫°n ƒÉn m√≥n n√†y</div>
                        </div>
                    </div>`;
            } else {
                mainContent.innerHTML = `
                    <div class="card hero-card">
                        <div class="hero-content">
                            <div class="hero-greeting">Ch√†o ${firstName} üëã</div>
                            <div class="hero-title">Ch∆∞a c√≥ m√≥n</div>
                            <div class="hero-subtitle">B·∫°n ch∆∞a ƒë·∫∑t m√≥n cho h√¥m nay</div>
                        </div>
                    </div>`;
            }
        }

        async function renderMenu() {
            const mainContent = document.getElementById('main-content');
            const dayKey = getDayKey();
            const weekString = getWeekString(new Date());
            const dayData = await getDocument(weekString, dayKey, true);
            
            const userEmailKey = emailToKey(state.currentUser.email);
            const monData = await getDocument(weekString, 'mon');
            const hasOrdered = monData && monData[userEmailKey];

            mainContent.innerHTML = `
                <div class="card">
                    <div class="card-header"><h2 class="card-title">Danh s√°ch h√¥m nay</h2></div>
                    ${!hasOrdered ? `
                        <div style="margin-bottom: 1rem; padding: 12px; background: rgba(102, 126, 234, 0.08); border-radius: var(--radius-sm); text-align: center;">
                            <p style="margin-bottom: 8px; color: var(--text-muted); font-size: 13px;">B·∫°n ch∆∞a ƒë·∫∑t m√≥n tu·∫ßn n√†y</p>
                            <a href="mailto:truc.tran@inbold.com" class="btn btn-primary" style="text-decoration: none;"><i class="fas fa-envelope"></i> Ng∆∞·ªùi h·ªó tr·ª£</a>
                        </div>
                    ` : ''}
                    <div class="search-wrapper">
                        <i class="fas fa-search search-icon"></i>
                        <input type="text" id="search-staff" class="search-input" placeholder="T√¨m ki·∫øm nh√¢n vi√™n...">
                    </div>
                    <div id="staff-list-container"></div>
                </div>`;

            if (dayData) {
                updateStaffListView(dayData);
                document.getElementById('search-staff').addEventListener('input', (e) => {
                    updateStaffListView(dayData, e.target.value);
                });
            } else {
                document.getElementById('staff-list-container').innerHTML = `<p class="text-center" style="color: var(--text-muted); padding: 2rem;">Ch∆∞a c√≥ d·ªØ li·ªáu cho h√¥m nay</p>`;
            }
        }

        function updateStaffListView(dayData, searchTerm = '') {
            const container = document.getElementById('staff-list-container');
            const staffOrders = Object.entries(dayData)
                .map(([emailKey, order]) => ({ emailKey, ...order }))
                .filter(o => o.name && o.name.toLowerCase().includes(searchTerm.toLowerCase()))
                .sort((a, b) => a.name.localeCompare(b.name));

            const sang = staffOrders.filter(o => o.shift === 'M');
            const chieu = staffOrders.filter(o => o.shift === 'E');

            let html = '<ul class="staff-list">';
            if (sang.length > 0) {
                html += '<h3 style="color: var(--primary); padding: 1rem 0.5rem 0.5rem; font-size: 16px;">‚òÄÔ∏è Ca s√°ng</h3>';
                sang.forEach(order => {
                    html += `<li class="staff-item"><div class="staff-details"><div class="staff-name">${order.name}</div><div class="staff-dish">${parseDish(order.food)}</div></div></li>`;
                });
            }
            if (chieu.length > 0) {
                html += '<h3 style="color: var(--primary); padding: 1rem 0.5rem 0.5rem; font-size: 16px;">üåô Ca chi·ªÅu</h3>';
                chieu.forEach(order => {
                    html += `<li class="staff-item"><div class="staff-details"><div class="staff-name">${order.name}</div><div class="staff-dish">${parseDish(order.food)}</div></div></li>`;
                });
            }
            html += '</ul>';
            container.innerHTML = html || `<p class="text-center" style="color: var(--text-muted); padding: 2rem;">Kh√¥ng t√¨m th·∫•y k·∫øt qu·∫£</p>`;
        }

        async function renderOrder() {
            const mainContent = document.getElementById('main-content');
            const today = new Date();
            const dayOfWeek = today.getDay();
            const targetWeek = (dayOfWeek >= 4 || dayOfWeek === 0) 
                ? getWeekString(new Date(today.getTime() + 7 * 24 * 60 * 60 * 1000))
                : getWeekString(today);

            const userEmailKey = emailToKey(state.currentUser.email);
            
            const cacheKey = `order_${targetWeek}_${state.currentUser.email}`;
            let cachedOrder = getFromCache(cacheKey);
            
            if (!cachedOrder) {
                const monData = await getDocument(targetWeek, 'mon');
                if (monData && monData[userEmailKey]) {
                    cachedOrder = { hasOrdered: true };
                    saveToCache(cacheKey, cachedOrder);
                }
            }

            if (cachedOrder?.hasOrdered) {
                const days = { mon: "Th·ª© 2", tue: "Th·ª© 3", wed: "Th·ª© 4", thu: "Th·ª© 5", fri: "Th·ª© 6" };
                let summaryHTML = `
                    <div class="card">
                        <div class="card-header"><h2 class="card-title">ƒê√£ ƒë·∫∑t m√≥n tu·∫ßn ${targetWeek.split('_')[1]}</h2></div>
                        <ul class="staff-list">`;
                for (const [key, name] of Object.entries(days)) {
                    const dayData = await getDocument(targetWeek, key);
                    const dish = dayData?.[userEmailKey]?.food;
                    summaryHTML += `<li class="staff-item"><div class="staff-details"><div class="staff-name">${name}</div><div class="staff-dish">${parseDish(dish) || 'Ch∆∞a ƒë·∫∑t'}</div></div></li>`;
                }
                mainContent.innerHTML = summaryHTML + `</ul></div>`;
                return;
            }

            const menu = await getDocument(targetWeek, "menu");
            if (!menu) {
                mainContent.innerHTML = `
                    <div class="card"><div class="text-center">
                        <i class="fas fa-calendar-times" style="font-size: 48px; color: var(--text-muted); margin-bottom: 1rem;"></i>
                        <p style="color: var(--text-muted);">Th·ª±c ƒë∆°n cho tu·∫ßn n√†y ch∆∞a ƒë∆∞·ª£c c·∫≠p nh·∫≠t</p>
                    </div></div>`;
                return;
            }

            const days = { mon: "Th·ª© 2", tue: "Th·ª© 3", wed: "Th·ª© 4", thu: "Th·ª© 5", fri: "Th·ª© 6" };
            mainContent.innerHTML = `
                <div class="card">
                    <div class="card-header"><h2 class="card-title">ƒê·∫∑t m√≥n tu·∫ßn ${targetWeek.split('_')[1]}</h2></div>
                    <div class="form-group">
                        <label class="form-label">Ca l√†m vi·ªác c·ªßa b·∫°n trong tu·∫ßn n√†y</label>
                        <div class="shift-toggle">
                            <input type="radio" id="order-shift-m" name="order-shift" value="M" checked><label for="order-shift-m">Ca s√°ng</label>
                            <input type="radio" id="order-shift-e" name="order-shift" value="E"><label for="order-shift-e">Ca chi·ªÅu</label>
                        </div>
                    </div>
                    <div id="order-options" class="food-options"></div>
                    <button id="submit-order-btn" class="btn btn-primary btn-block" disabled>
                        <i class="fas fa-check-circle"></i> Ho√†n t·∫•t ƒë·∫∑t m√≥n
                    </button>
                </div>`;
            renderOrderOptions(menu, days);
        }

        function renderOrderOptions(menu, days) {
            const container = document.getElementById('order-options');
            let html = '';
            Object.entries(days).forEach(([key, name]) => {
                const dishes = menu[key]?.split(',').map(d => d.trim()).filter(d => d) || [];
                dishes.forEach((dish) => {
                    const isSelected = state.orderSelection[key] === dish;
                    html += `<div class="food-option ${isSelected ? 'selected' : ''}" data-day="${key}" data-dish="${dish}"><div class="food-day">${name}</div><div class="food-name">${parseDish(dish)}</div></div>`;
                });
            });
            container.innerHTML = html;
            const allSelected = Object.keys(days).every(day => state.orderSelection[day]);
            document.getElementById('submit-order-btn').disabled = !allSelected;
        }

        async function renderProfile() {
            document.getElementById('main-content').innerHTML = `
                <div class="card">
                    <div class="profile-section">
                        <img src="${state.currentUser.photoURL}" alt="avatar" class="profile-avatar">
                        <div class="profile-name">${state.staffProfile.name}</div>
                        <div class="profile-email">${state.currentUser.email}</div>
                        <div class="profile-depart">${state.staffProfile.depart || 'Ch∆∞a c·∫≠p nh·∫≠t'}</div>
                        <div class="profile-actions">
                            <button id="profile-lang-btn" class="btn btn-secondary btn-block"><i class="fas fa-language"></i> Ng√¥n ng·ªØ: ${(state.staffProfile.lan || 'vi').toUpperCase()}</button>
                            <button id="profile-settings-btn" class="btn btn-secondary btn-block"><i class="fas fa-cog"></i> C√†i ƒë·∫∑t</button>
                            <a href="mailto:truc.tran@inbold.com" class="btn btn-secondary btn-block" style="text-decoration: none;"><i class="fas fa-headset"></i> H·ªó tr·ª£</a>
                            <button id="profile-logout-btn" class="btn btn-danger btn-block"><i class="fas fa-sign-out-alt"></i> ƒêƒÉng xu·∫•t</button>
                        </div>
                    </div>
                </div>`;
        }

        async function renderAdmin() {
            document.getElementById('main-content').innerHTML = `
                <div class="card">
                    <div class="tabs">
                        <button class="tab-btn ${state.adminSubTab === 'support' ? 'active' : ''}" data-subtab="support"><i class="fas fa-headset"></i> H·ªó tr·ª£</button>
                        <button class="tab-btn ${state.adminSubTab === 'stats' ? 'active' : ''}" data-subtab="stats"><i class="fas fa-chart-bar"></i> Th·ªëng k√™</button>
                        <button class="tab-btn ${state.adminSubTab === 'menu' ? 'active' : ''}" data-subtab="menu"><i class="fas fa-utensils"></i> Th·ª±c ƒë∆°n</button>
                        <button class="tab-btn ${state.adminSubTab === 'personnel' ? 'active' : ''}" data-subtab="personnel"><i class="fas fa-users"></i> Nh√¢n s·ª±</button>
                    </div>
                    <div id="admin-content"></div>
                </div>`;
            await renderAdminSubTab();
        }

        async function renderAdminSubTab() {
            switch (state.adminSubTab) {
                case 'support': await renderAdminSupport(); break;
                case 'stats': await renderAdminStats(); break;
                case 'menu': await renderAdminMenu(); break;
                case 'personnel': await renderAdminPersonnel(); break;
            }
        }

        async function renderAdminSupport() {
            const thisWeek = getWeekString(new Date());
            const [allStaff, monOrders] = await Promise.all([
                getDocument("staff_list", "staffs", true),
                getDocument(thisWeek, "mon")
            ]);

            let notOrderedList = [];
            if (allStaff) {
                for (const key in allStaff) {
                    if (key.startsWith('guest_')) continue;
                    if (!monOrders || !monOrders[key]) {
                        notOrderedList.push({ key, profile: allStaff[key] });
                    }
                }
            }
            notOrderedList.sort((a, b) => a.profile.name.localeCompare(b.profile.name));

            document.getElementById('admin-content').innerHTML = `
                <div class="mt-2">
                    <h3 style="color: var(--primary); margin-bottom: 1rem; font-size: 16px;"><i class="fas fa-exclamation-circle"></i> Nh√¢n vi√™n ch∆∞a ƒë·∫∑t m√≥n tu·∫ßn n√†y</h3>
                    ${notOrderedList.length > 0 ? `
                        <ul class="staff-list">
                            ${notOrderedList.map(item => `
                                <li class="staff-item">
                                    <div class="staff-details">
                                        <div class="staff-name">${item.profile.name}</div>
                                        <div class="staff-dish">${item.profile.email}</div>
                                    </div>
                                    <button class="btn btn-secondary reopen-order-btn" data-key="${item.key}" data-name="${item.profile.name}"><i class="fas fa-redo"></i></button>
                                </li>`).join('')}
                        </ul>` : 
                        `<p class="text-center" style="color: var(--text-muted); padding: 2rem;"><i class="fas fa-check-circle" style="font-size: 48px; margin-bottom: 1rem; display: block;"></i> M·ªçi ng∆∞·ªùi ƒë√£ ƒë·∫∑t m√≥n ƒë·ªß!</p>`
                    }
                    <h3 style="color: var(--primary); margin: 2rem 0 1rem; font-size: 16px;"><i class="fas fa-user-plus"></i> ƒê·∫∑t m√≥n cho kh√°ch</h3>
                    <button id="add-guest-order-btn" class="btn btn-primary btn-block"><i class="fas fa-plus"></i> Th√™m ƒë·∫∑t m√≥n cho kh√°ch</button>
                </div>`;
        }

        async function renderAdminStats() {
            document.getElementById('admin-content').innerHTML = `
                <div class="mt-2">
                    <div class="card-header" style="margin-bottom: 1rem; padding: 0;">
                        <h3 style="color: var(--primary); font-size: 16px;">Th·ªëng k√™</h3>
                        <button id="export-stats-btn" class="icon-btn"><i class="fas fa-file-excel"></i></button>
                    </div>
                    <div class="tabs">
                        <button class="tab-btn ${state.statsViewMode === 'day' ? 'active' : ''}" data-mode="day">Ng√†y</button>
                        <button class="tab-btn ${state.statsViewMode === 'week' ? 'active' : ''}" data-mode="week">Tu·∫ßn</button>
                        <button class="tab-btn ${state.statsViewMode === 'month' ? 'active' : ''}" data-mode="month">Th√°ng</button>
                    </div>
                    <div class="form-group"><input type="date" id="stats-date-picker" class="form-input" value="${state.statsViewDate}"></div>
                    <div id="stats-table-container"></div>
                </div>`;

            document.getElementById('stats-date-picker').addEventListener('change', (e) => {
                state.statsViewDate = e.target.value;
                renderStatsTable();
            });
            await renderStatsTable();
        }

        async function renderStatsTable() {
            const container = document.getElementById('stats-table-container');
            const date = new Date(state.statsViewDate);
            if (state.statsViewMode === 'day') await renderDayStats(container, date);
            else if (state.statsViewMode === 'week') await renderWeekStats(container, date);
            else container.innerHTML = '<p class="text-center" style="color: var(--text-muted);">Ch·ª©c nƒÉng ƒëang ƒë∆∞·ª£c x√¢y d·ª±ng</p>';
        }

        async function renderDayStats(container, date) {
            const week = getWeekString(date);
            const day = getDayKey(date);
            if (['sun', 'sat'].includes(day)) {
                container.innerHTML = '<p class="text-center" style="color: var(--text-muted);">Kh√¥ng c√≥ d·ªØ li·ªáu cho cu·ªëi tu·∫ßn</p>';
                return;
            }
            const data = await getDocument(week, day);
            if (!data) {
                container.innerHTML = '<p class="text-center" style="color: var(--text-muted);">Kh√¥ng c√≥ d·ªØ li·ªáu</p>';
                return;
            }
            
            const stats = {};
            Object.values(data).forEach(order => {
                const key = `${order.shift}_${parseDish(order.food)}`;
                if (!stats[key]) stats[key] = { dish: parseDish(order.food), shift: order.shift, ordered: 0, eaten: 0, notEaten: 0 };
                stats[key].ordered++;
                if (order.status === 'eaten') stats[key].eaten++; else stats[key].notEaten++;
            });
            
            const sang = Object.values(stats).filter(s => s.shift === 'M');
            const chieu = Object.values(stats).filter(s => s.shift === 'E');
            
            let html = '<div class="table-wrapper"><table><thead><tr><th>M√≥n ƒÉn</th><th>ƒê√£ ƒë·∫∑t</th><th>ƒê√£ ƒÉn</th><th>Ch∆∞a ƒÉn</th></tr></thead><tbody>';
            if (sang.length > 0) {
                html += '<tr style="background: rgba(102, 126, 234, 0.08);"><td colspan="4"><strong>‚òÄÔ∏è Ca s√°ng</strong></td></tr>';
                sang.forEach(s => { html += `<tr><td>${s.dish}</td><td>${s.ordered}</td><td>${s.eaten}</td><td>${s.notEaten}</td></tr>`; });
                const totals = sang.reduce((acc, s) => ({ ordered: acc.ordered + s.ordered, eaten: acc.eaten + s.eaten, notEaten: acc.notEaten + s.notEaten }), { ordered: 0, eaten: 0, notEaten: 0 });
                html += `<tr style="font-weight: 600;"><td>T·ªïng</td><td>${totals.ordered}</td><td>${totals.eaten}</td><td>${totals.notEaten}</td></tr>`;
            }
            if (chieu.length > 0) {
                html += '<tr style="background: rgba(102, 126, 234, 0.08);"><td colspan="4"><strong>üåô Ca chi·ªÅu</strong></td></tr>';
                chieu.forEach(s => { html += `<tr><td>${s.dish}</td><td>${s.ordered}</td><td>${s.eaten}</td><td>${s.notEaten}</td></tr>`; });
                const totals = chieu.reduce((acc, s) => ({ ordered: acc.ordered + s.ordered, eaten: acc.eaten + s.eaten, notEaten: acc.notEaten + s.notEaten }), { ordered: 0, eaten: 0, notEaten: 0 });
                html += `<tr style="font-weight: 600;"><td>T·ªïng</td><td>${totals.ordered}</td><td>${totals.eaten}</td><td>${totals.notEaten}</td></tr>`;
            }
            html += '</tbody></table></div>';
            container.innerHTML = html;
        }

        async function renderWeekStats(container, date) {
            const week = getWeekString(date);
            const days = ['mon', 'tue', 'wed', 'thu', 'fri'];
            const weekData = await Promise.all(days.map(day => getDocument(week, day)));
            
            const stats = {};
            weekData.forEach(dayData => {
                if (!dayData) return;
                Object.values(dayData).forEach(order => {
                    const key = `${order.shift}_${parseDish(order.food)}_${order.depart || 'Kh√°c'}`;
                    if (!stats[key]) stats[key] = { dish: parseDish(order.food), shift: order.shift, depart: order.depart || 'Kh√°c', ordered: 0, eaten: 0, notEaten: 0 };
                    stats[key].ordered++;
                    if (order.status === 'eaten') stats[key].eaten++; else stats[key].notEaten++;
                });
            });
            
            const sang = Object.values(stats).filter(s => s.shift === 'M');
            const chieu = Object.values(stats).filter(s => s.shift === 'E');
            
            let html = '<div class="table-wrapper"><table><thead><tr><th>M√≥n ƒÉn</th><th>Ph√≤ng ban</th><th>ƒê√£ ƒë·∫∑t</th><th>ƒê√£ ƒÉn</th><th>Ch∆∞a ƒÉn</th></tr></thead><tbody>';
            if (sang.length > 0) {
                html += '<tr style="background: rgba(102, 126, 234, 0.08);"><td colspan="5"><strong>‚òÄÔ∏è Ca s√°ng</strong></td></tr>';
                sang.forEach(s => { html += `<tr><td>${s.dish}</td><td>${s.depart}</td><td>${s.ordered}</td><td>${s.eaten}</td><td>${s.notEaten}</td></tr>`; });
                const totals = sang.reduce((acc, s) => ({ ordered: acc.ordered + s.ordered, eaten: acc.eaten + s.eaten, notEaten: acc.notEaten + s.notEaten }), { ordered: 0, eaten: 0, notEaten: 0 });
                html += `<tr style="font-weight: 600;"><td colspan="2">T·ªïng</td><td>${totals.ordered}</td><td>${totals.eaten}</td><td>${totals.notEaten}</td></tr>`;
            }
            if (chieu.length > 0) {
                html += '<tr style="background: rgba(102, 126, 234, 0.08);"><td colspan="5"><strong>üåô Ca chi·ªÅu</strong></td></tr>';
                chieu.forEach(s => { html += `<tr><td>${s.dish}</td><td>${s.depart}</td><td>${s.ordered}</td><td>${s.eaten}</td><td>${s.notEaten}</td></tr>`; });
                const totals = chieu.reduce((acc, s) => ({ ordered: acc.ordered + s.ordered, eaten: acc.eaten + s.eaten, notEaten: acc.notEaten + s.notEaten }), { ordered: 0, eaten: 0, notEaten: 0 });
                html += `<tr style="font-weight: 600;"><td colspan="2">T·ªïng</td><td>${totals.ordered}</td><td>${totals.eaten}</td><td>${totals.notEaten}</td></tr>`;
            }
            html += '</tbody></table></div>';
            container.innerHTML = html;
        }

        async function renderAdminMenu() {
            const today = new Date();
            const dayOfWeek = today.getDay();
            const thisWeek = getWeekString(today);
            const nextWeek = getWeekString(new Date(today.getTime() + 7 * 24 * 60 * 60 * 1000));
            const isEditable = dayOfWeek >= 1 && dayOfWeek <= 4;
            
            const [thisWeekMenu, nextWeekMenu] = await Promise.all([getDocument(thisWeek, "menu"), getDocument(nextWeek, "menu")]);
            const days = { mon: "Th·ª© 2", tue: "Th·ª© 3", wed: "Th·ª© 4", thu: "Th·ª© 5", fri: "Th·ª© 6" };

            let html = `
                <div class="mt-2">
                    <h3 style="color: var(--primary); font-size: 16px; margin-bottom: 1rem;">Th·ª±c ƒë∆°n tu·∫ßn n√†y (${thisWeek})</h3>`;
            Object.entries(days).forEach(([key, name]) => {
                const dishes = thisWeekMenu?.[key]?.split(',').map(d => d.trim()).filter(d => d) || [];
                html += `<div class="form-group"><label class="form-label">${name}</label><div class="menu-items">`;
                dishes.forEach(dish => { html += `<div class="menu-item"><input type="text" value="${dish}" disabled></div>`; });
                html += `</div></div>`;
            });
            
            html += `
                <div style="display: flex; justify-content: space-between; align-items: center; margin: 2rem 0 1rem;">
                    <h3 style="color: var(--primary); font-size: 16px;">Th·ª±c ƒë∆°n tu·∫ßn sau (${nextWeek})</h3>
                    <div style="display: flex; gap: 8px;">
                        <button id="import-menu-btn" class="icon-btn" ${!isEditable ? 'disabled' : ''}><i class="fas fa-file-import"></i></button>
                        <button id="export-menu-btn" class="icon-btn"><i class="fas fa-file-export"></i></button>
                    </div>
                </div>
                <input type="file" id="menu-file-input" accept=".xlsx" style="display: none;">`;
            
            Object.entries(days).forEach(([key, name]) => {
                const dishes = nextWeekMenu?.[key]?.split(',').map(d => d.trim()).filter(d => d) || [''];
                html += `<div class="form-group"><label class="form-label">${name}</label><div class="menu-items" id="menu-${key}">`;
                dishes.forEach(dish => {
                    html += `<div class="menu-item">
                        <input type="text" class="menu-dish-input" data-day="${key}" value="${dish}" ${!isEditable ? 'disabled' : ''} placeholder="M√≥n ƒÉn|Dish name">
                        <button class="icon-btn remove-dish-btn" ${!isEditable ? 'disabled' : ''}><i class="fas fa-minus"></i></button>
                    </div>`;
                });
                html += `</div><button class="btn btn-secondary add-dish-btn" data-day="${key}" style="width: auto; margin-top: 0.5rem;" ${!isEditable ? 'disabled' : ''}><i class="fas fa-plus"></i> Th√™m m√≥n</button></div>`;
            });
            
            html += `<button id="save-menu-btn" class="btn ${isEditable ? 'btn-primary' : 'btn-secondary'} btn-block" ${!isEditable ? 'disabled' : ''}>
                        <i class="fas ${isEditable ? 'fa-save' : 'fa-lock'}"></i> ${isEditable ? 'L∆∞u Th·ª±c ƒë∆°n' : 'ƒê√£ kh√≥a ch·ªânh s·ª≠a'}
                    </button></div>`;
            
            document.getElementById('admin-content').innerHTML = html;
        }

        async function renderAdminPersonnel() {
            const allStaff = await getDocument("staff_list", "staffs", true);
            let tableRows = '';
            if (allStaff) {
                tableRows = Object.entries(allStaff)
                    .filter(([key]) => !key.startsWith('guest_'))
                    .sort((a, b) => a[1].name.localeCompare(b[1].name))
                    .map(([key, profile]) => `
                        <tr>
                            <td>${profile.name}</td>
                            <td class="hide-mobile">${profile.email}</td>
                            <td class="hide-mobile">${profile.depart || '-'}</td>
                            <td><div class="action-buttons">
                                <button class="icon-btn edit-personnel-btn" data-key="${key}"><i class="fas fa-edit"></i></button>
                                <button class="icon-btn delete-personnel-btn" data-key="${key}" data-name="${profile.name}"><i class="fas fa-trash"></i></button>
                            </div></td>
                        </tr>`).join('');
            }

            document.getElementById('admin-content').innerHTML = `
                <div class="mt-2">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                        <h3 style="color: var(--primary); font-size: 16px;">Qu·∫£n l√Ω nh√¢n s·ª±</h3>
                        <div style="display: flex; gap: 8px;">
                            <button id="add-personnel-btn" class="icon-btn"><i class="fas fa-plus"></i></button>
                            <button id="export-personnel-btn" class="icon-btn"><i class="fas fa-file-excel"></i></button>
                        </div>
                    </div>
                    <div class="table-wrapper"><table><thead><tr>
                        <th>T√™n</th><th class="hide-mobile">Email</th><th class="hide-mobile">Ph√≤ng ban</th><th>Thao t√°c</th>
                    </tr></thead><tbody>
                        ${tableRows || '<tr><td colspan="4" class="text-center">Ch∆∞a c√≥ d·ªØ li·ªáu</td></tr>'}
                    </tbody></table></div>
                </div>`;
        }

        function renderGuestDaysMenu(menu) {
            const container = document.getElementById('guest-days-container');
            if (!menu) {
                container.innerHTML = '<p class="text-center" style="color: var(--text-muted);">Ch∆∞a c√≥ th·ª±c ƒë∆°n</p>';
                return;
            }
            
            const days = { mon: "Th·ª© 2", tue: "Th·ª© 3", wed: "Th·ª© 4", thu: "Th·ª© 5", fri: "Th·ª© 6" };
            let html = '';
            Object.entries(days).forEach(([key, name]) => {
                const dishes = menu[key]?.split(',').map(d => d.trim()).filter(d => d) || [];
                html += `
                    <div class="form-group">
                        <label class="form-label"><input type="checkbox" name="guest-day-${key}" style="margin-right: 8px;">${name}</label>
                        <select name="guest-dish-${key}" class="form-select">
                            <option value="">-- Ch·ªçn m√≥n --</option>
                            ${dishes.map(dish => `<option value="${dish}">${parseDish(dish)}</option>`).join('')}
                        </select>
                    </div>`;
            });
            container.innerHTML = html;
        }

        // 5. LOGIC C·ªêT L√ïI C·ª¶A ·ª®NG D·ª§NG
        // -----------------------------------------------------------------------------------
        async function syncUserProfile() {
            const user = state.currentUser;
            const userEmailKey = emailToKey(user.email);
            const staffData = await getDocument("staff_list", "staffs", true);

            if (!staffData || !staffData[userEmailKey]) {
                await signOut(auth);
                throw new Error("T√†i kho·∫£n c·ªßa b·∫°n kh√¥ng c√≥ trong danh s√°ch ƒë∆∞·ª£c ph√©p.");
            }

            state.staffProfile = staffData[userEmailKey];
            state.isAdmin = ADMIN_EMAILS.includes(user.email);
        }

        function updateUIForUser(user) {
            const tabBar = document.getElementById('tab-bar');
            if (user && state.staffProfile) {
                let tabBarHTML = `
                    <button class="nav-item active" data-tab="today"><i class="fas fa-home"></i><span>H√¥m Nay</span></button>
                    <button class="nav-item" data-tab="menu"><i class="fas fa-list"></i><span>Th·ª±c ƒë∆°n</span></button>
                    <button class="nav-item" data-tab="order"><i class="fas fa-shopping-cart"></i><span>ƒê·∫∑t M√≥n</span></button>`;
                if (state.isAdmin) {
                    tabBarHTML += `<button class="nav-item" data-tab="admin"><i class="fas fa-crown"></i><span>Admin</span></button>`;
                }
                tabBarHTML += `<button class="nav-item" data-tab="profile"><img src="${user.photoURL}" alt="avatar"><span>T√†i kho·∫£n</span></button>`;
                tabBar.innerHTML = tabBarHTML;
                tabBar.classList.remove('hidden');
            } else {
                tabBar.classList.add('hidden');
                document.getElementById('main-content').innerHTML = `
                    <div class="card hero-card">
                        <div class="hero-content">
                            <div class="hero-title">Ch√†o m·ª´ng! üëã</div>
                            <div class="hero-subtitle" style="margin-bottom: 2rem;">Vui l√≤ng ƒëƒÉng nh·∫≠p b·∫±ng t√†i kho·∫£n c√¥ng ty</div>
                            <button id="login-btn" class="btn btn-primary"><i class="fab fa-google"></i> ƒêƒÉng nh·∫≠p b·∫±ng Google</button>
                        </div>
                    </div>`;
            }
        }

        async function checkOrderNotification() {
            const orderTab = document.querySelector('#tab-bar .nav-item[data-tab="order"]');
            if (!orderTab || !state.currentUser) return;
            
            const today = new Date();
            const dayOfWeek = today.getDay();
            
            if (dayOfWeek >= 4 || dayOfWeek === 0) { // From Thursday to Sunday
                const nextWeek = getWeekString(new Date(today.getTime() + 7 * 24 * 60 * 60 * 1000));
                const nextWeekOrders = await getDocument(nextWeek, 'mon');
                const userHasOrdered = nextWeekOrders && nextWeekOrders[emailToKey(state.currentUser.email)];
                orderTab.classList.toggle('needs-attention', !userHasOrdered);
            } else {
                orderTab.classList.remove('needs-attention');
            }
        }

        // 6. X·ª¨ L√ù S·ª∞ KI·ªÜN (EVENT HANDLERS)
        // -----------------------------------------------------------------------------------
        document.body.addEventListener('click', async (e) => {
            const target = e.target.closest('button, a, .food-option');
            if (!target) return;

            // Login
            if (target.id === 'login-btn') {
                showLoader();
                try { await signInWithPopup(auth, provider); } 
                catch (err) { console.error('Login error:', err); showToast('ƒêƒÉng nh·∫≠p th·∫•t b·∫°i', 'error'); hideLoader(); }
                return;
            }

            // Navigation
            if (target.classList.contains('nav-item')) {
                const tab = target.dataset.tab;
                if (tab === state.currentTab) return;
                document.querySelectorAll('.nav-item').forEach(item => item.classList.remove('active'));
                target.classList.add('active');
                state.currentTab = tab;
                await render();
                return;
            }

            // Profile actions
            if (target.id === 'profile-logout-btn') { if (confirm('B·∫°n c√≥ ch·∫Øc mu·ªën ƒëƒÉng xu·∫•t?')) await signOut(auth); return; }
            if (target.id === 'profile-lang-btn') {
                showLoader();
                try {
                    const newLang = state.staffProfile.lan === 'vi' ? 'en' : 'vi';
                    await updateDoc(doc(db, "staff_list", "staffs"), { [`${emailToKey(state.currentUser.email)}.lan`]: newLang });
                    state.staffProfile.lan = newLang; state.cachedData.delete("staff_list/staffs");
                    showToast(`ƒê√£ chuy·ªÉn sang ${newLang.toUpperCase()}`); await render();
                } catch (error) { showToast('ƒê·ªïi ng√¥n ng·ªØ th·∫•t b·∫°i', 'error'); }
                hideLoader(); return;
            }
            if (target.id === 'profile-settings-btn') {
                const departsData = await getDocument('staff_list', 'departs');
                if (departsData) document.getElementById('department-select').innerHTML = (departsData.list || []).map(d => `<option value="${d}" ${d === state.staffProfile.depart ? 'selected' : ''}>${d}</option>`).join('');
                document.getElementById('settings-modal').classList.remove('hidden'); return;
            }
            if (target.id === 'save-settings-btn') {
                showLoader();
                try {
                    const newDepart = document.getElementById('department-select').value;
                    await updateDoc(doc(db, "staff_list", "staffs"), { [`${emailToKey(state.currentUser.email)}.depart`]: newDepart });
                    state.staffProfile.depart = newDepart; state.cachedData.delete("staff_list/staffs");
                    document.getElementById('settings-modal').classList.add('hidden'); showToast('C·∫≠p nh·∫≠t th√†nh c√¥ng!');
                } catch (error) { showToast('C·∫≠p nh·∫≠t th·∫•t b·∫°i', 'error'); }
                hideLoader(); return;
            }

            // Food selection
            if (target.classList.contains('food-option')) {
                state.orderSelection[target.dataset.day] = target.dataset.dish;
                const today = new Date(), dayOfWeek = today.getDay();
                const targetWeek = (dayOfWeek >= 4 || dayOfWeek === 0) ? getWeekString(new Date(today.getTime() + 7 * 24 * 60 * 60 * 1000)) : getWeekString(today);
                const menu = await getDocument(targetWeek, "menu");
                renderOrderOptions(menu, { mon: "Th·ª© 2", tue: "Th·ª© 3", wed: "Th·ª© 4", thu: "Th·ª© 5", fri: "Th·ª© 6" });
                return;
            }

            // Submit order
            if (target.id === 'submit-order-btn') {
                showLoader();
                try {
                    const today = new Date(), dayOfWeek = today.getDay();
                    const targetWeek = (dayOfWeek >= 4 || dayOfWeek === 0) ? getWeekString(new Date(today.getTime() + 7 * 24 * 60 * 60 * 1000)) : getWeekString(today);
                    const shift = document.querySelector('input[name="order-shift"]:checked').value;
                    const userEmailKey = emailToKey(state.currentUser.email);
                    for (const [day, dish] of Object.entries(state.orderSelection)) {
                        await setDoc(doc(db, targetWeek, day), { [userEmailKey]: { name: state.staffProfile.name, email: state.currentUser.email, food: dish, status: 'not', shift: shift, depart: state.staffProfile.depart } }, { merge: true });
                    }
                    localStorage.removeItem(`${CACHE_KEY}_order_${targetWeek}_${state.currentUser.email}`);
                    state.orderSelection = {}; showToast('ƒê·∫∑t m√≥n th√†nh c√¥ng!');
                    state.currentTab = 'today'; document.querySelectorAll('.nav-item').forEach(item => item.classList.toggle('active', item.dataset.tab === 'today'));
                    await render();
                } catch (error) { console.error('Order error:', error); showToast('ƒê·∫∑t m√≥n th·∫•t b·∫°i', 'error'); }
                hideLoader(); return;
            }

            // Admin sub tabs & actions
            if (target.dataset.subtab) { state.adminSubTab = target.dataset.subtab; await renderAdmin(); return; }
            if (target.dataset.mode) { state.statsViewMode = target.dataset.mode; await renderAdminStats(); return; }
            if (target.id === 'confirm-delete-btn') {
                if (state.deleteTarget.action === 'reopen') {
                    showLoader();
                    try {
                        const weekString = getWeekString(new Date());
                        for (const day of ['mon', 'tue', 'wed', 'thu', 'fri']) {
                            await updateDoc(doc(db, weekString, day), { [state.deleteTarget.key]: deleteField() });
                        }
                        showToast(`ƒê√£ m·ªü l·∫°i ƒë·∫∑t m√≥n cho ${state.deleteTarget.name}`); await renderAdminSupport();
                    } catch (error) { showToast('C√≥ l·ªói x·∫£y ra', 'error'); }
                    hideLoader();
                } else if (state.deleteTarget.action === 'delete-personnel') {
                    showLoader();
                    try {
                        await updateDoc(doc(db, "staff_list", "staffs"), { [state.deleteTarget.key]: deleteField() });
                        state.cachedData.delete("staff_list/staffs"); showToast('ƒê√£ x√≥a nh√¢n vi√™n'); await renderAdminPersonnel();
                    } catch (error) { showToast('C√≥ l·ªói x·∫£y ra', 'error'); }
                    hideLoader();
                }
                document.getElementById('delete-modal').classList.add('hidden'); return;
            }

            // Guest order actions
            if (target.id === 'add-guest-order-btn') {
                const today = new Date();
                const thisWeekMenu = await getDocument(getWeekString(today), "menu");
                const nextWeekMenu = await getDocument(getWeekString(new Date(today.getTime() + 7 * 24 * 60 * 60 * 1000)), "menu");
                document.getElementById('guest-days-container').innerHTML = '';
                document.getElementById('guest-order-modal').classList.remove('hidden');
                document.querySelectorAll('input[name="guest-week"]').forEach(radio => {
                    radio.onchange = () => renderGuestDaysMenu(radio.value === 'this' ? thisWeekMenu : nextWeekMenu);
                });
                renderGuestDaysMenu(thisWeekMenu); return;
            }
            if (target.id === 'save-guest-order-btn') {
                showLoader();
                try {
                    const name = document.getElementById('guest-name').value.trim();
                    const depart = document.getElementById('guest-depart').value.trim();
                    if (!name || !depart) { showToast('Vui l√≤ng ƒëi·ªÅn ƒë·∫ßy ƒë·ªß th√¥ng tin', 'error'); hideLoader(); return; }
                    const shift = document.querySelector('input[name="guest-shift"]:checked').value;
                    const week = document.querySelector('input[name="guest-week"]:checked').value;
                    const today = new Date();
                    const targetWeek = week === 'this' ? getWeekString(today) : getWeekString(new Date(today.getTime() + 7 * 24 * 60 * 60 * 1000));
                    const guestKey = `guest_${Date.now()}`;
                    for (const day of ['mon', 'tue', 'wed', 'thu', 'fri']) {
                        if (document.querySelector(`input[name="guest-day-${day}"]`)?.checked) {
                            const dish = document.querySelector(`select[name="guest-dish-${day}"]`).value;
                            if (dish) await setDoc(doc(db, targetWeek, day), { [guestKey]: { name, email: guestKey + '@guest', food: dish, status: 'not', shift, depart } }, { merge: true });
                        }
                    }
                    document.getElementById('guest-order-modal').classList.add('hidden'); showToast('ƒê√£ ƒë·∫∑t m√≥n cho kh√°ch');
                } catch (error) { showToast('C√≥ l·ªói x·∫£y ra', 'error'); console.error(error); }
                hideLoader(); return;
            }

            // Menu management actions
            if (target.classList.contains('add-dish-btn')) {
                const container = document.getElementById(`menu-${target.dataset.day}`);
                const newItem = document.createElement('div');
                newItem.className = 'menu-item';
                newItem.innerHTML = `<input type="text" class="menu-dish-input" data-day="${target.dataset.day}" placeholder="M√≥n ƒÉn|Dish name"><button class="icon-btn remove-dish-btn"><i class="fas fa-minus"></i></button>`;
                container.appendChild(newItem); return;
            }
            if (target.classList.contains('remove-dish-btn')) { target.closest('.menu-item').remove(); return; }
            if (target.id === 'save-menu-btn') {
                showLoader();
                try {
                    const nextWeek = getWeekString(new Date(new Date().getTime() + 7 * 24 * 60 * 60 * 1000));
                    const menuData = {};
                    ['mon', 'tue', 'wed', 'thu', 'fri'].forEach(day => {
                        menuData[day] = [...document.querySelectorAll(`.menu-dish-input[data-day="${day}"]`)].map(input => input.value.trim()).filter(dish => dish).join(', ');
                    });
                    await setDoc(doc(db, nextWeek, "menu"), menuData);
                    state.cachedData.delete(`${nextWeek}/menu`); showToast('L∆∞u th·ª±c ƒë∆°n th√†nh c√¥ng!');
                } catch (error) { showToast('L∆∞u th·∫•t b·∫°i', 'error'); }
                hideLoader(); return;
            }
            if (target.id === 'import-menu-btn') { document.getElementById('menu-file-input').click(); return; }
            if (target.id === 'export-menu-btn' || target.id === 'export-stats-btn' || target.id === 'export-personnel-btn') {
                let data, sheetName, fileName;
                if (target.id === 'export-menu-btn') {
                    const nextWeek = getWeekString(new Date(new Date().getTime() + 7 * 24 * 60 * 60 * 1000));
                    const menu = await getDocument(nextWeek, "menu");
                    if (!menu) return;
                    data = Object.entries(menu).map(([day, dishes]) => ({ 'Ng√†y': { mon: 'Th·ª© 2', tue: 'Th·ª© 3', wed: 'Th·ª© 4', thu: 'Th·ª© 5', fri: 'Th·ª© 6' }[day], 'M√≥n ƒÉn': dishes }));
                    sheetName = "Th·ª±c ƒë∆°n"; fileName = `menu-${nextWeek}.xlsx`;
                } else if (target.id === 'export-stats-btn') {
                    const table = document.querySelector('#stats-table-container table');
                    if (table) XLSX.writeFile(XLSX.utils.book_new_append_sheet(XLSX.utils.table_to_sheet(table), "Th·ªëng k√™"), `thong-ke-${state.statsViewDate}.xlsx`);
                    return;
                } else { // export-personnel-btn
                    const allStaff = await getDocument("staff_list", "staffs", true);
                    if (!allStaff) return;
                    data = Object.values(allStaff).filter(p => !p.email.includes('@guest')).map(p => ({ 'T√™n': p.name, 'Email': p.email, 'Ph√≤ng ban': p.depart, 'Ng√¥n ng·ªØ': p.lan }));
                    sheetName = "Nh√¢n s·ª±"; fileName = `nhan-su-${new Date().toISOString().split('T')[0]}.xlsx`;
                }
                XLSX.writeFile(XLSX.utils.book_new_append_sheet(XLSX.utils.json_to_sheet(data), sheetName), fileName);
                showToast('ƒê√£ t·∫£i v·ªÅ file Excel'); return;
            }

            // Personnel management actions
            if (target.id === 'add-personnel-btn' || target.classList.contains('edit-personnel-btn')) {
                const departsData = await getDocument('staff_list', 'departs');
                document.getElementById('personnel-depart').innerHTML = (departsData?.list || []).map(d => `<option value="${d}">${d}</option>`).join('');
                if (target.id === 'add-personnel-btn') {
                    document.getElementById('personnel-modal-title').textContent = 'Th√™m nh√¢n vi√™n';
                    ['personnel-original-key', 'personnel-name', 'personnel-email'].forEach(id => document.getElementById(id).value = '');
                } else {
                    const key = target.dataset.key;
                    const profile = (await getDocument("staff_list", "staffs", true))[key];
                    document.getElementById('personnel-modal-title').textContent = 'S·ª≠a nh√¢n vi√™n';
                    document.getElementById('personnel-original-key').value = key;
                    document.getElementById('personnel-name').value = profile.name;
                    document.getElementById('personnel-email').value = profile.email;
                    document.getElementById('personnel-depart').value = profile.depart;
                }
                document.getElementById('personnel-modal').classList.remove('hidden'); return;
            }
            if (target.id === 'save-personnel-btn') {
                showLoader();
                try {
                    const name = document.getElementById('personnel-name').value.trim();
                    const email = document.getElementById('personnel-email').value.trim();
                    if (!name || !email) { showToast('Vui l√≤ng ƒëi·ªÅn ƒë·∫ßy ƒë·ªß th√¥ng tin', 'error'); hideLoader(); return; }
                    const originalKey = document.getElementById('personnel-original-key').value;
                    const newKey = emailToKey(email);
                    const updateData = { [newKey]: { name, email, depart: document.getElementById('personnel-depart').value, lan: 'vi' } };
                    if (originalKey && originalKey !== newKey) updateData[originalKey] = deleteField();
                    await updateDoc(doc(db, "staff_list", "staffs"), updateData);
                    state.cachedData.delete("staff_list/staffs");
                    document.getElementById('personnel-modal').classList.add('hidden'); showToast('L∆∞u th√†nh c√¥ng!'); await renderAdminPersonnel();
                } catch (error) { showToast('C√≥ l·ªói x·∫£y ra', 'error'); }
                hideLoader(); return;
            }

            // Delete actions
            if (target.classList.contains('delete-personnel-btn') || target.classList.contains('reopen-order-btn')) {
                const name = target.dataset.name;
                const key = target.dataset.key;
                if (target.classList.contains('delete-personnel-btn')) {
                    state.deleteTarget = { key, name, action: 'delete-personnel' };
                    document.getElementById('delete-message').textContent = `B·∫°n c√≥ ch·∫Øc mu·ªën x√≥a nh√¢n vi√™n "${name}"? H√†nh ƒë·ªông n√†y kh√¥ng th·ªÉ ho√†n t√°c.`;
                } else { // reopen-order-btn
                    state.deleteTarget = { key, name, action: 'reopen' };
                    document.getElementById('delete-message').textContent = `X√≥a t·∫•t c·∫£ ƒë·∫∑t m√≥n c·ªßa "${name}" trong tu·∫ßn n√†y ƒë·ªÉ h·ªç c√≥ th·ªÉ ƒë·∫∑t l·∫°i?`;
                }
                document.getElementById('delete-modal').classList.remove('hidden'); return;
            }
        });

        document.getElementById('menu-file-input').addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (!file) return;
            showLoader();
            const reader = new FileReader();
            reader.onload = async (evt) => {
                try {
                    const workbook = XLSX.read(new Uint8Array(evt.target.result), { type: 'array' });
                    const jsonData = XLSX.utils.sheet_to_json(workbook.Sheets[workbook.SheetNames[0]]);
                    const nextWeek = getWeekString(new Date(new Date().getTime() + 7 * 24 * 60 * 60 * 1000));
                    const dayMap = { 'Th·ª© 2': 'mon', 'Th·ª© 3': 'tue', 'Th·ª© 4': 'wed', 'Th·ª© 5': 'thu', 'Th·ª© 6': 'fri' };
                    const menuData = {};
                    jsonData.forEach(row => { if (dayMap[row['Ng√†y']]) menuData[dayMap[row['Ng√†y']]] = row['M√≥n ƒÉn']; });
                    await setDoc(doc(db, nextWeek, "menu"), menuData);
                    state.cachedData.delete(`${nextWeek}/menu`); showToast('Import th√†nh c√¥ng!'); await renderAdminMenu();
                } catch (error) { showToast('Import th·∫•t b·∫°i', 'error'); console.error(error); }
                hideLoader();
            };
            reader.readAsArrayBuffer(file);
            e.target.value = '';
        });

        // 7. KH·ªûI CH·∫†Y ·ª®NG D·ª§NG
        // -----------------------------------------------------------------------------------
        async function main() {
            showLoader();
            try {
                await setPersistence(auth, browserLocalPersistence);
                onAuthStateChanged(auth, async (user) => {
                    if (user && user.uid !== state.currentUser?.uid) {
                        try {
                            state.currentUser = user; state.authReady = true; await syncUserProfile();
                            const dayOfWeek = new Date().getDay();
                            if (dayOfWeek === 4 || dayOfWeek === 5) state.currentTab = 'order'; // Auto-switch on Thu/Fri
                            updateUIForUser(user); await render(); await checkOrderNotification();
                            showToast(`Ch√†o m·ª´ng, ${getFirstName(state.staffProfile.name)}!`);
                        } catch (authError) {
                            showToast(authError.message, 'error'); await signOut(auth);
                        }
                    } else if (!user) {
                        state.currentUser = null; state.isAdmin = false; state.authReady = true; updateUIForUser(null);
                    }
                    hideLoader();
                });
            } catch (error) {
                console.error('App init error:', error); hideLoader();
                showToast('Kh√¥ng th·ªÉ kh·ªüi t·∫°o ·ª©ng d·ª•ng', 'error');
            }
        }

        main();
    </script>
</body>
</html>
